<script>
  let myChart, currentAssetId = null;

  window.onload = function() { loadDashboard(); initFilters(); };

  function navTo(viewId, linkEl, event) {
    if(event) event.preventDefault();
    if(linkEl) { document.querySelectorAll('.menu-link').forEach(el => el.classList.remove('active')); linkEl.classList.add('active'); }
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
    const target = document.getElementById('view-' + viewId);
    if(target) target.classList.remove('d-none');
    
    if(viewId==='dashboard') loadDashboard();
    if(viewId==='campus') loadCampusList();
    if(viewId==='edificios') loadEdificiosList();
    if(viewId==='activos') {
        const sel = document.getElementById('filterCampus');
        if(sel.options.length <= 1) initFilters();
    }
  }

  // --- LOGICA DE FICHA DETALLE ---
  function openAssetDetail(id) {
    currentAssetId = id; 
    document.getElementById('view-activos').classList.add('d-none');
    document.getElementById('view-asset-detail').classList.remove('d-none');
    toggleEditInfo(false); 
    
    document.getElementById('detail-name').innerText = "Cargando...";
    document.getElementById('detail-type').innerText = "...";
    document.getElementById('d-nombre-val').innerText = "...";
    document.getElementById('d-tipo-val').innerText = "...";
    document.getElementById('d-marca-val').innerText = "...";
    document.getElementById('d-fecha-val').innerText = "...";
    document.getElementById('docsTableBody').innerHTML = "";
    document.getElementById('maintTableBody').innerHTML = "";
    document.getElementById('contractsTableBody').innerHTML = "";
    
    google.script.run.withSuccessHandler(info => {
      document.getElementById('detail-name').innerText = info.nombre;
      document.getElementById('detail-type').innerText = info.tipo;
      document.getElementById('d-nombre-val').innerText = info.nombre;
      document.getElementById('d-tipo-val').innerText = info.tipo;
      document.getElementById('d-marca-val').innerText = info.marca;
      document.getElementById('d-fecha-val').innerText = info.fechaAlta;
      
      document.getElementById('edit-nombre').value = info.nombre;
      document.getElementById('edit-marca').value = info.marca;
      
      loadDocs();
      loadMaint();
      loadContracts();
    }).getAssetInfo(id);
  }

  function closeAssetDetail() {
    currentAssetId = null;
    document.getElementById('view-asset-detail').classList.add('d-none');
    document.getElementById('view-activos').classList.remove('d-none');
  }

  function toggleEditInfo(editable) {
    if(editable) {
        document.getElementById('info-view-mode').classList.add('d-none');
        document.getElementById('info-edit-mode').classList.remove('d-none');
        document.getElementById('btn-edit-info').classList.add('d-none');
        document.getElementById('btn-save-info').classList.remove('d-none');
        const sel = document.getElementById('edit-tipo');
        if(sel.options.length <= 1) { 
            google.script.run.withSuccessHandler(list => {
                let html = '';
                const actual = document.getElementById('d-tipo-val').innerText;
                list.forEach(t => {
                    const selected = t.nombre === actual ? 'selected' : '';
                    html += `<option value="${t.nombre}" ${selected}>${t.nombre}</option>`;
                });
                sel.innerHTML = html;
            }).getCatalogoInstalaciones();
        }
    } else {
        document.getElementById('info-view-mode').classList.remove('d-none');
        document.getElementById('info-edit-mode').classList.add('d-none');
        document.getElementById('btn-edit-info').classList.remove('d-none');
        document.getElementById('btn-save-info').classList.add('d-none');
    }
  }

  function saveAssetInfo() {
    const newData = { id: currentAssetId, nombre: document.getElementById('edit-nombre').value, marca: document.getElementById('edit-marca').value, tipo: document.getElementById('edit-tipo').value };
    const btnSave = document.querySelector('#btn-save-info button'); const prevText = btnSave.innerText;
    btnSave.disabled = true; btnSave.innerText = "Guardando...";
    google.script.run.withSuccessHandler(res => {
        btnSave.disabled = false; btnSave.innerText = prevText;
        if(res.success) { openAssetDetail(currentAssetId); } else { alert("Error al guardar: " + res.error); }
    }).updateAsset(newData);
  }

  function loadDocs() {
    if(!currentAssetId) return;
    const tbody = document.getElementById('docsTableBody'); tbody.innerHTML = '<tr><td colspan="4" class="text-center">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(docs => {
      let html = docs.length ? '' : '<tr><td colspan="4" class="text-center text-muted">Sin documentos</td></tr>';
      docs.forEach(d => {
        html += `<tr><td class="ps-3 align-middle"><i class="bi bi-file-earmark-pdf text-danger me-2"></i>${d.nombre}</td><td class="align-middle"><span class="badge bg-secondary">v${d.version}</span></td><td class="align-middle small text-muted">${d.fecha}</td><td class="text-end pe-3"><div class="btn-group"><a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver"><i class="bi bi-eye"></i></a><button class="btn btn-sm btn-outline-danger" onclick="deleteDoc('${d.id}')" title="Eliminar"><i class="bi bi-trash"></i></button></div></td></tr>`;
      });
      tbody.innerHTML = html;
    }).obtenerDocs(currentAssetId);
  }

  function deleteDoc(idDoc) {
    if(!confirm("⚠️ ¿Estás seguro de que quieres eliminar este documento permanentemente?")) return;
    document.body.style.cursor = 'wait';
    google.script.run.withSuccessHandler(res => {
        document.body.style.cursor = 'default';
        if(res.success) { loadDocs(); } else { alert("Error al eliminar: " + res.error); }
    }).eliminarDocumento(idDoc);
  }

  function uploadFile() {
    const file = document.getElementById('fileInput').files[0];
    if(!file || !currentAssetId) return alert("Selecciona archivo");
    const btn=document.querySelector('#tab-docs button'), st=document.getElementById('uploadStatus');
    btn.disabled=true; st.innerText='Subiendo...';
    const r = new FileReader(); r.onload=function(e){ google.script.run.withSuccessHandler(res=>{ btn.disabled=false; st.innerText='Subido'; document.getElementById('fileInput').value=''; loadDocs(); }).subirArchivo(e.target.result.split(',')[1], file.name, file.type, currentAssetId, 'ACTIVO'); }; r.readAsDataURL(file);
  }

  function loadMaint() {
    if(!currentAssetId) return;
    const tbody = document.getElementById('maintTableBody'); tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(planes => {
      let html = planes.length ? '' : '<tr><td colspan="4" class="text-center text-muted">Sin revisiones</td></tr>';
      planes.forEach(p => {
        const diff = Math.ceil((new Date(p.fechaProxima) - new Date())/86400000);
        let c = (diff < 0) ? 'bg-rojo' : (diff <= 30) ? 'bg-amarillo' : 'bg-verde';
        html += `<tr><td class="text-center"><span class="dot ${c}"></span></td><td>${p.tipo}</td><td>${p.fechaProxima}</td><td><button class="btn btn-sm btn-light">Editar</button></td></tr>`;
      });
      tbody.innerHTML = html;
    }).obtenerPlanMantenimiento(currentAssetId);
  }

  function loadContracts() {
    if(!currentAssetId) return;
    const tbody = document.getElementById('contractsTableBody'); tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(list => {
      let html = list.length ? '' : '<tr><td colspan="4" class="text-center text-muted">Sin contratos</td></tr>';
      list.forEach(c => html += `<tr><td><span class="badge badge-${c.color}">${c.estado}</span></td><td>${c.proveedor}</td><td>${c.ref}</td><td><small>${c.fin}</small></td></tr>`);
      tbody.innerHTML = html;
    }).obtenerContratos(currentAssetId);
  }

  const maintModal = new bootstrap.Modal(document.getElementById('maintModal'));
  function mostrarModalRevision() { document.getElementById('revTipo').value=''; document.getElementById('revFecha').value=''; maintModal.show(); }
  function submitRevision() { google.script.run.withSuccessHandler(()=>{maintModal.hide(); loadMaint();}).crearRevision({idActivo:currentAssetId, tipo:document.getElementById('revTipo').value, fechaProx:document.getElementById('revFecha').value}); }

  const contractModal = new bootstrap.Modal(document.getElementById('contractModal'));
  function mostrarModalContrato() { ['contProv','contRef','contIni','contFin'].forEach(id=>document.getElementById(id).value=''); contractModal.show(); }
  function submitContract() { google.script.run.withSuccessHandler(()=>{contractModal.hide(); loadContracts();}).crearContrato({idEntidad:currentAssetId, tipoEntidad:'ACTIVO', proveedor:document.getElementById('contProv').value, ref:document.getElementById('contRef').value, fechaIni:document.getElementById('contIni').value, fechaFin:document.getElementById('contFin').value}); }

  function loadCampusList() {
    google.script.run.withSuccessHandler(data => {
      let html = ''; data.forEach(r => html += `<tr><td class="ps-4 fw-bold text-primary">${r.nombre}</td><td>${r.provincia}</td><td><small>${r.direccion}</small></td><td class="text-end pe-4"><button class="btn btn-sm btn-light border"><i class="bi bi-pencil"></i></button></td></tr>`);
      document.getElementById('tableCampusBody').innerHTML = html || '<tr><td colspan="4" class="text-center text-muted">Vacío</td></tr>';
    }).getTableData('CAMPUS');
  }
  function loadEdificiosList() {
    google.script.run.withSuccessHandler(data => {
      let html = ''; data.forEach(r => html += `<tr><td class="ps-4 fw-bold">${r.nombre}</td><td><span class="badge bg-light text-dark border">${r.campus}</span></td><td>${r.contacto}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border"><i class="bi bi-pencil"></i></button></td></tr>`);
      document.getElementById('tableEdificiosBody').innerHTML = html || '<tr><td colspan="4" class="text-center text-muted">Vacío</td></tr>';
    }).getTableData('EDIFICIOS');
  }
  function initFilters() { google.script.run.withSuccessHandler(l=>{let h='<option value="">- Seleccione -</option>';l.forEach(i=>h+=`<option value="${i.id}">${i.nombre}</option>`);document.getElementById('filterCampus').innerHTML=h;}).getListaCampus(); }
  
  function loadEdificios(id) {
    const sel=document.getElementById('filterEdificio'); sel.disabled=true; sel.innerHTML='<option>Cargando...</option>';
    if(!id) return;
    google.script.run.withSuccessHandler(l=>{let h='<option value="">- Seleccione -</option>';l.forEach(i=>h+=`<option value="${i.id}">${i.nombre}</option>`);sel.innerHTML=h; sel.disabled=false;}).getEdificiosPorCampus(id);
  }
  
  function loadActivos(id) {
    const search = document.getElementById('filterSearch');
    search.disabled=false; search.value=''; // Limpiar búsqueda
    const tbody=document.getElementById('tableActivos'); tbody.innerHTML='<tr><td colspan="4" class="text-center py-5">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(l=>{
      if(!l.length){tbody.innerHTML='<tr><td colspan="4" class="text-center py-5">Vacío</td></tr>';return;}
      let h=''; l.forEach(i=>h+=`<tr><td class="fw-bold"><i class="bi bi-box-seam text-primary me-2"></i>${i.nombre}</td><td><span class="badge bg-light text-dark border">${i.tipo}</span></td><td>${i.marca}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-primary" onclick="openAssetDetail('${i.id}')">Ver Ficha</button></td></tr>`);
      tbody.innerHTML=h;
    }).getActivosPorEdificio(id);
  }

  function filterAssets() {
    const input = document.getElementById('filterSearch');
    const filter = input.value.toLowerCase();
    const tbody = document.getElementById('tableActivos');
    const rows = tbody.getElementsByTagName('tr');
    for (let i = 0; i < rows.length; i++) {
      const text = rows[i].textContent || rows[i].innerText;
      if (text.toLowerCase().indexOf(filter) > -1) { rows[i].style.display = ""; } else { rows[i].style.display = "none"; }
    }
  }

  function loadDashboard() {
    google.script.run.withSuccessHandler(d => {
      document.getElementById('d-activos').innerText=d.activos; document.getElementById('d-vencidas').innerText=d.vencidas; document.getElementById('d-pendientes').innerText=d.pendientes; document.getElementById('d-edificios').innerText=d.edificios;
      const ctx = document.getElementById('mainChart').getContext('2d'); if(myChart) myChart.destroy();
      myChart = new Chart(ctx, {type:'line', data:{labels:['Ene','Feb','Mar','Abr'], datasets:[{label:'Actividad', data:[5,10,8,12], borderColor:'#0d6efd', tension:0.4}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}});
    }).getDatosDashboard();
  }

  const myModal = new bootstrap.Modal(document.getElementById('createModal'));
  function mostrarModalCrear(t) {
    document.getElementById('createForm').reset(); document.getElementById('modalType').value=t; document.getElementById('modalTitle').innerText='Crear '+t;
    const ex=document.getElementById('extraFields'); ex.innerHTML='';
    if(t==='CAMPUS') ex.innerHTML=`<div class="mb-2"><label>Provincia</label><input id="fProv" class="form-control"></div><div class="mb-2"><label>Dirección</label><input id="fDir" class="form-control"></div>`;
    else if(t==='EDIFICIO') { ex.innerHTML=`<div class="mb-2"><label>Campus</label><select id="fCampus" class="form-select"><option>Cargando...</option></select></div><div class="mb-2"><label>Contacto</label><input id="fCont" class="form-control"></div>`; google.script.run.withSuccessHandler(l=>{let h='';l.forEach(i=>{h+=`<option value="${i.id}">${i.nombre}</option>`});document.getElementById('fCampus').innerHTML=h;}).getListaCampus(); }
    else if(t==='ACTIVO') ex.innerHTML=`<div class="alert alert-info small">Usa el botón en la vista Activos</div>`;
    myModal.show();
  }
  function submitCreate() {
    const t=document.getElementById('modalType').value, n=document.getElementById('fNombre').value, btn=document.querySelector('#createModal .btn-primary');
    btn.disabled=true; const cb=(r)=>{btn.disabled=false;if(r.success){myModal.hide(); navTo(t.toLowerCase()=='activo'?'activos':t.toLowerCase()=='edificio'?'edificios':'campus',null,null);}else alert("Error");};
    if(t==='CAMPUS') google.script.run.withSuccessHandler(cb).crearCampus({nombre:n, provincia:document.getElementById('fProv').value, direccion:document.getElementById('fDir').value});
    else if(t==='EDIFICIO') google.script.run.withSuccessHandler(cb).crearEdificio({nombre:n, idCampus:document.getElementById('fCampus').value, contacto:document.getElementById('fCont').value});
  }
</script>
