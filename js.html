<script>
  let currentContext = null, treeData = [], myChart = null;

  window.onload = function() { 
    loadTree(); 
    loadDashboard(); 
  };

  function loadTree() {
    google.script.run.withSuccessHandler(data => { treeData = data; renderTree(data); }).getArbolDatos();
  }

  function loadDashboard() {
    document.getElementById('view-dashboard').classList.remove('d-none');
    document.getElementById('view-details').classList.add('d-none');
    document.querySelectorAll('.tree-item').forEach(d => d.classList.remove('active-node'));

    google.script.run.withSuccessHandler(data => {
      document.getElementById('dashActivos').innerText = data.activos;
      document.getElementById('dashVencidas').innerText = data.vencidas;
      document.getElementById('dashPendientes').innerText = data.pendientes;
      document.getElementById('dashContratos').innerText = data.contratosCaducados;

      const ctx = document.getElementById('maintChart').getContext('2d');
      if(myChart) myChart.destroy(); 
      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['En Fecha', 'Próximas', 'Vencidas'],
          datasets: [{
            data: [data.ok, data.pendientes, data.vencidas],
            backgroundColor: ['#198754', '#ffc107', '#dc3545']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }).getDatosDashboard();
  }

  function renderTree(data) {
    const container = document.getElementById('treeContainer');
    document.getElementById('loadingTree').classList.add('d-none');
    let html = '';
    data.forEach(c => {
      html += createNodeHtml(c, 'CAMPUS');
      if(c.hijos?.length) {
         html += `<div id="grp-${c.id}" class="child-group">`;
         c.hijos.forEach(e => {
            html += createNodeHtml(e, 'EDIFICIO');
            if(e.hijos?.length) {
               html += `<div id="grp-${e.id}" class="child-group">`;
               e.hijos.forEach(a => { html += createNodeHtml(a, 'ACTIVO'); });
               html += `</div>`;
            }
         });
         html += `</div>`;
      }
    });
    container.innerHTML = html;
  }
  function createNodeHtml(item, type) {
    let icon = (type === 'EDIFICIO') ? 'bi-house-door' : (type === 'ACTIVO') ? 'bi-gear' : 'bi-building';
    return `<div class="tree-item" onclick="selectNode('${item.id}', '${type}', '${item.nombre}', this)"><i class="bi ${icon} me-1"></i> ${item.nombre}${(type !== 'ACTIVO') ? `<i class="bi bi-caret-down-fill float-end small text-muted" onclick="toggleGroup('${item.id}', event)"></i>` : ''}</div>`;
  }
  function toggleGroup(id, e) { e.stopPropagation(); const el = document.getElementById('grp-' + id); if(el) el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
  
  function selectNode(id, type, name, el) {
    document.getElementById('view-dashboard').classList.add('d-none');
    document.getElementById('view-details').classList.remove('d-none');
    document.querySelectorAll('.tree-item').forEach(d => d.classList.remove('active-node'));
    el.classList.add('active-node');
    currentContext = { id, type, name };
    document.getElementById('ctxTitle').innerText = `${type}: ${name}`;
    document.getElementById('mainTabs').classList.remove('d-none');
    document.getElementById('tabContent').classList.remove('d-none');
    
    let actions = '';
    if(type === 'CAMPUS') actions = `<button class="btn btn-sm btn-outline-primary" onclick="mostrarModalCrear('EDIFICIO')">+ Edificio</button>`;
    if(type === 'EDIFICIO') actions = `<button class="btn btn-sm btn-outline-primary" onclick="mostrarModalCrear('ACTIVO')">+ Activo</button>`;
    document.getElementById('ctxActions').innerHTML = actions;

    switchTab('info', document.querySelector('.nav-link.active'));
    const tabs = document.querySelectorAll('.nav-link');
    tabs[2].style.display = (type === 'ACTIVO') ? 'block' : 'none';
    tabs[3].style.display = (type === 'ACTIVO' || type === 'EDIFICIO') ? 'block' : 'none';
  }

  function switchTab(tabId, navEl) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    if(navEl) navEl.classList.add('active');
    ['info', 'docs', 'maint', 'contracts'].forEach(t => document.getElementById(`view-${t}`).classList.add('d-none'));
    document.getElementById(`view-${tabId}`).classList.remove('d-none');
    if(tabId === 'docs') loadDocs();
    if(tabId === 'maint' && currentContext.type === 'ACTIVO') loadMaint();
    if(tabId === 'contracts') loadContracts();
  }

  // --- MODALES ---
  const maintModal = new bootstrap.Modal(document.getElementById('maintModal'));
  function mostrarModalRevision() { document.getElementById('revTipo').value=''; document.getElementById('revFecha').value=''; maintModal.show(); }
  function submitRevision() { google.script.run.withSuccessHandler(res => { maintModal.hide(); loadMaint(); }).crearRevision({idActivo: currentContext.id, tipo: document.getElementById('revTipo').value, fechaProx: document.getElementById('revFecha').value}); }
  function loadMaint() {
    const tbody = document.getElementById('maintTableBody'); tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(planes => {
      if(!planes.length) { tbody.innerHTML = '<tr><td colspan="4">Sin revisiones</td></tr>'; return; }
      let html = '';
      planes.forEach(p => {
        const diff = Math.ceil((new Date(p.fechaProxima) - new Date()) / 86400000);
        let c = (diff < 0) ? 'bg-rojo' : (diff <= 30) ? 'bg-amarillo' : 'bg-verde';
        html += `<tr><td class="text-center"><span class="dot ${c}"></span></td><td>${p.tipo}</td><td>${p.fechaProxima}</td><td><button class="btn btn-sm btn-light">Editar</button></td></tr>`;
      });
      tbody.innerHTML = html;
    }).obtenerPlanMantenimiento(currentContext.id);
  }

  const contractModal = new bootstrap.Modal(document.getElementById('contractModal'));
  function mostrarModalContrato() { ['contProv', 'contRef', 'contIni', 'contFin'].forEach(id => document.getElementById(id).value = ''); contractModal.show(); }
  function submitContract() { google.script.run.withSuccessHandler(res => { contractModal.hide(); loadContracts(); }).crearContrato({idEntidad: currentContext.id, tipoEntidad: currentContext.type, proveedor: document.getElementById('contProv').value, ref: document.getElementById('contRef').value, fechaIni: document.getElementById('contIni').value, fechaFin: document.getElementById('contFin').value}); }
  function loadContracts() {
    const tbody = document.getElementById('contractsTableBody'); tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(list => {
      if(!list.length) { tbody.innerHTML = '<tr><td colspan="4">Sin contratos</td></tr>'; return; }
      let html = ''; list.forEach(c => { html += `<tr><td><span class="badge badge-${c.color}">${c.estado}</span></td><td>${c.proveedor}</td><td>${c.ref}</td><td><small>${c.inicio} - ${c.fin}</small></td></tr>`; });
      tbody.innerHTML = html;
    }).obtenerContratos(currentContext.id);
  }

  function uploadFile() {
    const file = document.getElementById('fileInput').files[0];
    if(!file || file.size > 8388608) return alert("Error archivo");
    const btn=document.querySelector('#view-docs button'), st=document.getElementById('uploadStatus');
    btn.disabled=true; st.innerText='Subiendo...';
    const r = new FileReader(); r.onload=function(e){ google.script.run.withSuccessHandler(res=>{ btn.disabled=false; st.innerText='OK'; loadDocs(); }).subirArchivo(e.target.result.split(',')[1], file.name, file.type, currentContext.id, currentContext.type); }; r.readAsDataURL(file);
  }
  function loadDocs() {
    const tbody = document.getElementById('docsTableBody'); tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(docs => {
      if(!docs.length) { tbody.innerHTML = '<tr><td colspan="4">Sin documentos</td></tr>'; return; }
      let html = ''; docs.forEach(d => { html += `<tr><td>${d.nombre}</td><td>v${d.version}</td><td>${d.fecha}</td><td><a href="${d.url}" target="_blank">Ver</a></td></tr>`; });
      tbody.innerHTML = html;
    }).obtenerDocs(currentContext.id);
  }

  const myModal = new bootstrap.Modal(document.getElementById('createModal'));
  function mostrarModalCrear(type) {
    document.getElementById('createForm').reset(); document.getElementById('modalType').value = type; document.getElementById('modalTitle').innerText = 'Crear ' + type;
    if(currentContext) document.getElementById('modalParentId').value = currentContext.id;
    const ex = document.getElementById('extraFields'); ex.innerHTML = '';
    if(type === 'CAMPUS') ex.innerHTML = `<div class="mb-2"><label>Provincia</label><input id="fProv" class="form-control"></div><div class="mb-2"><label>Dirección</label><input id="fDir" class="form-control"></div>`;
    else if(type === 'EDIFICIO') ex.innerHTML = `<div class="mb-2"><label>Contacto</label><input id="fCont" class="form-control"></div>`;
    else if(type === 'ACTIVO') {
       ex.innerHTML = `<div class="mb-2"><label>Tipo</label><select id="fTipo" class="form-select" disabled><option>Cargando...</option></select></div><div class="mb-2"><label>Marca</label><input id="fMarca" class="form-control"></div>`;
       google.script.run.withSuccessHandler(ts => { let o='<option value="">Sel...</option>'; ts.forEach(t=>{o+=`<option value="${t.id}">${t.nombre}</option>`}); document.getElementById('fTipo').innerHTML=o; document.getElementById('fTipo').disabled=false; }).getCatalogoInstalaciones();
    }
    myModal.show();
  }
  
  function submitCreate() {
    const t=document.getElementById('modalType').value, p=document.getElementById('modalParentId').value, n=document.getElementById('fNombre').value;
    const btn = document.querySelector('#createModal .btn-primary');
    btn.disabled = true; btn.innerText = "Guardando...";
    const handler = (res) => { btn.disabled = false; btn.innerText = "Guardar"; if(res.success) { myModal.hide(); loadTree(); } else { alert("Error: " + res.error); } };

    if(t==='CAMPUS') google.script.run.withSuccessHandler(handler).crearCampus({nombre:n, provincia:document.getElementById('fProv').value, direccion:document.getElementById('fDir').value});
    else if(t==='EDIFICIO') google.script.run.withSuccessHandler(handler).crearEdificio({nombre:n, idCampus:p, contacto:document.getElementById('fCont').value});
    else google.script.run.withSuccessHandler(handler).crearActivo({nombre:n, idEdificio:p, tipo:document.getElementById('fTipo').value, marca:document.getElementById('fMarca').value});
  }

  const normModal = new bootstrap.Modal(document.getElementById('normativaModal'));
  function mostrarModalNormativa() { normModal.show(); google.script.run.withSuccessHandler(l=>{let h='';l.forEach(i=>{h+=`<tr><td>${i.nombre}</td><td>${i.norma}</td><td>${i.dias}</td></tr>`});document.getElementById('tablaNormativaBody').innerHTML=h;}).getCatalogoInstalaciones(); }
</script>
