<script>
  // ==========================================
  // 1. VARIABLES GLOBALES
  // ==========================================
  let myChart, myPieChart, calendar, currentAssetId = null;
  let campusLoaded = false;
  let globalMaintData = [];
  let globalContractData = [];
  let globalIncidencias = [];
  let allEdificiosData = [];
  let currentActiveAssetId = null;
  let currentBuildingId = null;
  let lastView = 'activos';
  let currentUser = { rol: 'CONSULTA', nombre: 'Cargando...' };
  let mapInstance = null;
  let markersLayer = null;
  let changelogModal = null;
  let newVersionModal = null;
  let plannerCalendar = null;
  let allPlannerEvents = []; 
  window.currentBuildingAssetsList = [];
  window.allAssetsData = [];
  let currentRenderTimeout = null;

  // Instancias de Modales
  let maintModal = null; let contractModal = null; let myModal = null; let obraModal = null;
  let configModal = null; let userModal = null; let reportModal = null; let feedbackModal = null;
  let edificioModal = null; let campusModal = null; let importModal = null; let relacionModal = null;

  // ==========================================
  // 2. HELPERS VISUALES (SWEETALERT2)
  // ==========================================
  const Toast = Swal.mixin({
    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
    didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
  });

  function notificarExito(mensaje) { Toast.fire({ icon: 'success', title: mensaje || '¬°Operaci√≥n exitosa!' }); }
  function notificarError(mensaje) { Swal.fire({ icon: 'error', title: 'Ups...', text: mensaje || 'Ha ocurrido un error inesperado.', confirmButtonColor: '#CC0605' }); }
  function notificar(mensaje, icono = 'info') { Toast.fire({ icon: icono, title: mensaje }); }
  
  function confirmarAccion(titulo, texto, callback) {
    Swal.fire({
      title: titulo || '¬øEst√°s seguro?', text: texto || "Esta acci√≥n no se puede deshacer.", icon: 'warning',
      showCancelButton: true, confirmButtonColor: '#CC0605', cancelButtonColor: '#6c757d',
      confirmButtonText: 'S√≠, proceder', cancelButtonText: 'Cancelar'
    }).then((result) => { if (result.isConfirmed) callback(); });
  }

  function setBtnLoading(btnId, loading) {
    const btn = document.getElementById(btnId); if (!btn) return;
    if (loading) { btn.dataset.og = btn.innerText; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; }
    else { btn.disabled = false; btn.innerText = btn.dataset.og || 'Guardar'; }
  }

  function mostrarCargando(mensaje = 'Guardando cambios...') {
    Swal.fire({ title: mensaje, html: 'Por favor, no cierres la ventana.', allowOutsideClick: false, allowEscapeKey: false, showConfirmButton: false, didOpen: () => { Swal.showLoading(); } });
  }

  function ocultarLoader() {
    const loader = document.getElementById('app-loader');
    if (loader) {
      loader.style.opacity = '0';
      setTimeout(() => { loader.style.display = 'none'; }, 500);
    }
  }

  // ==========================================
  // 3. INICIALIZACI√ìN OPTIMIZADA (V2)
  // ==========================================
  window.onload = function() {
    console.time("CargaInicial");

    // 1. Inicializar UI (Modales y Listeners)
    initModalsAndListeners();

    // 2. LLAMADA √öNICA AL BACKEND
    google.script.run
      .withSuccessHandler(initData => {
        console.timeEnd("CargaInicial");

        // A. Usuario
        currentUser = initData.usuario;
        applySecurityUI();

        // B. Dashboard (Gr√°ficos y Calendario)
        renderDashboardData(initData.dashboard);

        // C. Selectores Globales
        populateSelectsIniciales(initData.listaCampus, initData.catalogo);

        // D. Admin: Cargar buz√≥n
        if (currentUser.rol === 'ADMIN') {
          google.script.run.withSuccessHandler(list => {
            const nuevos = list.filter(i => i.estado === 'NUEVO').length;
            updateBadgeFeedback(nuevos);
          }).getFeedbackList();
        }

        ocultarLoader();
      })
      .withFailureHandler(err => {
        console.error(err);
        notificarError("Error cr√≠tico al iniciar: " + err.message);
        ocultarLoader();
      })
      .getAppInitData();
  };

  // --- FUNCIONES AUXILIARES DE INICIALIZACI√ìN ---
  function initModalsAndListeners() {
    // Instanciar Modales
    if (document.getElementById('maintModal')) maintModal = new bootstrap.Modal(document.getElementById('maintModal'));
    if (document.getElementById('contractModal')) contractModal = new bootstrap.Modal(document.getElementById('contractModal'));
    if (document.getElementById('createModal')) myModal = new bootstrap.Modal(document.getElementById('createModal'));
    if (document.getElementById('obraModal')) obraModal = new bootstrap.Modal(document.getElementById('obraModal'));
    if (document.getElementById('configModal')) configModal = new bootstrap.Modal(document.getElementById('configModal'));
    if (document.getElementById('userModal')) userModal = new bootstrap.Modal(document.getElementById('userModal'));
    if (document.getElementById('reportModal')) reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    if (document.getElementById('feedbackModal')) feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    if (document.getElementById('edificioModal')) edificioModal = new bootstrap.Modal(document.getElementById('edificioModal'));
    if (document.getElementById('campusModal')) campusModal = new bootstrap.Modal(document.getElementById('campusModal'));
    if (document.getElementById('importModal')) importModal = new bootstrap.Modal(document.getElementById('importModal'));
    if (document.getElementById('changelogModal')) changelogModal = new bootstrap.Modal(document.getElementById('changelogModal'));
    if (document.getElementById('newVersionModal')) newVersionModal = new bootstrap.Modal(document.getElementById('newVersionModal'));
    
    // Listeners
    const revTipo = document.getElementById('revTipo');
    if (revTipo) revTipo.addEventListener('change', updateMaintFormVisibility);

    const revNorma = document.getElementById('revNorma');
    if (revNorma) {
      revNorma.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option && option.dataset.dias) {
          document.getElementById('revFreq').value = option.dataset.dias;
          document.getElementById('revRecur').checked = true;
          document.getElementById('secRecurOptions').classList.remove('d-none');
          const hoy = new Date();
          const cincoAnos = new Date(hoy);
          cincoAnos.setFullYear(cincoAnos.getFullYear() + 5);
        }
      });
    }

    const revRecur = document.getElementById('revRecur');
    if (revRecur) {
      revRecur.addEventListener('change', function() {
        const opciones = document.getElementById('secRecurOptions');
        if (this.checked) {
          opciones.classList.remove('d-none');
        } else { opciones.classList.add('d-none'); }
      });
    }
  }

  function renderDashboardData(d) {
    // Contadores
    document.getElementById('d-activos').innerText = d.activos;
    document.getElementById('d-vencidas').innerText = d.vencidas;
    document.getElementById('d-pendientes').innerText = d.pendientes;
    document.getElementById('d-incidencias').innerText = d.incidencias;
    document.getElementById('d-contratos').innerText = d.contratos;
    document.getElementById('d-edificios').innerText = d.edificios;
    document.getElementById('d-campus').innerText = d.campus;

    // Gr√°ficos
    updateMainChart(d.chartLabels, d.chartData);
    updatePieChart(d.pendientes, d.vencidas, d.ok);

    // Calendario
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = '';
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth', locale: 'es', height: 550,
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
      events: d.calendarEvents,
      selectable: true,
      dateClick: function(info) { mostrarModalRevision(info.dateStr); },
      eventClick: function(info) {
        const p = info.event.extendedProps;
        editRevision(p.id, p.tipo, p.fechaISO, p.idActivo, p.hasCalendar);
      }
    });
    calendar.render();
  }

  function populateSelectsIniciales(listaCampus, listaCatalogo) {
    let htmlC = '<option value="">- Todos los Campus -</option>';
    let htmlC_Sel = '<option value="">- Seleccione -</option>';
    listaCampus.forEach(c => {
       htmlC += `<option value="${c.id}">${c.nombre}</option>`;
       htmlC_Sel += `<option value="${c.id}">${c.nombre}</option>`;
    });

    const selDash = document.getElementById('dashboardCampusFilter'); if(selDash) selDash.innerHTML = htmlC;
    const selFilterCampus = document.getElementById('filterCampus'); if(selFilterCampus) selFilterCampus.innerHTML = htmlC_Sel;
    
    // Filtro edificios por nombre
    const selFilterEdif = document.getElementById('filterCampusEdificios');
    if (selFilterEdif) {
        let htmlN = '<option value="">- Todos los Campus -</option>';
        listaCampus.forEach(c => htmlN += `<option value="${c.nombre}">${c.nombre}</option>`);
        selFilterEdif.innerHTML = htmlN;
    }

    const selMaint = document.getElementById('maintFilterCampus'); if(selMaint) selMaint.innerHTML = htmlC;
    const selCont = document.getElementById('contractFilterCampus'); if(selCont) selCont.innerHTML = htmlC;

    const selNorma = document.getElementById('revNorma');
    if (selNorma) {
      let htmlN = '<option value="">Seleccione norma...</option>';
      listaCatalogo.forEach(n => htmlN += `<option value="${n.id}" data-dias="${n.dias}">${n.nombre}</option>`);
      selNorma.innerHTML = htmlN;
    }
    campusLoaded = true;
  }

  // Helper Charts
  function updateMainChart(labels, data) {
       const ctx = document.getElementById('mainChart').getContext('2d');
       if (myChart) myChart.destroy();
       myChart = new Chart(ctx, {
         type: 'line',
         data: { labels: labels, datasets: [{ label: 'Revisiones', data: data, borderColor: '#CC0605', backgroundColor: 'rgba(204, 6, 5, 0.1)', tension: 0.3, fill: true }] },
         options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
       });
  }
  function updatePieChart(pend, venc, ok) {
       const ctxPie = document.getElementById('pieChart').getContext('2d');
       if (myPieChart) myPieChart.destroy();
       myPieChart = new Chart(ctxPie, {
         type: 'doughnut',
         data: { labels: ['Pendientes', 'Vencidas', 'Al D√≠a'], datasets: [{ data: [pend, venc, ok], backgroundColor: ['#f59e0b', '#ef4444', '#10b981'] }] },
         options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
       });
  }

  // ==========================================
  // 4. SEGURIDAD Y NAVEGACI√ìN
  // ==========================================
  function applySecurityUI() {
    const profileDiv = document.querySelector('.user-profile');
    if (profileDiv) { profileDiv.innerHTML = `<i class="bi bi-person-circle me-2 fs-5"></i><div><div class="fw-bold">${currentUser.nombre}</div><small class="text-muted text-truncate" style="max-width:140px; display:block;">${currentUser.rol}</small></div>`; }
    if (currentUser.rol === 'CONSULTA') {
      document.querySelectorAll('.btn-primary, .btn-success, .btn-outline-danger').forEach(el => {
        const onClickAttr = el.getAttribute('onclick') || "";
        if (!onClickAttr.includes('openReportModal') && !onClickAttr.includes('openFeedbackModal')) { el.classList.add('d-none'); }
      });
      document.querySelectorAll('input[type="file"]').forEach(el => el.parentElement.classList.add('d-none'));
      const repFoto = document.getElementById('repFoto'); if (repFoto) repFoto.parentElement.classList.remove('d-none');
      document.querySelectorAll('.form-check-input').forEach(el => el.disabled = true);
    }
    if (currentUser.rol === 'TECNICO') {
      const links = document.querySelectorAll('.menu-link');
      links.forEach(l => { const onClickAttr = l.getAttribute('onclick') || ""; if (onClickAttr.includes('usuarios') || onClickAttr.includes('config')) { l.parentElement.classList.add('d-none'); } });
      const btnUser = document.querySelector('button[onclick="openUserModal()"]'); if (btnUser) btnUser.classList.add('d-none');
      const btnConf = document.querySelector('button[onclick="openConfigModal()"]'); if (btnConf) btnConf.classList.add('d-none');
    }
    if (currentUser.rol !== 'ADMIN') {
      const btnLogs = document.getElementById('menu-logs'); if (btnLogs) btnLogs.classList.add('d-none');
      const btnFeed = document.getElementById('menu-feedback'); if (btnFeed) btnFeed.classList.add('d-none');
    }
  }

  function refreshSecurityIcons() {
    if (currentUser.rol === 'CONSULTA') {
      document.querySelectorAll('table .btn-sm').forEach(btn => {
        if (btn.innerHTML.includes('bi-trash') || btn.innerHTML.includes('bi-pencil') || btn.innerText.includes('Finalizar') || btn.innerHTML.includes('bi-check-lg') || btn.innerHTML.includes('bi-play-fill')) { btn.classList.add('d-none'); }
      });
    }
    if (currentUser.rol === 'TECNICO') {
      document.querySelectorAll('button').forEach(btn => { if (btn.innerHTML.includes('bi-trash') || btn.getAttribute('title') === 'Eliminar' || btn.getAttribute('title') === 'Borrar') { btn.classList.add('d-none'); } });
      const viewUser = document.getElementById('view-usuarios'); if (!viewUser.classList.contains('d-none')) { document.querySelectorAll('#tableUsersBody button').forEach(b => b.classList.add('d-none')); }
      const viewConf = document.getElementById('view-config'); if (!viewConf.classList.contains('d-none')) { document.querySelectorAll('#tableConfigBody button').forEach(b => b.classList.add('d-none')); }
    }
  }

  function navTo(viewId, linkEl, event) {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    if (sidebar && sidebar.classList.contains('active')) toggleSidebar();
    if (event) event.preventDefault();
    if (linkEl) {
      document.querySelectorAll('.menu-link').forEach(el => el.classList.remove('active'));
      linkEl.classList.add('active');
    }
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
    const target = document.getElementById('view-' + viewId);
    if (target) target.classList.remove('d-none');

    currentActiveAssetId = null;
    currentBuildingId = null;

    // L√ìGICA VISTA (Optimizada: Sin recargas innecesarias)
    if (viewId === 'dashboard') loadDashboard();
    if (viewId === 'campus') loadCampusList();
    if (viewId === 'edificios') loadEdificiosList();
    if (viewId === 'mantenimiento') loadGlobalMaint(); // Eliminada carga de filtros (ya hecha al inicio)
    if (viewId === 'contratos') loadGlobalContracts(); // Eliminada carga de filtros
    if (viewId === 'activos') {
      if (window.allAssetsData.length === 0) loadAllAssets();
    }
    if (viewId === 'config') loadConfigList();
    if (viewId === 'usuarios') loadUserList();
    if (viewId === 'incidencias') loadIncidencias();
    if (viewId === 'logs') loadLogsList();
    if (viewId === 'feedback') loadFeedbackList();
    if (viewId === 'planner') { setTimeout(function () { initPlannerCalendar(); }, 100); }
    if (viewId === 'audit') loadAuditYears();
  }

  function loadLogsList() {
    const tbody = document.getElementById('tableLogsBody');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-secondary"></div> Cargando auditor√≠a...</td></tr>';
    google.script.run.withSuccessHandler(logs => {
      if (!logs || logs.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-5">El registro est√° vac√≠o.</td></tr>'; return; }
      let html = '';
      logs.forEach(r => {
        let badgeClass = 'bg-light text-dark border';
        if (r.accion.includes('ELIMINAR')) badgeClass = 'bg-danger text-white';
        if (r.accion.includes('GUARDAR') || r.accion.includes('CREAR')) badgeClass = 'bg-success text-white';
        if (r.accion.includes('IMPORTACI√ìN')) badgeClass = 'bg-primary text-white';
        html += `<tr><td class="ps-4 small text-muted font-monospace">${r.fecha}</td><td class="fw-bold text-primary">${r.usuario}</td><td><span class="badge ${badgeClass}">${r.accion}</span></td><td class="small text-muted text-truncate" style="max-width: 400px;" title="${r.detalles}">${r.detalles}</td></tr>`;
      });
      tbody.innerHTML = html;
    }).getLogsAuditoria();
  }

  function loadDashboard() {
    const filter = document.getElementById('dashboardCampusFilter');
    const idCampus = filter ? filter.value : null;
    // Solo actualizamos datos, renderDashboardData se encarga del DOM
    google.script.run.withSuccessHandler(d => { renderDashboardData(d); }).getDatosDashboard(idCampus);
  }

  // ==========================================
  // FUNCIONES TABLAS (Lazy Render)
  // ==========================================
  function renderTableLazy(tbody, data, renderRow, pageSize = 50) {
    if (currentRenderTimeout) { clearTimeout(currentRenderTimeout); currentRenderTimeout = null; }
    if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">Sin datos</td></tr>'; return; }
    let currentPage = 0;
    const totalPages = Math.ceil(data.length / pageSize);
    function loadPage() {
      const start = currentPage * pageSize;
      const end = Math.min(start + pageSize, data.length);
      let html = '';
      for (let i = start; i < end; i++) { html += renderRow(data[i], i); }
      if (currentPage === 0) tbody.innerHTML = html; else tbody.insertAdjacentHTML('beforeend', html);
      currentPage++;
      if (currentPage < totalPages) { currentRenderTimeout = setTimeout(loadPage, 10); } 
      else { refreshSecurityIcons(); currentRenderTimeout = null; }
    }
    loadPage();
  }

  // ==========================================
  // MANTENIMIENTO
  // ==========================================
  function loadGlobalMaint() {
    const tbody = document.getElementById('tableGlobalMaint');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary"></div> Cargando plan...</td></tr>';
    google.script.run.withSuccessHandler(data => { globalMaintData = data; renderGlobalMaintTable(data); }).getGlobalMaintenance();
  }

  function renderGlobalMaintTable(data) {
    const tbody = document.getElementById('tableGlobalMaint');
    
    renderTableLazy(tbody, data, (r, index) => {
      // 1. L√≥gica de colores (Sem√°foro)
      let dotClass = 'bg-secondary';
      if (r.color === 'rojo') dotClass = 'bg-rojo';
      if (r.color === 'amarillo') dotClass = 'bg-amarillo';
      if (r.color === 'verde') dotClass = 'bg-verde';
      if (r.color === 'azul') dotClass = 'bg-info';

      // 2. Iconos informativos
      let clipIcon = r.hasDocs ? '<i class="bi bi-paperclip text-primary ms-1"></i>' : '';
      let calIcon = r.hasCalendar ? '<i class="bi bi-calendar-check text-success ms-1"></i>' : '';

      // 3. Texto de Fecha
      let fechaTexto = `<span class="dot ${dotClass}"></span> ${r.fecha} <small class="text-muted ms-1">(${r.dias} d√≠as)</small>`;
      
      // --- ZONA DE BOTONES (Corregida) ---
      
      // A. Bot√≥n Nube (Siempre visible)
      const btnCloud = `<button class="btn btn-sm btn-outline-secondary border me-1" onclick="openQuickUpload('${r.idActivo}')" title="Subida R√°pida"><i class="bi bi-cloud-arrow-up-fill"></i></button>`;
      
      // B. Bot√≥n Editar (L√°piz) o Ver (Ojo) si es hist√≥rico
      let btnEdit = `<button class="btn btn-sm btn-light border" onclick="editRevision('${r.id}', '${r.tipo}', '${r.fechaISO}', '${r.idActivo}', ${r.hasCalendar})" title="Editar"><i class="bi bi-pencil"></i></button>`;
      
      // C. Bot√≥n Completar (Check) - Solo si NO es hist√≥rico
      let btnCheck = `<button class="btn btn-sm btn-outline-success ms-1" onclick="marcarHecho('${r.id}')" data-id="${r.id}" title="Completar"><i class="bi bi-check-lg"></i></button>`;

      // Ajustes para Hist√≥rico (Azul)
      if (r.color === 'azul') { 
         fechaTexto = `<span class="dot ${dotClass}"></span> ${r.fecha} <small class="text-muted fst-italic ms-1">Hist√≥rico</small>`; 
         // En hist√≥rico cambiamos L√°piz por Ojo y quitamos el Check
         btnEdit = `<button class="btn btn-sm btn-light border" onclick="editRevision('${r.id}', '${r.tipo}', '${r.fechaISO}', '${r.idActivo}', ${r.hasCalendar})" title="Ver Detalle"><i class="bi bi-eye"></i></button>`;
         btnCheck = ''; 
      }

      // Concatenamos todo de forma segura
      const botones = btnCloud + btnEdit + btnCheck;

      return `<tr>
        <td class="text-center ps-4 small">${index + 1}</td>
        <td><div class="fw-bold">${r.edificio}</div><small class="text-muted">${r.campusNombre}</small></td>
        <td>${r.activo}</td>
        <td><span class="badge bg-light text-dark border">${r.tipo}</span>${clipIcon}${calIcon}</td>
        <td>${fechaTexto}</td>
        <td class="text-end pe-4">
            <div class="btn-group">${botones}</div>
        </td>
      </tr>`;
    });
  }

  function setMaintFilter(tipoFiltro, valor, btn) {
    if (btn) { const p = btn.parentElement; p.querySelectorAll('button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    const fCampus = document.getElementById('maintFilterCampus').value;
    const fEdificio = document.getElementById('maintFilterEdificio').value;
    let fColor = 'all', fType = 'all';
    const cBtn = document.querySelector('#filterGroupColor .active');
    if (cBtn) { if (cBtn.innerText === 'Todas') fColor = 'all'; else if (cBtn.classList.contains('btn-outline-danger')) fColor = 'rojo'; else if (cBtn.classList.contains('btn-outline-warning')) fColor = 'amarillo'; else if (cBtn.classList.contains('btn-outline-success')) fColor = 'verde'; else if (cBtn.classList.contains('btn-outline-info')) fColor = 'azul'; }
    const tBtn = document.querySelector('#filterGroupType .active');
    if (tBtn && tBtn.innerText !== 'Todos') { const txt = tBtn.getAttribute('onclick'); if (txt.includes('Legal')) fType = 'Legal'; else if (txt.includes('Peri√≥dica')) fType = 'Peri√≥dica'; else if (txt.includes('Reparaci√≥n')) fType = 'Reparaci√≥n'; else if (txt.includes('Extraordinaria')) fType = 'Extraordinaria'; }
    if (!globalMaintData) return;
    const filtered = globalMaintData.filter(i => {
      const matchC = (fCampus === "") || (String(i.campusId) === String(fCampus));
      const matchE = (fEdificio === "") || (String(i.edificioId) === String(fEdificio));
      const matchT = (fType === 'all') || (i.tipo === fType);
      let matchCol = false; if (fColor === 'all') matchCol = (i.color !== 'azul'); else matchCol = (i.color === fColor);
      return matchC && matchE && matchT && matchCol;
    });
    renderGlobalMaintTable(filtered);
  }

  function loadEdificiosMaintFilter(idCampus) {
    const sel = document.getElementById('maintFilterEdificio'); sel.innerHTML = '<option>Cargando...</option>';
    if (!idCampus) { sel.innerHTML = '<option value="">Todos los Edificios</option>'; setMaintFilter('edificio',''); return; }
    google.script.run.withSuccessHandler(l => { let h='<option value="">Todos los Edificios</option>'; l.forEach(e => h+=`<option value="${e.id}">${e.nombre}</option>`); sel.innerHTML=h; setMaintFilter('edificio',''); }).getEdificiosPorCampus(idCampus);
  }

  function mostrarModalRevision(dateStr) {
    if (!maintModal) maintModal = new bootstrap.Modal(document.getElementById('maintModal'));
    document.getElementById('revId').value = ""; document.getElementById('revTipo').value = "Legal"; document.getElementById('revFecha').value = dateStr || new Date().toISOString().split('T')[0]; document.getElementById('maintModalTitle').innerText = 'Programar Revisi√≥n'; document.getElementById('revDocsList').innerHTML = '<div class="text-center text-muted fst-italic py-2">Sin documentos</div>';
    document.getElementById('revRecur').checked = false; document.getElementById('revFreq').value = "365"; document.getElementById('secRecurOptions').classList.add('d-none');
    if (currentAssetId) { document.getElementById('assetSelector').classList.add('d-none'); } else { document.getElementById('assetSelector').classList.remove('d-none'); const s = document.getElementById('maintCampus'); if(s.options.length<=1) populateSelectsIniciales([],[]); document.getElementById('maintEdificio').innerHTML='<option value="">- Edificio -</option>'; document.getElementById('maintEdificio').disabled=true; document.getElementById('maintActivo').innerHTML='<option value="">- Activo -</option>'; document.getElementById('maintActivo').disabled=true; }
    updateMaintFormVisibility(); maintModal.show();
  }

  function editRevision(id, tipo, fecha, activoId, hasCalendar) {
    document.getElementById('maintModalTitle').innerText = 'Editar Revisi√≥n'; document.getElementById('revId').value = id; document.getElementById('revTipo').value = tipo; document.getElementById('revFecha').value = fecha; document.getElementById('revCalendar').checked = hasCalendar;
    if (activoId) currentActiveAssetId = activoId;
    document.getElementById('revRecur').checked = false; document.getElementById('secRecurOptions').classList.add('d-none'); if(document.getElementById('revNorma')) document.getElementById('revNorma').value="";
    document.getElementById('assetSelector').classList.add('d-none');
    updateMaintFormVisibility(); loadRevDocs(id); if (maintModal) maintModal.show();
  }

  function submitRevision() {
    var id = document.getElementById('revId').value, tipo = document.getElementById('revTipo').value, fecha = document.getElementById('revFecha').value;
    var activeAssetId = currentAssetId || currentActiveAssetId;
    if (!activeAssetId) { var sel = document.getElementById('maintActivo'); if (sel) activeAssetId = sel.value; }
    if (!activeAssetId || !tipo || !fecha) return notificarError("Datos incompletos.");
    
    setBtnLoading('btnMaintSubmit', true);
    var payload = { idActivo: activeAssetId, idPlan: id, tipo: tipo, fechaProx: fecha, esRecursiva: document.getElementById('revRecur').checked, diasFreq: document.getElementById('revFreq').value, syncCalendar: document.getElementById('revCalendar').checked };
    
    // Gesti√≥n de archivo adjunto al crear
    var fileInput = document.getElementById('revFileInput'); var file = (fileInput && fileInput.files.length > 0) ? fileInput.files[0] : null;

    const finish = (res) => {
       setBtnLoading('btnMaintSubmit', false);
       if (res.success) {
         if (maintModal) maintModal.hide(); notificarExito(id ? "Actualizado" : "Creado");
         if (fileInput) fileInput.value = '';
         if (currentAssetId) loadMaint(); else loadGlobalMaint(); loadDashboard();
       } else { notificarError(res.error); }
    };

    const handler = (res) => {
        if(res.success && file) {
            const r = new FileReader();
            r.onload = function(e) {
                google.script.run.withSuccessHandler(() => finish(res)).subirArchivo(e.target.result.split(',')[1], file.name, file.type, (id || res.newId), 'REVISION');
            };
            r.readAsDataURL(file);
        } else { finish(res); }
    };

    if (id) google.script.run.withSuccessHandler(finish).updateRevision(payload);
    else google.script.run.withSuccessHandler(handler).crearRevision(payload);
  }

  function marcarHecho(id) {
    Swal.fire({
      title: '¬øCompletar revisi√≥n?',
      text: "Se marcar√° como realizada y desaparecer√° de la lista.",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#198754',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'S√≠, completar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        // 1. Efecto Visual Inmediato (Feedback)
        const btn = document.querySelector(`button[data-id="${id}"]`);
        const row = btn ? btn.closest('tr') : null;
        
        if (row) {
          // Cambio a verde suave para indicar "√©xito en proceso"
          row.style.transition = 'all 0.5s ease';
          row.style.backgroundColor = '#d1fae5'; 
          
          // Bloquear bot√≥n con spinner
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }

        // 2. Llamada al Servidor
        google.script.run
          .withSuccessHandler(res => {
            if (res.success) {
              if (row) {
                // A. Animaci√≥n de Salida (Deslizar y Desvanecer)
                row.style.opacity = '0';
                row.style.transform = 'translateX(50px)';
                
                // B. Esperar a que termine el fade-out para colapsar el hueco
                setTimeout(() => {
                  row.style.height = row.offsetHeight + 'px'; // Fijar altura actual
                  row.style.overflow = 'hidden';
                  row.style.padding = '0';
                  row.style.border = 'none';
                  
                  // Forzar repintado
                  row.offsetHeight; 
                  
                  // Colapsar altura a 0 suavemente
                  row.style.transition = 'height 0.3s ease, margin 0.3s ease, padding 0.3s ease';
                  row.style.height = '0';
                  
                  // C. Eliminar del DOM tras el colapso
                  setTimeout(() => {
                    const tbody = row.closest('tbody');
                    row.remove();
                    
                    // Si no quedan filas, mostrar mensaje de "Vac√≠o"
                    if (tbody && tbody.children.length === 0) {
                       tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-5 fst-italic">üéâ ¬°Todo al d√≠a! No hay revisiones pendientes.</td></tr>';
                    }
                    
                    // Notificaci√≥n final
                    toastModerno("‚úì Revisi√≥n completada", 'success');
                    
                    // Actualizar SOLO los n√∫meros del dashboard (sin recargar la tabla)
                    loadDashboard(); 
                    
                  }, 300); // Tiempo del colapso
                }, 500); // Tiempo del fade-out
              } else {
                // Fallback si no hay fila (raro)
                loadGlobalMaint();
              }
            } else {
              // Error: Restaurar estado original
              if (row) {
                row.style.backgroundColor = '';
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-lg"></i>';
              }
              notificarError(res.error);
            }
          })
          .withFailureHandler(err => {
             if (row) {
                row.style.backgroundColor = '';
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-lg"></i>';
             }
             notificarError("Error de conexi√≥n: " + err.message);
          })
          .completarRevision(id);
      }
    });
  }
  
  function updateMaintFormVisibility() { const t = document.getElementById('revTipo').value; const l = document.getElementById('secLegal'), r = document.getElementById('secRecur'); if(l) l.classList.add('d-none'); if(r) r.classList.add('d-none'); if(t==='Legal'){ l.classList.remove('d-none'); r.classList.remove('d-none'); } else if(t==='Peri√≥dica') r.classList.remove('d-none'); }
  function loadRevDocs(id) { const c = document.getElementById('revDocsList'); c.innerHTML='...'; google.script.run.withSuccessHandler(d=>{ let h='<ul class="list-group list-group-flush">'; if(!d.length) h='Sin docs'; else d.forEach(x=>h+=`<li class="list-group-item p-1"><a href="${x.url}" target="_blank">${x.nombre}</a></li>`); c.innerHTML=h+'</ul>'; }).obtenerDocs(id,'REVISION'); }
  function deleteRevision(id) { confirmarAccion("¬øEliminar?", "", () => google.script.run.withSuccessHandler(() => { notificarExito("Eliminada"); if(currentAssetId) loadMaint(); else loadGlobalMaint(); }).eliminarRevision(id)); }
  function loadEdificiosModalMaint(idC) { const s=document.getElementById('maintEdificio'); s.innerHTML='<option>...</option>'; s.disabled=true; google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Edificio -</option>'; l.forEach(e=>h+=`<option value="${e.id}">${e.nombre}</option>`); s.innerHTML=h; s.disabled=false; }).getEdificiosPorCampus(idC); }
  function loadActivosModalMaint(idE) { const s=document.getElementById('maintActivo'); s.innerHTML='<option>...</option>'; s.disabled=true; google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Activo -</option>'; l.forEach(a=>h+=`<option value="${a.id}">${a.nombre}</option>`); s.innerHTML=h; s.disabled=false; }).getActivosPorEdificio(idE); }

  // ==========================================
  // CONTRATOS
  // ==========================================
  function loadGlobalContracts() {
    const tbody = document.getElementById('tableGlobalContracts'); tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(d => { globalContractData = d; renderGlobalContractsTable(d); }).obtenerContratosGlobal();
  }
  function renderGlobalContractsTable(d) {
    const tbody = document.getElementById('tableGlobalContracts');
    if (!d || !d.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Sin contratos</td></tr>'; return; }
    let h = ''; d.forEach(c => {
      let color = 'bg-secondary'; if (c.color === 'rojo') color = 'bg-danger'; if (c.color === 'amarillo') color = 'bg-warning text-dark'; if (c.color === 'verde') color = 'bg-success';
      h += `<tr><td><span class="badge ${color}">${c.estado}</span></td><td><div class="fw-bold text-truncate" style="max-width:200px;">${c.nombreEntidad||'-'}</div><small class="text-muted">${c.campusNombre||''}</small></td><td>${c.proveedor}</td><td class="font-monospace small">${c.ref}</td><td><small>${c.inicio}<br>${c.fin}</small></td><td class="text-end"><button class="btn btn-sm btn-light border" onclick="editContractGlobal('${c.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteContract('${c.id}')"><i class="bi bi-trash"></i></button></td></tr>`;
    }); tbody.innerHTML = h; refreshSecurityIcons();
  }
  function setContractFilter(arg1, arg2) {
    if(['VIGENTE','PR√ìXIMO','CADUCADO','INACTIVO','all'].includes(arg1) && arg2) { const p = arg2.parentElement; p.querySelectorAll('button').forEach(b => b.classList.remove('active')); arg2.classList.add('active'); }
    const cVal = document.getElementById('contractFilterCampus').value; const eVal = document.getElementById('contractFilterEdificio').value;
    let sFilter = 'all'; const btn = document.querySelector('#contractFilterGroup .active'); if(btn) { const a = btn.getAttribute('onclick'); if(a.includes("'VIGENTE'")) sFilter='VIGENTE'; else if(a.includes("'PR√ìXIMO'")) sFilter='PR√ìXIMO'; else if(a.includes("'CADUCADO'")) sFilter='CADUCADO'; else if(a.includes("'INACTIVO'")) sFilter='INACTIVO'; }
    if(!globalContractData) return;
    const f = globalContractData.filter(i => { const mC = (cVal==="")||(String(i.campusId)===String(cVal)); const mE = (eVal==="")||(String(i.edificioId)===String(eVal)); const mS = (sFilter==='all')||(i.estado===sFilter); return mC && mE && mS; });
    renderGlobalContractsTable(f);
  }
  function loadEdificiosContractFilter(idC) { const s=document.getElementById('contractFilterEdificio'); s.innerHTML='<option>...</option>'; s.disabled=true; if(!idC){ s.innerHTML='<option value="">Todos</option>'; setContractFilter(); return; } google.script.run.withSuccessHandler(l=>{ let h='<option value="">Todos</option>'; l.forEach(e=>h+=`<option value="${e.id}">${e.nombre}</option>`); s.innerHTML=h; s.disabled=false; setContractFilter(); }).getEdificiosPorCampus(idC); }
  
  function mostrarModalContrato() {
    if (!contractModal) contractModal = new bootstrap.Modal(document.getElementById('contractModal'));
    document.getElementById('contModalTitle').innerText = 'Nuevo Contrato'; document.getElementById('contId').value = ''; document.getElementById('contProv').value = ''; document.getElementById('contRef').value = ''; document.getElementById('contIni').value = ''; document.getElementById('contFin').value = ''; document.getElementById('contEstado').value = 'ACTIVO';
    const sC = document.getElementById('contCampus'); if(sC.options.length<=1) populateSelectsIniciales([],[]); 
    document.getElementById('contEdificio').innerHTML = '<option value="">- Todo el Edificio -</option>'; document.getElementById('contEdificio').disabled=true; document.getElementById('contActivo').innerHTML='<option value="">- Activo -</option>'; document.getElementById('contActivo').disabled=true;
    contractModal.show();
  }
  function loadEdificiosContModal(idC) { const s=document.getElementById('contEdificio'); s.innerHTML='<option>...</option>'; s.disabled=true; document.getElementById('contActivo').disabled=true; if(!idC) return; google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Todo el Edificio -</option>'; l.forEach(e=>h+=`<option value="${e.id}">${e.nombre}</option>`); s.innerHTML=h; s.disabled=false; }).getEdificiosPorCampus(idC); }
  function loadActivosContModal(idE) { const s=document.getElementById('contActivo'); s.innerHTML='<option>...</option>'; s.disabled=true; if(!idE) return; google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Activo -</option>'; l.forEach(a=>h+=`<option value="${a.id}">${a.nombre}</option>`); s.innerHTML=h; s.disabled=false; }).getActivosPorEdificio(idE); }
  
  function submitContract() {
    const id = document.getElementById('contId').value, prov = document.getElementById('contProv').value, ref = document.getElementById('contRef').value, ini = document.getElementById('contIni').value, fin = document.getElementById('contFin').value;
    const idC = document.getElementById('contCampus').value, idE = document.getElementById('contEdificio').value, idA = document.getElementById('contActivo').value;
    if (!prov || !ini || !fin || !idC) return notificarError("Faltan datos.");
    let idEnt = idC, tipoEnt = 'CAMPUS'; if(idE){ idEnt=idE; tipoEnt='EDIFICIO'; } if(idA){ idEnt=idA; tipoEnt='ACTIVO'; }
    setBtnLoading('btnContSubmit', true);
    const cb = (res) => { setBtnLoading('btnContSubmit', false); if(res.success){ contractModal.hide(); notificarExito("Guardado"); loadGlobalContracts(); if(currentAssetId) loadContracts(); } else notificarError(res.error); };
    const d = { id:id, idEntidad:idEnt, tipoEntidad:tipoEnt, proveedor:prov, ref:ref, fechaIni:ini, fechaFin:fin, estado:document.getElementById('contEstado').value };
    if(id) google.script.run.withSuccessHandler(cb).updateContrato(d); else google.script.run.withSuccessHandler(cb).crearContrato(d);
  }
  function editContractGlobal(id) {
    mostrarModalContrato(); document.getElementById('contModalTitle').innerText='Cargando...'; document.getElementById('btnContSubmit').disabled=true;
    google.script.run.withSuccessHandler(d => {
        document.getElementById('contModalTitle').innerText='Editar Contrato'; document.getElementById('contId').value=d.id; document.getElementById('contProv').value=d.proveedor; document.getElementById('contRef').value=d.ref; document.getElementById('contIni').value=d.inicio; document.getElementById('contFin').value=d.fin; document.getElementById('contEstado').value=d.estado;
        const sC=document.getElementById('contCampus'); sC.value=d.idCampus;
        const sE=document.getElementById('contEdificio'); sE.disabled=true; sE.innerHTML='<option>...</option>';
        google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Todo -</option>'; l.forEach(e=>h+=`<option value="${e.id}">${e.nombre}</option>`); sE.innerHTML=h; sE.disabled=false; if(d.idEdificio){ sE.value=d.idEdificio; const sA=document.getElementById('contActivo'); sA.disabled=true; sA.innerHTML='<option>...</option>'; google.script.run.withSuccessHandler(al=>{ let ha='<option value="">- Activo -</option>'; al.forEach(a=>ha+=`<option value="${a.id}">${a.nombre}</option>`); sA.innerHTML=ha; sA.disabled=false; if(d.idActivo) sA.value=d.idActivo; document.getElementById('btnContSubmit').disabled=false; }).getActivosPorEdificio(d.idEdificio); } else document.getElementById('btnContSubmit').disabled=false; }).getEdificiosPorCampus(d.idCampus);
    }).getContratoFullDetails(id);
  }
  function deleteContract(id) { confirmarAccion("¬øEliminar?", "", () => google.script.run.withSuccessHandler(() => { notificarExito("Eliminado"); loadGlobalContracts(); if(currentAssetId) loadContracts(); }).eliminarContrato(id)); }
  function descargarInforme(tipo) { const btn = document.getElementById(tipo==='LEGAL'?'btnPdfLegal':'btnPdfContratos'); const og = btn.innerHTML; btn.disabled=true; btn.innerHTML='...'; google.script.run.withSuccessHandler(res=>{ btn.disabled=false; btn.innerHTML=og; const l=document.createElement('a'); l.href='data:application/pdf;base64,'+res.base64; l.download=res.filename; l.click(); }).withFailureHandler(e=>{ btn.disabled=false; btn.innerHTML=og; notificarError(e.message); }).generarInformePDF(tipo); }

  // ==========================================
  // ACTIVOS, EDIFICIOS, CAMPUS
  // ==========================================
  function loadAllAssets(preserve = false) {
    if(!preserve) { document.getElementById('tableActivos').innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>'; }
    google.script.run.withSuccessHandler(l => { window.allAssetsData = l; applyAssetFilters(); }).getAllAssetsList();
  }
  function applyAssetFilters() {
    const fC = document.getElementById('filterCampus').value; const fE = document.getElementById('filterEdificio').value; const fS = document.getElementById('filterSearch').value.toLowerCase().trim();
    const filtered = window.allAssetsData.filter(i => {
        if(fC && String(i.idCampus) !== String(fC)) return false;
        if(fE && String(i.idEdificio) !== String(fE)) return false;
        if(fS && !(i.nombre+' '+i.marca+' '+i.tipo).toLowerCase().includes(fS)) return false;
        return true;
    });
    renderAssetsTable(filtered);
  }
  // En js.html

  function renderAssetsTable(list) {
    renderTableLazy(document.getElementById('tableActivos'), list, (i) => {
        const clip = i.hasDocs ? '<i class="bi bi-paperclip text-primary ms-2"></i>' : '';
        const legalIcon = i.hasLegalDocs ? '<i class="bi bi-shield-check text-success ms-2" title="Legal OK"></i>' : '';
        
        return `<tr>
          <td class="fw-bold ps-4">
              <i class="bi bi-box-seam text-primary me-2"></i>${i.nombre}${clip}${legalIcon}
              <div class="small text-muted fw-normal ms-4">${i.edificioNombre}</div>
          </td>
          <td><span class="badge bg-light text-dark border">${i.tipo}</span></td>
          <td>${i.marca}</td>
          <td class="text-end pe-4">
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="openQuickUpload('${i.id}')" title="Subida R√°pida">
                <i class="bi bi-cloud-arrow-up-fill"></i>
              </button>
              <button class="btn btn-sm btn-outline-primary" onclick="openAssetDetail('${i.id}')">Ver Ficha</button>
          </td>
        </tr>`;
    }, 50);
  }
  function loadEdificios(idC) { document.getElementById('filterEdificio').value=""; applyAssetFilters(); const s=document.getElementById('filterEdificio'); s.disabled=true; s.innerHTML='<option>Cargando...</option>'; if(!idC){ s.innerHTML='<option value="">- Seleccione -</option>'; s.disabled=false; return; } google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Seleccione -</option>'; l.forEach(i=>h+=`<option value="${i.id}">${i.nombre}</option>`); s.innerHTML=h; s.disabled=false; }).getEdificiosPorCampus(idC); }
  function loadActivos(idE) { applyAssetFilters(); }
  function filterAssets() { applyAssetFilters(); }

  // IMPORTACION
  function openImportModal() { if(!importModal) importModal=new bootstrap.Modal(document.getElementById('importModal')); document.getElementById('importData').value=''; document.getElementById('importLog').innerText=''; importModal.show(); }
  function ejecutarImportacion() {
    const txt = document.getElementById('importData').value; if(!txt.trim()) return notificarError("Vac√≠o");
    const filas = []; txt.split('\n').forEach(l=>{ if(l.trim()){ const c=l.split('\t'); if(c.length===1 && l.includes(';')) filas.push(l.split(';')); else filas.push(c); } });
    confirmarAccion(`¬øImportar ${filas.length}?`, "", () => { setBtnLoading('btnImportRun',true); google.script.run.withSuccessHandler(res=>{ setBtnLoading('btnImportRun',false); if(res.success){ importModal.hide(); notificarExito("Importado"); loadAllAssets(); } else { document.getElementById('importLog').innerHTML=res.errores.join('<br>'); notificarError("Errores encontrados"); } }).procesarCargaMasiva(filas); });
  }

  // EDIFICIOS
  function loadEdificiosList() {
  const t = document.getElementById('tableEdificiosBody');
  
  // ‚ú® Mostrar skeleton mientras carga
  showSkeletonTable(t, 8, 4);
  
  google.script.run.withSuccessHandler(d => {
    allEdificiosData = d;
    
    // ‚ú® Renderizado animado
    renderTableAnimated(t, d, (r) => {
      return `<tr>
        <td class="ps-4 fw-bold"><a href="#" onclick="openBuildingDetail('${r.id}');return false;">${r.nombre}</a></td>
        <td>${r.campus}</td>
        <td>${r.contacto}</td>
        <td class="text-end pe-4">
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" onclick="openBuildingDetail('${r.id}')"><i class="bi bi-eye"></i></button>
            <button class="btn btn-sm btn-light border" onclick="openEdificioModal('${r.id}','${r.nombre}','${r.campus}','${r.contacto}','${r.lat||''}','${r.lng||''}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteEdificio('${r.id}')"><i class="bi bi-trash"></i></button>
          </div>
        </td>
      </tr>`;
    }, { animationDelay: 15 });
    
    if (mapInstance) renderMarkers(d);
  }).getTableData('EDIFICIOS');
}
  function filterEdificiosList() { const c=document.getElementById('filterCampusEdificios').value; const s=document.getElementById('searchEdificios').value.toLowerCase(); const f=allEdificiosData.filter(r=>{ return ((c==="")||(r.campus===c)) && (r.nombre.toLowerCase().includes(s)||String(r.contacto).toLowerCase().includes(s)); }); renderEdificiosTable(f); if(mapInstance) renderMarkers(f); }
  function renderEdificiosTable(d) {
    const t=document.getElementById('tableEdificiosBody'); if(!d.length) { t.innerHTML='Sin datos'; return; }
    let h=''; d.forEach(r=>{ h+=`<tr><td class="ps-4 fw-bold"><a href="#" onclick="openBuildingDetail('${r.id}');return false;">${r.nombre}</a></td><td>${r.campus}</td><td>${r.contacto}</td><td class="text-end pe-4"><div class="btn-group"><button class="btn btn-sm btn-outline-primary" onclick="openBuildingDetail('${r.id}')"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-light border" onclick="openEdificioModal('${r.id}','${r.nombre}','${r.campus}','${r.contacto}','${r.lat||''}','${r.lng||''}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteEdificio('${r.id}')"><i class="bi bi-trash"></i></button></div></td></tr>`; }); t.innerHTML=h; refreshSecurityIcons();
  }
  function openEdificioModal(id,n,c,ct,lat,lng) { if(!edificioModal) edificioModal=new bootstrap.Modal(document.getElementById('edificioModal')); const s=document.getElementById('edifCampus'); google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Seleccione -</option>'; l.forEach(i=>{ const sel=(c && i.nombre===c)?'selected':''; h+=`<option value="${i.id}" ${sel}>${i.nombre}</option>`; }); s.innerHTML=h; }).getListaCampus(); document.getElementById('edificioModalTitle').innerText=id?'Editar':'Nuevo'; document.getElementById('edifId').value=id||''; document.getElementById('edifNombre').value=n||''; document.getElementById('edifContacto').value=ct||''; document.getElementById('edifLat').value=lat||''; document.getElementById('edifLng').value=lng||''; edificioModal.show(); }
  function submitEdificio() {
    const id=document.getElementById('edifId').value, n=document.getElementById('edifNombre').value, c=document.getElementById('edifCampus').value;
    const latRaw=document.getElementById('edifLat').value, lngRaw=document.getElementById('edifLng').value;
    let lat=null, lng=null; if(latRaw) lat=parseFloat(latRaw.replace(',','.')); if(lngRaw) lng=parseFloat(lngRaw.replace(',','.'));
    if(!n||!c) return notificarError("Faltan datos");
    mostrarCargando();
    const cb=(res)=>{ if(edificioModal) edificioModal.hide(); if(res.success){ notificarExito("Guardado"); loadEdificiosList(); } else notificarError(res.error); };
    const p={id:id, nombre:n, idCampus:c, contacto:document.getElementById('edifContacto').value, lat:lat, lng:lng};
    if(id) google.script.run.withSuccessHandler(cb).updateEdificio(p); else google.script.run.withSuccessHandler(cb).crearEdificio(p);
  }
  function deleteEdificio(id) {
  confirmarAccion("¬øEliminar edificio?", "Esta acci√≥n no se puede deshacer", () => {
    // 1. Buscar la fila en el DOM
    const tbody = document.getElementById('tableEdificiosBody');
    const row = Array.from(tbody.querySelectorAll('tr')).find(tr => {
      const btn = tr.querySelector(`button[onclick*="deleteEdificio('${id}')"]`);
      return btn !== null;
    });
    
    if (row) {
      // 2. Animaci√≥n de salida ANTES de eliminar en servidor
      animateRowOut(row, () => {
        // 3. Llamada al servidor (cuando la animaci√≥n termina)
        google.script.run
          .withSuccessHandler(() => {
            toastModerno("Edificio eliminado", 'success');
          })
          .withFailureHandler(err => {
            // Si falla, restaurar la fila (opcional)
            notificarError("Error: " + err.message);
            loadEdificiosList(); // Recargar para recuperar estado
          })
          .eliminarEdificio(id);
      });
    }
  });
}

  // CAMPUS
  function loadCampusList() { 
    const t = document.getElementById('tableCampusBody'); 
    t.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary spinner-border-sm"></div> Cargando...</td></tr>'; 
    google.script.run.withSuccessHandler(d => { 
      let h = ''; 
      d.forEach(r => { h += `<tr><td class="ps-4 fw-bold text-primary">${r.nombre}</td><td>${r.provincia}</td><td><small>${r.direccion}</small></td><td class="text-end pe-4"><button class="btn btn-sm btn-light border me-1" onclick="openCampusModal('${r.id}','${r.nombre}','${r.provincia}','${r.direccion}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteCampus('${r.id}')"><i class="bi bi-trash"></i></button></td></tr>`; }); 
      t.innerHTML = h || '<tr><td colspan="4" class="text-center text-muted">Sin datos</td></tr>'; 
      refreshSecurityIcons(); 
    }).getTableData('CAMPUS'); 
  }
  function openCampusModal(id,n,p,d) { if(!campusModal) campusModal=new bootstrap.Modal(document.getElementById('campusModal')); document.getElementById('campusModalTitle').innerText=id?'Editar':'Nuevo'; document.getElementById('campId').value=id||''; document.getElementById('campNombre').value=n||''; document.getElementById('campProv').value=p||''; document.getElementById('campDir').value=d||''; campusModal.show(); }
  function submitCampus() { const id=document.getElementById('campId').value, n=document.getElementById('campNombre').value; if(!n) return; setBtnLoading('btnCampusSubmit',true); const cb=(r)=>{ setBtnLoading('btnCampusSubmit',false); if(r.success){ campusModal.hide(); loadCampusList(); }}; const p={id:id, nombre:n, provincia:document.getElementById('campProv').value, direccion:document.getElementById('campDir').value}; if(id) google.script.run.withSuccessHandler(cb).updateCampus(p); else google.script.run.withSuccessHandler(cb).crearCampus(p); }
  function deleteCampus(id) { confirmarAccion("¬øBorrar?","",()=>google.script.run.withSuccessHandler(()=>loadCampusList()).eliminarCampus(id)); }

  // CREAR (MODAL GENERICO)
  function mostrarModalCrear(t) {
    if(myModal) {
        document.getElementById('createForm').reset(); document.getElementById('modalType').value=t; document.getElementById('modalTitle').innerText='Nuevo '+t;
        const ex=document.getElementById('extraFields'); ex.innerHTML='';
        if(t==='ACTIVO') {
            const fC=document.getElementById('filterCampus').value, fE=document.getElementById('filterEdificio').value;
            ex.innerHTML=`<div class="mb-2"><label>Campus</label><select id="fCampusModal" class="form-select" onchange="loadEdificiosModal(this.value)"><option>...</option></select></div><div class="mb-2"><label>Edificio</label><select id="fEdificioModal" class="form-select" disabled></select></div><div class="mb-2"><label>Tipo</label><select id="fTipo" class="form-select" disabled></select></div><div class="mb-2"><label>Marca</label><input id="fMarca" class="form-control"></div>`;
            google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Seleccione -</option>'; l.forEach(i=>{ const s=(fC&&String(i.id)===String(fC))?'selected':''; h+=`<option value="${i.id}" ${s}>${i.nombre}</option>`; }); document.getElementById('fCampusModal').innerHTML=h; if(fC) loadEdificiosModal(fC,fE); }).getListaCampus();
            google.script.run.withSuccessHandler(ts=>{ ts.sort((a,b)=>a.nombre.localeCompare(b.nombre)); let o='<option value="">- Seleccione -</option>'; ts.forEach(t=>o+=`<option value="${t.id}">${t.nombre}</option>`); document.getElementById('fTipo').innerHTML=o; document.getElementById('fTipo').disabled=false; }).getCatalogoInstalaciones();
        }
        myModal.show();
    }
  }
  function loadEdificiosModal(idC, pre) { const s=document.getElementById('fEdificioModal'); s.disabled=true; s.innerHTML='...'; google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Seleccione -</option>'; l.forEach(i=>{ const sel=(pre&&String(i.id)===String(pre))?'selected':''; h+=`<option value="${i.id}" ${sel}>${i.nombre}</option>`; }); s.innerHTML=h; s.disabled=false; }).getEdificiosPorCampus(idC); }
  function submitCreate() {
    const t = document.getElementById('modalType').value;
    const n = document.getElementById('fNombre').value;
    const btn = 'btnCreateSubmit';
    
    if (!n) return;
    
    setBtnLoading(btn, true);
    
    const cb = (r) => {
      setBtnLoading(btn, false);
      
      if (r.success) {
        myModal.hide();
        
        // ‚ú® ANIMACI√ìN: Toast moderno + recarga suave
        toastModerno("Activo creado con √©xito", 'success');
        
        if (t === 'ACTIVO') {
          // En lugar de recargar brutalmente, a√±adimos la nueva fila animada
          google.script.run
            .withSuccessHandler(activo => {
              const tbody = document.getElementById('tableActivos');
              const tr = document.createElement('tr');
              
              tr.innerHTML = `
                <td class="fw-bold ps-4">
                  <i class="bi bi-box-seam text-primary me-2"></i>${activo.nombre}
                  <div class="small text-muted fw-normal ms-4">${activo.edificioNombre}</div>
                </td>
                <td><span class="badge bg-light text-dark border">${activo.tipo}</span></td>
                <td>${activo.marca}</td>
                <td class="text-end pe-4">
                  <button class="btn btn-sm btn-outline-primary" onclick="openAssetDetail('${activo.id}')">Ver Ficha</button>
                </td>
              `;
              
              tbody.insertBefore(tr, tbody.firstChild);
              
              // ‚ú® Animaci√≥n de entrada + destaque temporal
              animateRowIn(tr);
              setTimeout(() => tr.classList.add('pulse-once'), 100);
            })
            .getAssetInfo(r.newId);
        }
      } else {
        notificarError(r.error);
      }
    };
    
    if (t === 'ACTIVO') {
      google.script.run.withSuccessHandler(cb).crearActivo({
        nombre: n,
        idEdificio: document.getElementById('fEdificioModal').value,
        tipo: document.getElementById('fTipo').value,
        marca: document.getElementById('fMarca').value
      });
    }
  }

  // DETALLES Y FICHAS
  function openAssetDetail(id) { currentAssetId=id; currentActiveAssetId=id; document.querySelectorAll('.view-section').forEach(e=>e.classList.add('d-none')); document.getElementById('view-asset-detail').classList.remove('d-none'); toggleEditInfo(false); google.script.run.withSuccessHandler(i=>{ document.getElementById('detail-name').innerText=i.nombre; document.getElementById('detail-type').innerText=i.tipo; document.getElementById('d-nombre-val').innerText=i.nombre; document.getElementById('d-tipo-val').innerText=i.tipo; document.getElementById('d-marca-val').innerText=i.marca; document.getElementById('d-fecha-val').innerText=i.fechaAlta; document.getElementById('edit-nombre').value=i.nombre; document.getElementById('edit-marca').value=i.marca; loadDocs(); loadMaint(); loadContracts(); loadRelacionesActivo(); }).getAssetInfo(id); }
  function closeAssetDetail() { currentAssetId=null; document.getElementById('view-asset-detail').classList.add('d-none'); if(currentBuildingId) document.getElementById('view-building-detail').classList.remove('d-none'); else document.getElementById('view-activos').classList.remove('d-none'); }

  function openBuildingDetail(id) {
    console.log('üè¢ Abriendo edificio con ID:', id);
    
    if (!id) {
      console.error('‚ùå ERROR: ID de edificio inv√°lido');
      notificarError('Error: ID de edificio no v√°lido');
      return;
    }
    
    currentBuildingId = id;
    
    // 1. Ocultar todas las vistas
    document.querySelectorAll('.view-section').forEach(e => e.classList.add('d-none'));
    
    // 2. Mostrar vista de detalle
    const view = document.getElementById('view-building-detail');
    if (!view) {
      console.error('‚ùå ERROR: Vista view-building-detail no encontrada');
      return;
    }
    view.classList.remove('d-none');
    
    // 3. Resetear tabs ANTES de cargar datos
    const allTabs = view.querySelectorAll('.nav-link');
    const allPanes = view.querySelectorAll('.tab-pane');
    
    allTabs.forEach(t => t.classList.remove('active'));
    allPanes.forEach(p => p.classList.remove('show', 'active'));
    
    // Activar primera pesta√±a (Informaci√≥n)
    const firstTab = allTabs[0];
    const firstPane = allPanes[0];
    
    if (firstTab) firstTab.classList.add('active');
    if (firstPane) {
      firstPane.classList.add('show', 'active');
    }
    
    // 4. Cargar datos del edificio
    google.script.run
      .withSuccessHandler(info => {
        console.log('‚úÖ Info del edificio recibida:', info);
        
        // Actualizar textos SOLO SI LOS ELEMENTOS EXISTEN
        const elName = document.getElementById('b-detail-name');
        const elCampus = document.getElementById('b-detail-campus');
        const elNombre = document.getElementById('bd-nombre');
        const elCampusInfo = document.getElementById('bd-campus');
        const elContacto = document.getElementById('bd-contacto');
        
        if (elName) elName.innerText = info.nombre;
        if (elCampus) elCampus.innerText = info.campus;
        if (elNombre) elNombre.innerText = info.nombre;
        if (elCampusInfo) elCampusInfo.innerText = info.campus;
        if (elContacto) elContacto.innerText = info.contacto;
        
        // NO cargar pesta√±as autom√°ticamente - solo bajo demanda
        console.log('‚úÖ Vista de edificio lista');
      })
      .withFailureHandler(err => {
        console.error('‚ùå Error cargando info del edificio:', err);
        notificarError('Error al cargar datos del edificio: ' + err.message);
      })
      .getBuildingInfo(id);
  }

  function closeBuildingDetail() { currentBuildingId=null; document.getElementById('view-building-detail').classList.add('d-none'); document.getElementById('view-edificios').classList.remove('d-none'); }
  
  function toggleEditInfo(e) { 
      if(e) { document.getElementById('info-view-mode').classList.add('d-none'); document.getElementById('info-edit-mode').classList.remove('d-none'); document.getElementById('btn-edit-info').classList.add('d-none'); document.getElementById('btn-save-info').classList.remove('d-none'); const sel=document.getElementById('edit-tipo'); if(sel.options.length<=1) google.script.run.withSuccessHandler(l=>{ let h=''; const cur=document.getElementById('d-tipo-val').innerText; l.forEach(t=>{ const s=t.nombre===cur?'selected':''; h+=`<option value="${t.nombre}" ${s}>${t.nombre}</option>`; }); sel.innerHTML=h; }).getCatalogoInstalaciones(); }
      else { document.getElementById('info-view-mode').classList.remove('d-none'); document.getElementById('info-edit-mode').classList.add('d-none'); document.getElementById('btn-edit-info').classList.remove('d-none'); document.getElementById('btn-save-info').classList.add('d-none'); }
  }
  function saveAssetInfo() {
  setBtnLoading('btn-save-info button', true);
  
  google.script.run.withSuccessHandler(r => {
    if (r.success) {
      // ‚ú® Flash verde en el card
      const infoCard = document.querySelector('#tab-info .card');
      flashSuccess(infoCard);
      
      toastModerno("Datos actualizados", 'success');
      
      openAssetDetail(currentAssetId);
      loadAllAssets(true);
    } else {
      notificarError(r.error);
    }
  }).updateAsset({
    id: currentAssetId,
    nombre: document.getElementById('edit-nombre').value,
    marca: document.getElementById('edit-marca').value,
    tipo: document.getElementById('edit-tipo').value
  });
}

  // DOCUMENTOS & OBRAS

  function loadDocs() {
    if (!currentAssetId) return;
    
    const tbody = document.getElementById('docsTableBody');
    
    // ‚ú® SPINNER DE CARGA (restaurado)
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <div class="small text-muted mt-2">Cargando documentaci√≥n...</div>
        </td>
      </tr>
    `;
    
    google.script.run.withSuccessHandler(docs => {
      if (docs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted fst-italic py-3">No hay documentos adjuntos.</td></tr>';
        return;
      }
      
      let html = '';
      docs.forEach(d => {
        html += `<tr class="fade-in">
          <td class="ps-3 align-middle text-truncate" style="max-width: 250px;">
            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
            <a href="${d.url}" target="_blank" class="text-decoration-none text-dark fw-bold">${d.nombre}</a>
          </td>
          <td class="align-middle"><span class="badge bg-secondary">v${d.version}</span></td>
          <td class="align-middle small text-muted">${d.fecha}</td>
          <td class="text-end pe-3">
            <div class="btn-group">
              <a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver"><i class="bi bi-eye"></i></a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteDoc('${d.id}')" title="Eliminar"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>`;
      });
      
      tbody.innerHTML = html;
      refreshSecurityIcons();
    }).obtenerDocs(currentAssetId);
  }


  function uploadFile() {
  const f = document.getElementById('fileInput').files[0];
  if (!f) return;
  
  // ‚ú® Cambiar visualmente el bot√≥n mientras sube
  const btnUpload = event.target; // Si llamas desde el bot√≥n
  const originalHTML = btnUpload ? btnUpload.innerHTML : '';
  
  if (btnUpload) {
    btnUpload.disabled = true;
    btnUpload.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Subiendo...';
  }
  
  const r = new FileReader();
  r.onload = e => {
    google.script.run
      .withSuccessHandler(() => {
        toastModerno(`"${f.name}" subido correctamente`, 'success');
        
        if (btnUpload) {
          btnUpload.disabled = false;
          btnUpload.innerHTML = originalHTML;
        }
        
        loadDocs();
      })
      .withFailureHandler(err => {
        toastModerno("Error al subir: " + err.message, 'error');
        
        if (btnUpload) {
          btnUpload.disabled = false;
          btnUpload.innerHTML = originalHTML;
        }
      })
      .subirArchivo(e.target.result.split(',')[1], f.name, f.type, currentAssetId, 'ACTIVO');
  };
  
  r.readAsDataURL(f);
}
  function deleteDoc(id) { confirmarAccion("¬øBorrar?","",()=>google.script.run.withSuccessHandler(()=>loadDocs()).eliminarDocumento(id)); }

  function loadBuildingDocs() {
    if (!currentBuildingId) return;
    
    const tbody = document.getElementById('buildingDocsBody');
    
    // ‚ú® SPINNER DE CARGA (restaurado)
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <div class="small text-muted mt-2">Cargando documentaci√≥n...</div>
        </td>
      </tr>
    `;
    
    google.script.run.withSuccessHandler(docs => {
      if (docs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted fst-italic py-3">No hay documentos adjuntos.</td></tr>';
        return;
      }
      
      let html = '';
      docs.forEach(d => {
        html += `<tr class="fade-in">
          <td class="ps-3">${d.nombre}</td>
          <td>${d.fecha}</td>
          <td class="text-end pe-3">
            <div class="btn-group">
              <a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver">
                <i class="bi bi-eye"></i>
              </a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteDocBuilding('${d.id}')" title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>`;
      });
      
      tbody.innerHTML = html;
      refreshSecurityIcons();
    }).obtenerDocs(currentBuildingId, 'EDIFICIO');
  }

  function uploadBuildingFile() { const f=document.getElementById('fileInputBuilding').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>google.script.run.withSuccessHandler(()=>{ notificarExito("Subido"); loadBuildingDocs(); }).subirArchivo(e.target.result.split(',')[1], f.name, f.type, currentBuildingId, 'EDIFICIO'); r.readAsDataURL(f); }
  function deleteDocBuilding(id) { confirmarAccion("¬øBorrar?","",()=>google.script.run.withSuccessHandler(()=>loadBuildingDocs()).eliminarDocumento(id)); }
  
  function showModalObra() { if(!obraModal) obraModal=new bootstrap.Modal(document.getElementById('obraModal')); document.getElementById('obraNombre').value=''; document.getElementById('obraDesc').value=''; document.getElementById('obraFecha').value=''; obraModal.show(); }
  function submitObra() { const n=document.getElementById('obraNombre').value; if(!n) return; setBtnLoading('btnObraSubmit',true); google.script.run.withSuccessHandler(r=>{ if(r.success) { obraModal.hide(); loadBuildingObras(); notificarExito("Creada"); } setBtnLoading('btnObraSubmit',false); }).crearObra({idEdificio:currentBuildingId, nombre:n, descripcion:document.getElementById('obraDesc').value, fechaInicio:document.getElementById('obraFecha').value}); }

  function loadBuildingObras() {
    if (!currentBuildingId) return;
    
    const container = document.getElementById('buildingObrasList');
    
    // ‚ú® SPINNER DE CARGA
    container.innerHTML = `
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary"></div>
        <div class="small text-muted mt-2">Cargando obras...</div>
      </div>
    `;
    
    google.script.run.withSuccessHandler(obras => {
      if (obras.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">No hay obras registradas</div>';
        return;
      }
      
      let html = '';
      obras.forEach(o => {
        html += `
          <div class="col-md-6 mb-3 fade-in">
            <div class="card p-3 shadow-sm h-100">
              <h5 class="fw-bold">${o.nombre}</h5>
              <p class="text-muted small mb-2">${o.descripcion || 'Sin descripci√≥n'}</p>
              <div class="mt-auto">
                <span class="badge bg-light text-dark border me-2">${o.fecha}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteObra('${o.id}')">
                  <i class="bi bi-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      refreshSecurityIcons();
    }).getObrasPorEdificio(currentBuildingId);
  }

  function deleteObra(id) { confirmarAccion("¬øBorrar?","",()=>google.script.run.withSuccessHandler(()=>loadBuildingObras()).eliminarObra(id)); }
  
  function loadBuildingAssets() {
    // ‚úÖ DECLARAR ELEMENTOS DEL DOM PRIMERO
    const tbody = document.getElementById('buildingAssetsBody');
    const filterSelect = document.getElementById('filterAssetTypeBuilding');
    
    // Validar que los elementos existan
    if (!tbody) {
      console.error('‚ùå ERROR FATAL: Elemento buildingAssetsBody no encontrado en el DOM');
      return;
    }
    
    // Validar que tengamos ID de edificio
    if (!currentBuildingId) {
      console.error('‚ùå ERROR: No hay currentBuildingId definido');
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-danger py-4">
            <i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>
            <strong>Error: ID de edificio no v√°lido</strong>
          </td>
        </tr>
      `;
      return;
    }
    
    // Mostrar spinner de carga
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <div class="small text-muted mt-2">Cargando activos del edificio...</div>
        </td>
      </tr>
    `;
    
    console.log('üîç Solicitando activos para edificio:', currentBuildingId);
    
    // Llamada al servidor
    google.script.run
      .withSuccessHandler(activos => {
        console.log('üì¶ Respuesta recibida del servidor:', activos);
        console.log('üìä Tipo de dato:', typeof activos);
        console.log('üìè ¬øEs array?:', Array.isArray(activos));
        
        // ‚úÖ VALIDACI√ìN ESTRICTA DE LA RESPUESTA
        if (activos === null || activos === undefined) {
          console.error('‚ùå Respuesta nula del servidor');
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>
                <strong>Error del servidor</strong><br>
                <small class="text-muted">La funci√≥n no devolvi√≥ datos v√°lidos</small>
              </td>
            </tr>
          `;
          window.currentBuildingAssetsList = [];
          return;
        }
        
        if (!Array.isArray(activos)) {
          console.error('‚ùå Respuesta no es un array:', activos);
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>
                <strong>Error: Formato de datos inv√°lido</strong><br>
                <small class="text-muted">Se esperaba un array, recibido: ${typeof activos}</small>
              </td>
            </tr>
          `;
          window.currentBuildingAssetsList = [];
          return;
        }
        
        // Guardar en variable global
        window.currentBuildingAssetsList = activos;
        console.log(`‚úÖ ${activos.length} activos guardados en memoria`);
        
        // Poblar filtro de tipos
        if (filterSelect) {
          filterSelect.innerHTML = '<option value="">- Todos los tipos -</option>';
          
          const tipos = [...new Set(activos.map(a => a.tipo || 'Sin tipo'))].sort();
          
          tipos.forEach(tipo => {
            const option = document.createElement('option');
            option.value = tipo;
            option.textContent = tipo;
            filterSelect.appendChild(option);
          });
        }
        
        // Renderizar tabla
        renderBuildingAssetsTable(activos);
      })
      .withFailureHandler(error => {
        console.error('üí• ERROR al cargar activos:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-danger py-4">
              <i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>
              <strong>Error al cargar los activos</strong><br>
              <small class="text-muted">${error.message || 'Error desconocido'}</small>
            </td>
          </tr>
        `;
        window.currentBuildingAssetsList = [];
      })
      .getActivosPorEdificio(currentBuildingId);
  }

  function filterBuildingAssets() {
    const filterSelect = document.getElementById('filterAssetTypeBuilding');
    const filterValue = filterSelect ? filterSelect.value : '';
    
    // ‚úÖ VALIDACI√ìN: Verificar que existe la lista
    const activos = window.currentBuildingAssetsList;
    
    if (!activos || !Array.isArray(activos)) {
      console.error('No hay activos en memoria para filtrar');
      renderBuildingAssetsTable([]);
      return;
    }
    
    const filtered = filterValue 
      ? activos.filter(a => a.tipo === filterValue) 
      : activos;
    
    renderBuildingAssetsTable(filtered);
  }

  // MANTENIMIENTO ASSET

  function loadMaint() {
    if (!currentAssetId) return;
    
    const tbody = document.getElementById('maintTableBody');
    
    // ‚ú® SPINNER DE CARGA
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <div class="small text-muted mt-2">Cargando plan de mantenimiento...</div>
        </td>
      </tr>
    `;
    
    google.script.run.withSuccessHandler(list => {
      if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted fst-italic py-3">No hay mantenimiento programado.</td></tr>';
        return;
      }
      
      let html = '';
      list.forEach(p => {
        let dotClass = 'bg-secondary';
        if (p.color === 'rojo') dotClass = 'bg-rojo';
        if (p.color === 'amarillo') dotClass = 'bg-amarillo';
        if (p.color === 'verde') dotClass = 'bg-verde';
        if (p.color === 'azul') dotClass = 'bg-info';

        let clipIcon = p.hasDocs ? '<i class="bi bi-paperclip text-primary ms-2" title="Adjuntos"></i>' : '';
        let calIcon = p.hasCalendar ? '<i class="bi bi-calendar-check text-success ms-2" title="Sincronizado"></i>' : '';
        
        html += `<tr class="align-middle fade-in">
          <td class="text-center"><span class="dot ${dotClass}" style="width: 12px; height: 12px;"></span></td>
          <td>${p.tipo} ${clipIcon} ${calIcon}</td>
          <td>${p.fechaProxima}</td>
          <td class="text-end">
            <div class="btn-group">
              <button class="btn btn-sm btn-light border" onclick="editRevision('${p.id}', '${p.tipo}', '${p.fechaISO}', null, ${p.hasCalendar})" title="Editar"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRevision('${p.id}')" title="Borrar"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>`;
      });
      
      tbody.innerHTML = html;
      refreshSecurityIcons();
    }).obtenerPlanMantenimiento(currentAssetId);
  }

  function loadContracts() {
    if (!currentAssetId) return;
    
    const tbody = document.getElementById('contractsTableBody');
    
    // ‚ú® SPINNER DE CARGA
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <div class="small text-muted mt-2">Cargando contratos...</div>
        </td>
      </tr>
    `;
    
    google.script.run.withSuccessHandler(list => {
      if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted fst-italic py-3">No hay contratos activos.</td></tr>';
        return;
      }
      
      let html = '';
      list.forEach(c => {
        let badgeClass = 'bg-secondary';
        if (c.color === 'verde') badgeClass = 'bg-success';
        if (c.color === 'rojo') badgeClass = 'bg-danger';
        if (c.color === 'amarillo') badgeClass = 'bg-warning text-dark';
        
        html += `<tr class="align-middle fade-in">
          <td><span class="badge ${badgeClass}">${c.estado}</span></td>
          <td class="fw-bold text-dark">${c.proveedor}</td>
          <td class="font-monospace small">${c.ref}</td>
          <td><small class="text-muted">${c.inicio} - ${c.fin}</small></td>
          <td class="text-end">
            <div class="btn-group">
              <button class="btn btn-sm btn-light border" onclick="editContract('${c.id}', '${c.proveedor}', '${c.ref}', '${c.inicio}', '${c.fin}', '${c.estadoDB}')" title="Editar"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteContract('${c.id}')" title="Eliminar"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>`;
      });
      
      tbody.innerHTML = html;
      refreshSecurityIcons();
    }).obtenerContratos(currentAssetId);
  }

  function renderBuildingAssetsTable(activos) {
    const tbody = document.getElementById('buildingAssetsBody');
    
    // VALIDACI√ìN 1: tbody existe
    if (!tbody) {
      console.error('‚ùå ERROR: Elemento buildingAssetsBody no encontrado en el DOM');
      return;
    }
    
    // VALIDACI√ìN 2: activos es un array
    if (!Array.isArray(activos)) {
      console.error('‚ùå ERROR: activos no es un array:', activos);
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-danger py-4">
            <i class="bi bi-bug fs-4 d-block mb-2"></i>
            Error: Datos corruptos (tipo: ${typeof activos})
          </td>
        </tr>
      `;
      return;
    }
    
    // VALIDACI√ìN 3: Array vac√≠o
    if (activos.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-muted fst-italic py-5">
            <i class="bi bi-inbox fs-1 d-block mb-3 text-secondary"></i>
            <strong>No hay activos instalados en este edificio</strong>
            <div class="small mt-2">Puedes a√±adirlos desde la secci√≥n "Activos" del men√∫</div>
          </td>
        </tr>
      `;
      return;
    }
    
    console.log(`üé® Renderizando ${activos.length} activos`);
    
    // Construir HTML
    let html = '';
    activos.forEach((a, index) => {
      // VALIDACI√ìN 4: Cada activo tiene las propiedades m√≠nimas
      const id = a.id || '';
      const nombre = a.nombre || 'Sin nombre';
      const tipo = a.tipo || 'Sin tipo';
      const marca = a.marca || '-';
      
      // Advertencia si falta el ID
      if (!id) {
        console.warn('‚ö†Ô∏è Activo sin ID en posici√≥n ' + index + ':', a);
      }
      
      html += `
        <tr class="fade-in" style="animation-delay: ${index * 0.02}s">
          <td class="ps-3">
            <i class="bi bi-box-seam text-primary me-2"></i>
            <strong>${nombre}</strong>
          </td>
          <td><span class="badge bg-light text-dark border">${tipo}</span></td>
          <td>${marca}</td>
          <td class="text-end pe-3">
            <button 
              class="btn btn-sm btn-outline-primary" 
              onclick="openAssetDetail('${id}')" 
              ${!id ? 'disabled title="ID no disponible"' : ''}>
              <i class="bi bi-arrow-right-circle"></i> Ver Ficha
            </button>
          </td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
    
    console.log('‚úÖ Renderizado completado exitosamente');
    
    // Aplicar seguridad de permisos
    if (typeof refreshSecurityIcons === 'function') {
      refreshSecurityIcons();
    }
  }

  // CONFIG & USERS
  function loadConfigList() { 
    const t = document.getElementById('tableConfigBody'); 
    t.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary spinner-border-sm"></div> Cargando...</td></tr>'; 
    google.script.run.withSuccessHandler(l => { 
      let h = ''; 
      l.forEach(i => h += `<tr><td class="ps-4 fw-bold">${i.nombre}</td><td><span class="badge bg-light text-dark border">${i.normativa||'-'}</span></td><td>${i.dias} d√≠as</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border me-1" onclick="openConfigModal('${i.id}','${i.nombre}','${i.normativa}','${i.dias}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('${i.id}')"><i class="bi bi-trash"></i></button></td></tr>`); 
      t.innerHTML = h || '<tr><td colspan="4" class="text-center text-muted">Sin datos</td></tr>';
      refreshSecurityIcons(); 
    }).getConfigCatalogo(); 
  }
  function openConfigModal(id,n,nm,d) { if(!configModal) configModal=new bootstrap.Modal(document.getElementById('configModal')); document.getElementById('confId').value=id||''; document.getElementById('confNombre').value=n||''; document.getElementById('confNorma').value=nm||''; document.getElementById('confDias').value=d||''; configModal.show(); }
  function submitConfig() { const id=document.getElementById('confId').value, n=document.getElementById('confNombre').value; if(!n) return; setBtnLoading('btnConfigSubmit',true); const cb=(r)=>{ setBtnLoading('btnConfigSubmit',false); if(r.success){ configModal.hide(); loadConfigList(); }}; const p={id:id, nombre:n, normativa:document.getElementById('confNorma').value, dias:document.getElementById('confDias').value}; google.script.run.withSuccessHandler(cb).saveConfigCatalogo(p); }
  function deleteConfig(id) { confirmarAccion("¬øBorrar?","",()=>google.script.run.withSuccessHandler(()=>loadConfigList()).deleteConfigCatalogo(id)); }
  function loadUserList() { 
    const t = document.getElementById('tableUsersBody'); 
    t.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary spinner-border-sm"></div> Cargando...</td></tr>'; 
    google.script.run.withSuccessHandler(l => { 
      let h = ''; 
      l.forEach(u => { 
        // Recuperado Badges de colores para Roles
        let rolBadge = u.rol === 'ADMIN' ? 'bg-danger' : (u.rol === 'TECNICO' ? 'bg-primary' : 'bg-secondary');
        let iconAvisos = u.avisos === 'SI' ? '<i class="bi bi-bell-fill text-warning"></i>' : '<i class="bi bi-bell-slash text-muted"></i>';
        
        h += `<tr><td class="ps-4 fw-bold">${u.nombre}</td><td>${u.email}</td><td><span class="badge ${rolBadge}">${u.rol}</span></td><td class="text-center fs-5">${iconAvisos}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border me-1" onclick="openUserModal('${u.id}','${u.nombre}','${u.email}','${u.rol}','${u.avisos}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.id}')"><i class="bi bi-trash"></i></button></td></tr>`; 
      }); 
      t.innerHTML = h || '<tr><td colspan="5" class="text-center text-muted">Sin usuarios</td></tr>';
      refreshSecurityIcons(); 
    }).getListaUsuarios(); 
  }
  function openUserModal(id,n,e,r,a) { if(!userModal) userModal=new bootstrap.Modal(document.getElementById('userModal')); document.getElementById('userId').value=id||''; document.getElementById('userNombre').value=n||''; document.getElementById('userEmail').value=e||''; document.getElementById('userRol').value=r||'TECNICO'; document.getElementById('userAvisos').value=a||'NO'; userModal.show(); }
  function submitUser() { const id=document.getElementById('userId').value, n=document.getElementById('userNombre').value, e=document.getElementById('userEmail').value; if(!n||!e) return; mostrarCargando(); const cb=(r)=>{ if(userModal) userModal.hide(); if(r.success){ notificarExito("Guardado"); loadUserList(); } else notificarError(r.error); }; const p={id:id, nombre:n, email:e, rol:document.getElementById('userRol').value, avisos:document.getElementById('userAvisos').value}; google.script.run.withSuccessHandler(cb).saveUsuario(p); }
  function deleteUser(id) { confirmarAccion("¬øBorrar?","",()=>google.script.run.withSuccessHandler(()=>loadUserList()).deleteUsuario(id)); }

  // INCIDENCIAS
  function loadIncidencias() { 
    const tbody = document.getElementById('tableIncidenciasBody'); 
    // Recuperado Spinner
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-danger spinner-border-sm"></div> Cargando incidencias...</td></tr>'; 
    google.script.run.withSuccessHandler(l => { 
      globalIncidencias = l; 
      renderIncidencias(l); 
    }).getIncidencias(); 
  }
  function filterIncidencias(s,b) { if(b){ b.parentElement.querySelectorAll('button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); } renderIncidencias(s==='all'?globalIncidencias:globalIncidencias.filter(i=>i.estado===s)); }

  function renderIncidencias(l) { 
    const t = document.getElementById('tableIncidenciasBody'); 
    if (!l.length) { 
      t.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No hay incidencias registradas.</td></tr>'; 
      return; 
    } 
    
    let h = ''; 
    l.forEach(i => { 
      // Recuperado Colores de Estado
      let c = i.estado === 'RESUELTA' ? 'bg-success' : (i.estado === 'EN PROCESO' ? 'bg-primary' : 'bg-danger'); 
      // Recuperado: Color Rojo para Urgentes
      let prioClass = (i.prioridad === 'URGENTE' || i.prioridad === 'ALTA') ? 'text-danger fw-bold' : 'text-dark';
      
      let fotoBtn = i.urlFoto ? `<a href="${i.urlFoto}" target="_blank" class="btn btn-sm btn-outline-secondary ms-1" title="Ver Foto"><i class="bi bi-image"></i></a>` : ''; 
      let actions = i.estado !== 'RESUELTA' 
        ? `<div class="btn-group"><button class="btn btn-sm btn-light border" onclick="editIncidencia('${i.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-primary" onclick="updateIncidencia('${i.id}','EN PROCESO')" title="En Proceso"><i class="bi bi-play-fill"></i></button><button class="btn btn-sm btn-success" onclick="updateIncidencia('${i.id}','RESUELTA')" title="Resolver"><i class="bi bi-check-lg"></i></button></div>` 
        : '<span class="text-success small"><i class="bi bi-check-circle"></i> Cerrada</span>';

      h += `<tr>
        <td class="ps-4"><span class="badge ${c}">${i.estado}</span></td>
        <td class="${prioClass}">${i.prioridad}</td>
        <td>
          <div class="fw-bold">${i.nombreOrigen}</div>
          <small class="text-muted">${i.tipoOrigen}</small>
        </td>
        <td>${i.descripcion} ${fotoBtn}</td>
        <td>
          <div class="small">${i.fecha}</div>
          <small class="text-muted text-truncate" style="max-width:150px;">${i.solicitante}</small>
        </td>
        <td class="text-end pe-4">${actions}</td>
      </tr>`; 
    }); 
    t.innerHTML = h; 
    refreshSecurityIcons(); 
  }

  function updateIncidencia(id,s) { confirmarAccion("¬øActualizar?","",()=>google.script.run.withSuccessHandler(()=>loadIncidencias()).actualizarEstadoIncidencia(id,s)); }
  function openReportModal() { if(!reportModal) reportModal=new bootstrap.Modal(document.getElementById('reportModal')); document.getElementById('repId').value=''; document.getElementById('repDesc').value=''; const s=document.getElementById('repCampus'); if(s.options.length<=1) populateSelectsIniciales([],[]); reportModal.show(); }
  function editIncidencia(id) { if(!reportModal) reportModal=new bootstrap.Modal(document.getElementById('reportModal')); reportModal.show(); document.getElementById('repLoadingOverlay').classList.remove('d-none'); document.getElementById('repId').value=id; google.script.run.withSuccessHandler(d=>{ document.getElementById('repDesc').value=d.descripcion; document.getElementById('repPrio').value=d.prioridad; document.getElementById('repLoadingOverlay').classList.add('d-none'); }).getIncidenciaDetalle(id); }
  function loadEdificiosReport(idC) { const s=document.getElementById('repEdificio'); s.disabled=true; s.innerHTML='...'; google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Edificio -</option>'; l.forEach(e=>h+=`<option value="${e.id}">${e.nombre}</option>`); s.innerHTML=h; s.disabled=false; }).getEdificiosPorCampus(idC); }
  function loadActivosReport(idE) { const s=document.getElementById('repActivo'); s.disabled=true; s.innerHTML='...'; google.script.run.withSuccessHandler(l=>{ let h='<option value="">- Activo -</option>'; l.forEach(a=>h+=`<option value="${a.id}">${a.nombre}</option>`); s.innerHTML=h; s.disabled=false; }).getActivosPorEdificio(idE); }
  function previewReportImage() { const f=document.getElementById('repFoto').files[0]; if(f){ const r=new FileReader(); r.onload=e=>{ document.getElementById('imgPreview').src=e.target.result; document.getElementById('repFotoPreview').classList.remove('d-none'); }; r.readAsDataURL(f); } }
  function clearReportImage() { document.getElementById('repFoto').value=''; document.getElementById('repFotoPreview').classList.add('d-none'); }
  function submitReport() { 
      const id = document.getElementById('repId').value;
      const desc = document.getElementById('repDesc').value;
      const prio = document.getElementById('repPrio').value;
      
      // Obtenemos valores de los 3 niveles
      const valCampus = document.getElementById('repCampus').value;
      const valEdificio = document.getElementById('repEdificio').value;
      const valActivo = document.getElementById('repActivo').value;

      // L√ìGICA DE ORIGEN (Cascada inversa)
      let idOrigen = null;
      let tipoOrigen = null;
      let nombreOrigen = ""; 

      if (valActivo && valActivo !== "") {
          idOrigen = valActivo;
          tipoOrigen = 'ACTIVO';
          const sel = document.getElementById('repActivo');
          // Protecci√≥n extra: si el select est√° disabled o es "dummy", intentamos coger el texto
          if (sel.selectedIndex >= 0) {
             nombreOrigen = sel.options[sel.selectedIndex].text;
          } else {
             // Fallback si venimos del m√≥vil y hemos inyectado el HTML a mano
             nombreOrigen = sel.innerText || "Activo QR";
          }
      } 
      else if (valEdificio && valEdificio !== "") {
          idOrigen = valEdificio;
          tipoOrigen = 'EDIFICIO';
      } 
      else if (valCampus && valCampus !== "" && valCampus !== "Detectado por QR") { 
          idOrigen = valCampus;
          tipoOrigen = 'CAMPUS';
      }

      if (!idOrigen) return notificarError("Debes indicar la ubicaci√≥n o activo.");

      // Enviar
      setBtnLoading('btnReportSubmit', true);
      
      const payload = {
          id: id, 
          descripcion: desc, 
          prioridad: prio, 
          tipoOrigen: tipoOrigen, 
          idOrigen: idOrigen,
          nombreOrigen: nombreOrigen,
          fotoBase64: null,
          nombreArchivo: null,
          mimeType: null
      };

      const fileInput = document.getElementById('repFoto');
      const file = (fileInput && fileInput.files.length > 0) ? fileInput.files[0] : null;

      // --- AQU√ç ESTABA EL ERROR (corregido 'r' por 'res') ---
      const finish = (res) => { 
          setBtnLoading('btnReportSubmit', false); 
          if (res.success) { // <--- CORREGIDO AQU√ç
              if(reportModal) reportModal.hide(); // Cerramos el modal
              notificarExito("Reporte enviado correctamente"); 
              
              // Limpiar formulario para la pr√≥xima
              document.getElementById('repDesc').value = "";
              document.getElementById('repFoto').value = "";
              clearReportImage();

              // Si estamos en vista de incidencias, recargar
              if(!document.getElementById('view-incidencias').classList.contains('d-none')) {
                  loadIncidencias(); 
              }
          } else { 
              notificarError(res.error); 
          } 
      };

      const sendToBackend = (data) => {
          if (id) google.script.run.withSuccessHandler(r => finish(r)).updateIncidenciaData(data);
          else google.script.run.withSuccessHandler(r => finish(r)).crearIncidencia(data);
      };

      if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
              payload.fotoBase64 = e.target.result.split(',')[1];
              payload.nombreArchivo = file.name;
              payload.mimeType = file.type;
              sendToBackend(payload);
          };
          reader.readAsDataURL(file);
      } else {
          sendToBackend(payload);
      }
  }
  
  function openFeedbackModal() { if(!feedbackModal) feedbackModal=new bootstrap.Modal(document.getElementById('feedbackModal')); feedbackModal.show(); }
  function submitFeedback() { const t=document.getElementById('feedTipo').value, m=document.getElementById('feedMsg').value; if(!m) return; setBtnLoading('btnFeedSubmit',true); google.script.run.withSuccessHandler(r=>{ setBtnLoading('btnFeedSubmit',false); if(r.success){ feedbackModal.hide(); notificarExito("Enviado"); } }).enviarFeedback({tipo:t, mensaje:m}); }

  function loadFeedbackList() { 
    const container = document.getElementById('feedbackContainer'); 
    // Recuperado Spinner
    container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div> Cargando buz√≥n...</div>'; 
    
    google.script.run.withSuccessHandler(list => { 
      if (!list || list.length === 0) { 
        container.innerHTML = '<div class="col-12 text-center text-muted fst-italic py-5"><i class="bi bi-mailbox fs-1 d-block mb-3"></i>El buz√≥n est√° vac√≠o</div>'; 
        updateBadgeFeedback(0); 
        return; 
      } 

      let html = ''; 
      let unreadCount = 0;

      list.forEach(item => { 
        if (item.estado === 'NUEVO') unreadCount++;
        
        // Recuperado Estilos visuales (Nuevo vs Le√≠do)
        let cardBorder = item.estado === 'NUEVO' ? 'border-primary border-2' : 'border-light';
        let bgHeader = item.estado === 'NUEVO' ? 'bg-primary text-white' : 'bg-light text-muted';
        let iconTipo = item.tipo === 'Error' ? '<i class="bi bi-bug-fill"></i>' : '<i class="bi bi-lightbulb-fill"></i>';
        
        // Recuperado BOTONES DE ACCI√ìN (Archivar/Borrar)
        let buttons = '';
        if (item.estado !== 'ARCHIVADO') {
          buttons += `<button class="btn btn-sm btn-outline-secondary me-2" onclick="setFeedbackState('${item.id}', 'ARCHIVADO')"><i class="bi bi-check2-all"></i> Archivar</button>`;
        }
        buttons += `<button class="btn btn-sm btn-outline-danger" onclick="setFeedbackState('${item.id}', 'DELETE')"><i class="bi bi-trash"></i></button>`;

        html += `<div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100 shadow-sm ${cardBorder}">
            <div class="card-header ${bgHeader} d-flex justify-content-between align-items-center">
              <span class="fw-bold">${iconTipo} ${item.tipo}</span>
              <small style="font-size:0.75rem">${item.fecha}</small>
            </div>
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-primary small">${item.usuario}</h6>
              <p class="card-text bg-light p-2 rounded fst-italic">"${item.mensaje}"</p>
              <div class="mt-3 text-end pt-2 border-top">
                ${buttons}
              </div>
            </div>
          </div>
        </div>`; 
      }); 
      
      container.innerHTML = html; 
      updateBadgeFeedback(unreadCount); // Actualizar contador del men√∫
    }).getFeedbackList(); 
  }
  function setFeedbackState(id, s) { google.script.run.withSuccessHandler(()=>loadFeedbackList()).updateFeedbackStatus(id,s); }
  function updateBadgeFeedback(n) { const b=document.getElementById('badge-feedback'); if(b) { b.innerText=n; if(n>0) b.classList.remove('d-none'); else b.classList.add('d-none'); } }

  // SEARCH & MAP
  let searchTimeout=null;
  function handleGlobalSearch() { const t=document.getElementById('globalSearchInput').value; if(searchTimeout) clearTimeout(searchTimeout); if(t.length<3) { closeSearchResults(); return; } searchTimeout=setTimeout(()=>executeGlobalSearch(),300); }
  function executeGlobalSearch() { const t=document.getElementById('globalSearchInput').value; const c=document.getElementById('globalSearchResults'); c.classList.remove('d-none'); c.innerHTML='Buscando...'; google.script.run.withSuccessHandler(r=>{ let h=''; r.forEach(i=>h+=`<button class="list-group-item" onclick="goToResult('${i.id}','${i.tipo}')">${i.texto}</button>`); c.innerHTML=h||'Sin resultados'; }).buscarGlobal(t); }
  function closeSearchResults() { document.getElementById('globalSearchResults').classList.add('d-none'); }
  function goToResult(id, t) { closeSearchResults(); if(t==='ACTIVO') openAssetDetail(id); else openBuildingDetail(id); }
  function toggleSidebar() { const s=document.getElementById('sidebar'), o=document.getElementById('sidebarOverlay'); s.classList.toggle('active'); o.classList.toggle('active'); }
  
  function toggleEdificiosView(m) { const l=document.getElementById('container-edif-list'), map=document.getElementById('container-edif-map'); if(m==='LIST'){ l.classList.remove('d-none'); map.classList.add('d-none'); destroyMap(); } else { l.classList.add('d-none'); map.classList.remove('d-none'); setTimeout(()=>initLeafletMap(),100); } }
  function destroyMap() { if(mapInstance){ mapInstance.remove(); mapInstance=null; document.getElementById('mapEdificios').innerHTML=''; } }
  function initLeafletMap() { destroyMap(); if(typeof L==='undefined') return; mapInstance=L.map('mapEdificios').setView([40.416, -3.703],5); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mapInstance); renderMarkers(); }
  function renderMarkers(d) { const data=d||allEdificiosData; if(!mapInstance||!data) return; if(markersLayer) mapInstance.removeLayer(markersLayer); const g=L.featureGroup(); data.forEach(e=>{ const lat=parseFloat(String(e.lat).replace(',','.')), lng=parseFloat(String(e.lng).replace(',','.')); if(!isNaN(lat)&&!isNaN(lng)){ L.marker([lat,lng]).bindPopup(`<b>${e.nombre}</b><br><button onclick="openBuildingDetail('${e.id}')">Ver</button>`).addTo(g); } }); g.addTo(mapInstance); markersLayer=g; try{ mapInstance.fitBounds(g.getBounds().pad(0.2)); }catch(e){} }

  // CHANGELOG
  function openChangelogModal(e) { 
      // 1. Evitar recarga de p√°gina
      if(e) e.preventDefault(); 

      if(!changelogModal) changelogModal = new bootstrap.Modal(document.getElementById('changelogModal')); 
      
      // 2. L√≥gica para mostrar el bot√≥n "Nueva" solo si es ADMIN
      const btnNew = document.getElementById('btnNewVersion');
      if (currentUser && currentUser.rol === 'ADMIN') {
          btnNew.classList.remove('d-none');
      } else {
          btnNew.classList.add('d-none');
      }

      // 3. Mostrar carga y abrir
      document.getElementById('changelogContainer').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>'; 
      changelogModal.show(); 
      
      // 4. Cargar datos
      google.script.run.withSuccessHandler(l => { 
          let h = ''; 
          if (!l || l.length === 0) {
              h = '<div class="text-center text-muted">No hay novedades registradas.</div>';
          } else {
              l.forEach(i => {
                  let badgeClass = 'badge-secondary';
                  let icon = 'bi-info-circle';
                  
                  if(i.tipo === 'NUEVO') { badgeClass = 'badge-new'; icon = 'bi-stars'; }
                  if(i.tipo === 'MEJORA') { badgeClass = 'badge-improvement'; icon = 'bi-graph-up-arrow'; }
                  if(i.tipo === 'CORRECCION') { badgeClass = 'badge-fix'; icon = 'bi-bug'; }

                  h += `<div class="timeline-item">
                          <span class="timeline-dot"></span>
                          <div class="timeline-date">${i.fecha}</div>
                          <div class="timeline-title d-flex align-items-center gap-2">
                             ${i.titulo} 
                             <span class="badge ${badgeClass} border rounded-pill fw-normal" style="font-size:0.7rem">
                                <i class="bi ${icon} me-1"></i>${i.version}
                             </span>
                          </div>
                          <p class="timeline-desc">${i.descripcion}</p>
                        </div>`;
              });
          }
          document.getElementById('changelogContainer').innerHTML = h; 
      }).getNovedadesApp(); 
  }
  function openNewVersionModal() { if(changelogModal) changelogModal.hide(); if(!newVersionModal) newVersionModal=new bootstrap.Modal(document.getElementById('newVersionModal')); newVersionModal.show(); }
  function submitNewVersion() { const v=document.getElementById('nvVersion').value, t=document.getElementById('nvTitulo').value; if(!v) return; setBtnLoading('btnNvSubmit',true); google.script.run.withSuccessHandler(r=>{ setBtnLoading('btnNvSubmit',false); if(r.success){ newVersionModal.hide(); notificarExito("Publicado"); } }).crearNovedad({version:v, titulo:t, descripcion:document.getElementById('nvDesc').value, tipo:document.getElementById('nvTipo').value}); }

  // QR
  function descargarQRActivo() { if(!currentAssetId) return; notificar("Generando..."); google.script.run.withSuccessHandler(r=>{ if(r.success) Swal.fire({title:r.activo.nombre, html:`<img src="${r.qrUrl}" style="width:200px">`, confirmButtonText:'Cerrar'}); else notificarError(r.error); }).generarQRActivo(currentAssetId); }
  function descargarQRsEdificio() { if(!currentBuildingId) return; notificar("Generando PDF..."); google.script.run.withSuccessHandler(r=>{ if(r.success) { const l=document.createElement('a'); l.href='data:application/pdf;base64,'+r.base64; l.download=r.filename; l.click(); } else notificarError(r.error); }).generarPDFEtiquetasQR(currentBuildingId); }
  // Detecci√≥n inteligente de acceso (Escritorio vs M√≥vil)
  function detectingAccesoQR() {
    const p = new URLSearchParams(window.location.search);
    const id = p.get('activo') || (window.serverParams && window.serverParams.activo);
    
    if (id) {
      // Si la pantalla es menor a 768px, asumimos m√≥vil/tablet en campo
      if (window.innerWidth < 768) {
        loadMobileAssetView(id);
      } else {
        // Escritorio: abrir vista completa normal
        setTimeout(() => openAssetDetail(id), 1500);
      }
    }
  }
  window.addEventListener('load', detectingAccesoQR);

  // RELACIONES
  function loadRelacionesActivo() { 
    if(!currentAssetId) return; 
    document.getElementById('relacionesContainer').innerHTML='<div class="text-center py-4"><div class="spinner-border text-primary spinner-border-sm"></div> Cargando ecosistema...</div>'; 
    google.script.run.withSuccessHandler(d => renderRelaciones(d.relaciones, d.alertas)).obtenerDatosRelaciones(currentAssetId); 
  }
  function renderRelaciones(relaciones, alertas) { 
    const container = document.getElementById('relacionesContainer');
    let html = '';

    // 1. MOSTRAR ALERTAS (Si hay activos relacionados con incidencias)
    if (alertas && alertas.length > 0) {
      html += '<div class="alert alert-warning border-warning shadow-sm mb-4">';
      html += '<h6 class="alert-heading fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>Atenci√≥n: Problemas en cadena</h6>';
      html += '<ul class="mb-0 ps-3 small">';
      alertas.forEach(a => {
        html += `<li>El activo <strong>${a.nombreActivo}</strong> (${formatearTipoRelacion(a.tipoRelacion)}) tiene una incidencia: <span class="fw-bold">${a.problema}</span> <span class="badge bg-danger">${a.prioridad}</span></li>`;
      });
      html += '</ul></div>';
    }

    // 2. LISTA DE RELACIONES
    if (!relaciones || relaciones.length === 0) {
      html += `
        <div class="text-center text-muted py-5 border rounded bg-light">
          <i class="bi bi-diagram-3 fs-1 d-block mb-2 text-secondary"></i>
          <p class="mb-0">Este activo no tiene relaciones definidas.</p>
          <small>Conecta este activo con otros (ej. cuadros el√©ctricos, bombas...) para trazar aver√≠as.</small>
        </div>
      `;
    } else {
      html += '<div class="list-group shadow-sm">';
      
      relaciones.forEach(rel => {
        const icono = obtenerIconoRelacion(rel.tipoRelacion);
        const colorBadge = obtenerColorRelacion(rel.tipoRelacion);
        const nombreRel = formatearTipoRelacion(rel.tipoRelacion);

        html += `
          <div class="list-group-item list-group-item-action p-3 border-start-0 border-end-0">
            <div class="d-flex justify-content-between align-items-center">
              
              <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border" style="width: 45px; height: 45px; font-size: 1.2rem;">
                  ${icono}
                </div>
                <div>
                  <h6 class="mb-0 fw-bold text-primary">${rel.nombreActivo}</h6>
                  <div class="d-flex align-items-center gap-2 mt-1">
                    <span class="badge ${colorBadge} fw-normal">${nombreRel}</span>
                    <span class="text-muted small border-start ps-2">${rel.tipoActivo}</span>
                  </div>
                  ${rel.descripcion ? `<div class="small text-muted fst-italic mt-1"><i class="bi bi-chat-left-text me-1"></i>${rel.descripcion}</div>` : ''}
                </div>
              </div>

              <div class="btn-group">
                <button class="btn btn-outline-primary btn-sm" onclick="openAssetDetail('${rel.idActivoRelacionado}')" title="Ir a ficha del activo">
                  <i class="bi bi-box-arrow-in-up-right"></i> Ver
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="eliminarRelacion('${rel.id}')" title="Romper relaci√≥n">
                  <i class="bi bi-link-45deg"></i> Romper
                </button>
              </div>

            </div>
          </div>
        `;
      });
      html += '</div>';
    }
    
    container.innerHTML = html;
  }
  function openRelacionModal() { 
    if(!currentAssetId) return notificarError("No hay activo seleccionado"); 
    if(!relacionModal) relacionModal=new bootstrap.Modal(document.getElementById('relacionModal')); 
    // Resetear form
    document.getElementById('relResultados').innerHTML=''; 
    document.getElementById('relSearchInput').value=''; 
    document.getElementById('relActivoSeleccionado').innerHTML='<div class="text-muted small fst-italic">Busca y selecciona un activo arriba</div>';
    activoSelId = null;
    relacionModal.show(); 
  }
  function buscarActivosRelacion() { 
    const t=document.getElementById('relSearchInput').value; 
    if(t.length<3) return; 
    document.getElementById('relResultados').innerHTML = '<div class="spinner-border spinner-border-sm text-secondary"></div>';
    
    google.script.run.withSuccessHandler(l => { 
      let h=''; 
      if(!l.length) h='<small class="text-muted">Sin coincidencias</small>';
      else l.forEach(a => h+=`<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="seleccionarActivoRelacion('${a.id}','${a.nombre}','${a.tipo}','${a.edificio}')"><div><strong>${a.nombre}</strong><br><small class="text-muted">${a.tipo}</small></div><span class="badge bg-light text-dark">${a.edificio}</span></button>`); 
      document.getElementById('relResultados').innerHTML=h; 
    }).buscarActivosParaRelacionar(currentAssetId, t); 
  }
  let activoSelId=null; 
  
  function seleccionarActivoRelacion(id,n,t,e){ 
    activoSelId=id; 
    document.getElementById('relActivoSeleccionado').innerHTML=`<div class="alert alert-success mb-0 border-success"><i class="bi bi-check-circle-fill me-2"></i><strong>${n}</strong> <span class="small text-muted">(${t})</span></div>`; 
    document.getElementById('relResultados').innerHTML = ''; // Limpiar b√∫squeda para que quede limpio
  }

  function submitRelacion() { 
    if(!activoSelId) return notificarError("Selecciona un activo primero"); 
    setBtnLoading('btnRelSubmit',true); 
    google.script.run.withSuccessHandler(r=>{ 
      setBtnLoading('btnRelSubmit',false); 
      if(r.success){ relacionModal.hide(); loadRelacionesActivo(); notificarExito("Vinculaci√≥n creada"); } 
      else notificarError(r.error); 
    }).crearRelacionActivo({
      idActivoA:currentAssetId, 
      idActivoB:activoSelId, 
      tipoRelacion:document.getElementById('relTipoRelacion').value, 
      descripcion:document.getElementById('relDescripcion').value, // Aseg√∫rate de que este ID existe en el HTML del modal
      bidireccional:document.getElementById('relBidireccional').checked
    }); 
  }

  function eliminarRelacion(id) { 
    confirmarAccion("¬øRomper v√≠nculo?", "No se borrar√°n los activos, solo la relaci√≥n.", () => 
      google.script.run.withSuccessHandler(() => { 
        notificarExito("Relaci√≥n eliminada"); 
        loadRelacionesActivo(); 
      }).eliminarRelacionActivo(currentAssetId, id)
    ); 
  }

  // PLANNER
  function initPlannerCalendar() {
    const el = document.getElementById('plannerCalendar');
    
    // Si ya existe, solo renderizamos y cargamos si est√° vac√≠o
    if (plannerCalendar) {
      plannerCalendar.render();
      // Forzamos actualizaci√≥n de tama√±o por si estaba oculto
      plannerCalendar.updateSize(); 
      if (!allPlannerEvents.length) loadPlannerEvents();
      return;
    }

    plannerCalendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: 'es',
      height: 'auto',
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' },
      editable: true,       // Permite Drag & Drop
      droppable: true,
      eventResizableFromStart: false, // Simplificamos resize

      // CLIC EN EVENTO
      eventClick: i => {
        const p = i.event.extendedProps;
        if (p.tipo === 'MANTENIMIENTO') {
          // Abrir modal de revisi√≥n
          editRevision(i.event.id, i.event.title.split('-')[0].trim(), i.event.startStr, null, false);
        } else if (p.tipo === 'CONTRATO') {
          // Abrir modal de contrato
          editContractGlobal(i.event.id);
        } else if (p.tipo === 'INCIDENCIA') {
          editIncidencia(i.event.id);
        } else {
          // Obra u otros
          Swal.fire({ title: i.event.title, text: p.descripcion, icon: 'info' });
        }
      },

      // ARRASTRAR Y SOLTAR (L√≥gica mejorada)
      eventDrop: i => {
        const p = i.event.extendedProps;
        
        // Si no es editable, revertimos
        if (!p.editable) { i.revert(); return; }

        // Feedback visual inmediato
        const originalTitle = i.event.title;
        // i.event.setProp('title', '‚è≥ Guardando...'); // Opcional: cambiar t√≠tulo mientras guarda

        google.script.run
          .withSuccessHandler(res => {
            if (res.success) {
              notificarExito("Fecha actualizada");
              // i.event.setProp('title', originalTitle); // Restaurar t√≠tulo
              
              // Si movimos un contrato, ser√≠a ideal recargar la lista de contratos en segundo plano
              if (p.tipo === 'CONTRATO' && !document.getElementById('view-contratos').classList.contains('d-none')) {
                  loadGlobalContracts();
              }
            } else {
              i.revert(); // Volver atr√°s si falla
              notificarError(res.error);
            }
          })
          .withFailureHandler(err => {
            i.revert();
            notificarError("Error de conexi√≥n");
          })
          .updateEventDate(i.event.id, p.tipo, i.event.startStr);
      }
    });

    plannerCalendar.render();
    loadPlannerEvents();
  }

  function loadPlannerEvents() {
    // Feedback sutil en el t√≠tulo
    const title = document.querySelector('#view-planner .page-title');
    const og = title.innerText;
    title.innerHTML = og + ' <span class="spinner-border spinner-border-sm text-secondary"></span>';

    google.script.run.withSuccessHandler(e => {
      title.innerText = "Planificador de Trabajo";
      allPlannerEvents = e;
      filterPlanner();
    }).getPlannerEvents();
  }

  function filterPlanner() {
    if (!plannerCalendar) return;
    
    // Lectura segura de los checkboxes (si no existen, asumen true para no romper nada)
    const elMant = document.getElementById('chkShowMant');
    const m = elMant ? elMant.checked : true;
    
    const elObras = document.getElementById('chkShowObras');
    const o = elObras ? elObras.checked : true;
    
    const elInc = document.getElementById('chkShowInc');
    const i = elInc ? elInc.checked : true;
    
    const elCont = document.getElementById('chkShowCont');
    const c = elCont ? elCont.checked : true; // Si no encuentra el bot√≥n, muestra contratos por defecto

    const f = allPlannerEvents.filter(e => {
      const tipo = e.extendedProps.tipo;
      if (tipo === 'MANTENIMIENTO' && !m) return false;
      if (tipo === 'OBRA' && !o) return false;
      if (tipo === 'INCIDENCIA' && !i) return false;
      if (tipo === 'CONTRATO' && !c) return false;
      return true;
    });

    plannerCalendar.removeAllEvents();
    plannerCalendar.addEventSource(f);
  }

  // AUDIT
  function loadAuditYears() { const s=document.getElementById('auditYear'); s.innerHTML='Loading...'; google.script.run.withSuccessHandler(l=>{ let h=''; l.forEach(y=>h+=`<option value="${y}">${y}</option>`); s.innerHTML=h; }).getAniosAuditoria(); }
  function runAudit() { const y=document.getElementById('auditYear').value; if(!y) return; setBtnLoading('btnAuditRun',true); google.script.run.withSuccessHandler(r=>{ setBtnLoading('btnAuditRun',false); if(r.success){ document.getElementById('auditResult').classList.remove('d-none'); document.getElementById('auditMsg').innerText=r.total; document.getElementById('auditLink').href=r.url; } else notificarError(r.error); }).generarPaqueteAuditoria(y, document.getElementById('auditType').value); }

  // ==========================================
  // SUBIDA R√ÅPIDA (QUICK UPLOAD)
  // ==========================================
  let quickUploadModalInstance = null;
  let quickUploadFiles = []; // Almacena los archivos seleccionados

  function openQuickUpload(idActivo) {
    if (!quickUploadModalInstance) quickUploadModalInstance = new bootstrap.Modal(document.getElementById('quickUploadModal'));
    
    // Resetear formulario
    document.getElementById('quIdActivo').value = idActivo;
    document.getElementById('quFiles').value = '';
    document.getElementById('quFileListContainer').classList.add('d-none');
    document.getElementById('quTableBody').innerHTML = '';
    document.getElementById('btnQuickUpload').disabled = true;
    quickUploadFiles = [];

    quickUploadModalInstance.show();
  }

  function renderQuickUploadList() {
    const input = document.getElementById('quFiles');
    const tbody = document.getElementById('quTableBody');
    const container = document.getElementById('quFileListContainer');
    const btn = document.getElementById('btnQuickUpload');

    if (input.files.length > 0) {
      container.classList.remove('d-none');
      btn.disabled = false;
      quickUploadFiles = Array.from(input.files);
      
      let html = '';
      const hoyISO = new Date().toISOString().split('T')[0];

      quickUploadFiles.forEach((file, index) => {
        let defaultSel = 'GENERAL';
        const name = file.name.toLowerCase();
        if (name.includes('oca') || name.includes('inspeccion') || name.includes('legal')) defaultSel = 'OCA';
        if (name.includes('contrato') || name.includes('mantenimiento')) defaultSel = 'CONTRATO';

        html += `
          <tr id="qu-row-${index}">
            <td class="ps-3 align-top pt-3">
              <div class="text-truncate" style="max-width: 200px;" title="${file.name}">
                <i class="bi bi-file-earmark text-muted"></i> <strong>${file.name}</strong>
              </div>
            </td>
            <td class="align-top pt-2">
              <select class="form-select form-select-sm qu-type-select mb-2" data-index="${index}" onchange="toggleExtraFields(${index})">
                <option value="GENERAL" ${defaultSel==='GENERAL'?'selected':''}>üìÑ Doc. General</option>
                <option value="OCA" ${defaultSel==='OCA'?'selected':''}>üõ°Ô∏è OCA / Legalizaci√≥n</option>
                <option value="CONTRATO" ${defaultSel==='CONTRATO'?'selected':''}>üìë Contrato Mant.</option>
              </select>

              <div id="qu-extra-oca-${index}" class="${defaultSel==='OCA'?'':'d-none'} bg-light p-2 rounded border small mb-2">
                <div class="mb-2">
                  <label class="form-label mb-0 fw-bold text-muted" style="font-size:0.75rem">Fecha Inspecci√≥n:</label>
                  <input type="date" class="form-control form-control-sm qu-date" value="${hoyISO}">
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="chk-recur-${index}" onchange="toggleFreq(${index})">
                  <label class="form-check-label" for="chk-recur-${index}">Programar siguientes</label>
                </div>
                <div id="div-freq-${index}" class="mt-1 d-none d-flex align-items-center gap-2">
                  <span class="text-muted">Cada</span>
                  <input type="number" class="form-control form-control-sm qu-freq" style="width:100px" value="365">
                  <span class="text-muted">d√≠as</span>
                </div>
              </div>

              <div id="qu-extra-cont-${index}" class="${defaultSel==='CONTRATO'?'':'d-none'} bg-light p-2 rounded border small">
                <div class="mb-2">
                  <input type="text" class="form-control form-control-sm mb-1 qu-prov" placeholder="Proveedor (Ej. Elecnor)">
                  <input type="text" class="form-control form-control-sm qu-ref" placeholder="Referencia / N¬∫">
                </div>
                <div class="d-flex gap-2">
                  <div class="w-50">
                    <label class="form-label mb-0 fw-bold text-muted" style="font-size:0.65rem">Inicio</label>
                    <input type="date" class="form-control form-control-sm qu-ini" value="${hoyISO}">
                  </div>
                  <div class="w-50">
                    <label class="form-label mb-0 fw-bold text-muted" style="font-size:0.65rem">Fin</label>
                    <input type="date" class="form-control form-control-sm qu-fin">
                  </div>
                </div>
              </div>

            </td>
            <td class="text-center align-middle" id="qu-status-${index}">
              <span class="text-muted"><i class="bi bi-hourglass"></i></span>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    } else {
      container.classList.add('d-none');
      btn.disabled = true;
    }
  }

  // Funciones visuales para mostrar/ocultar los campos extra
  function toggleExtraFields(index) {
    const sel = document.querySelector(`.qu-type-select[data-index="${index}"]`);
    const boxOCA = document.getElementById(`qu-extra-oca-${index}`);
    const boxCont = document.getElementById(`qu-extra-cont-${index}`);
    
    boxOCA.classList.add('d-none');
    boxCont.classList.add('d-none');
    
    if (sel.value === 'OCA') boxOCA.classList.remove('d-none');
    if (sel.value === 'CONTRATO') boxCont.classList.remove('d-none');
  }

  function toggleFreq(index) {
    const chk = document.getElementById(`chk-recur-${index}`);
    const div = document.getElementById(`div-freq-${index}`);
    if (chk.checked) div.classList.remove('d-none');
    else div.classList.add('d-none');
  }

  async function startQuickUpload() {
    const idActivo = document.getElementById('quIdActivo').value;
    const btn = document.getElementById('btnQuickUpload');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

    for (let i = 0; i < quickUploadFiles.length; i++) {
      const file = quickUploadFiles[i];
      const row = document.getElementById(`qu-row-${i}`);
      const select = row.querySelector('.qu-type-select');
      const categoria = select.value;
      const statusCell = document.getElementById(`qu-status-${i}`);

      // Recogemos todos los datos posibles
      const payload = {
        idActivo: idActivo,
        nombreArchivo: file.name,
        mimeType: file.type,
        categoria: categoria,
        // Datos OCA
        fechaOCA: row.querySelector('.qu-date').value,
        crearSiguientes: row.querySelector(`#chk-recur-${i}`).checked,
        freqDias: row.querySelector('.qu-freq').value,
        // Datos Contrato
        contProveedor: row.querySelector('.qu-prov').value,
        contRef: row.querySelector('.qu-ref').value,
        contIni: row.querySelector('.qu-ini').value,
        contFin: row.querySelector('.qu-fin').value
      };

      statusCell.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div>';

      try {
        payload.base64 = await readFileAsBase64(file);
        await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(res => res.success ? resolve(res) : reject(new Error(res.error)))
            .withFailureHandler(err => reject(err))
            .procesarArchivoRapido(payload);
        });
        statusCell.innerHTML = '<i class="bi bi-check-circle-fill text-success fs-5"></i>';
      } catch (err) {
        console.error(err);
        statusCell.innerHTML = '<i class="bi bi-x-circle-fill text-danger fs-5" title="Error"></i>';
      }
    }

    btn.innerHTML = '<i class="bi bi-check-all"></i> Terminado';
    setTimeout(() => {
        quickUploadModalInstance.hide();
        notificarExito("Proceso finalizado");
        
        // Recarga inteligente seg√∫n la vista
        if (!document.getElementById('view-activos').classList.contains('d-none')) {
            loadAllAssets(true);
            // Si tenemos el detalle abierto, recargar sus pesta√±as
            if (currentAssetId) { loadContracts(); loadDocs(); } 
        } else if (!document.getElementById('view-mantenimiento').classList.contains('d-none')) {
            loadGlobalMaint();
        }
    }, 1000);
  }

  // Helper para convertir FileReader a Promesa (necesario para async/await)
  function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
    });
  }

  // ==========================================
  // 28. L√ìGICA VISTA M√ìVIL (QR)
  // ==========================================
  
  let currentMobileId = null;

  function loadMobileAssetView(id) {
    currentMobileId = id;
    currentAssetId = id; // Sincronizamos con la variable global por si acaso
    
    // Ocultar sidebar y mostrar loader
    const sidebar = document.getElementById('sidebar');
    if (sidebar) sidebar.style.display = 'none'; // Ocultar sidebar completamente en modo m√≥vil puro
    document.querySelector('.mobile-header').style.display = 'none'; // Ocultar header normal
    
    // Mostrar vista
    document.querySelectorAll('.view-section').forEach(e => e.classList.add('d-none'));
    const view = document.getElementById('view-mobile-qr');
    view.classList.remove('d-none');
    
    // Feedback de carga
    document.getElementById('mob-asset-name').innerText = 'Cargando...';
    
    // Llamada al backend (Reutilizamos getActivoByQR que ya ten√≠as en Code.gs)
    google.script.run.withSuccessHandler(data => {
      if (!data.success) {
        notificarError(data.error);
        return;
      }
      renderMobileData(data);
    }).getActivoByQR(id);
  }

  function renderMobileData(d) {
    const a = d.activo;
    
    // 1. Datos B√°sicos
    document.getElementById('mob-asset-name').innerText = a.nombre;
    document.getElementById('mob-asset-type').innerText = a.tipo;
    document.getElementById('mob-asset-brand').innerText = a.marca || '-';
    document.getElementById('mob-asset-loc').innerHTML = `<i class="bi bi-geo-alt-fill text-danger"></i> ${a.edificio} <br><small>${a.campus}</small>`;

    // 2. √öltima Revisi√≥n (Estado)
    const cardStatus = document.getElementById('mob-card-status');
    const iconStatus = document.getElementById('mob-status-icon');
    const lastRev = d.revisiones.length > 0 ? d.revisiones[0] : null;

    if (lastRev) {
      document.getElementById('mob-last-rev-date').innerText = lastRev.fecha;
      document.getElementById('mob-last-rev-type').innerText = lastRev.tipo;
      
      // L√≥gica visual simple
      if (lastRev.estado === 'REALIZADA') {
         cardStatus.className = "card border-start border-5 border-success shadow-sm";
         iconStatus.className = "bi bi-check-circle-fill text-success fs-1";
      } else {
         // Si la √∫ltima que sale est√° pendiente...
         cardStatus.className = "card border-start border-5 border-warning shadow-sm";
         iconStatus.className = "bi bi-exclamation-circle-fill text-warning fs-1";
      }
    } else {
      document.getElementById('mob-last-rev-date').innerText = "Sin datos";
      document.getElementById('mob-last-rev-type').innerText = "Nunca revisado";
      cardStatus.className = "card border-start border-5 border-secondary shadow-sm";
      iconStatus.className = "bi bi-question-circle-fill text-secondary fs-1";
    }

    // 3. Incidencias Abiertas
    const incBox = document.getElementById('mob-incidencias-container');
    const incList = document.getElementById('mob-incidencias-list');
    incList.innerHTML = '';
    
    const abiertas = d.incidencias.filter(i => i.estado !== 'RESUELTA');
    
    if (abiertas.length > 0) {
      incBox.classList.remove('d-none');
      abiertas.forEach(i => {
        incList.innerHTML += `<li class="mb-2 border-bottom pb-1"><strong>${i.fecha}</strong>: ${i.descripcion} <span class="badge bg-danger">${i.prioridad}</span></li>`;
      });
    } else {
      incBox.classList.add('d-none');
    }
  }

// --- ACCIONES DE LOS BOTONES M√ìVILES (OPTIMIZADAS CON FEEDBACK) ---

  // Helper para mostrar carga en el bot√≥n pulsado
  function setMobBtnLoading(btn, isLoading) {
    if (!btn) return;
    if (isLoading) {
      btn.dataset.original = btn.innerHTML; // Guardamos el HTML original
      btn.disabled = true;
      // Mantenemos la altura para que no salte el dise√±o
      btn.innerHTML = `<div class="d-flex align-items-center justify-content-center" style="height: 100%;">
                         <div class="spinner-border spinner-border-sm" role="status" style="width: 2rem; height: 2rem;"></div>
                       </div>`;
    } else {
      btn.innerHTML = btn.dataset.original;
      btn.disabled = false;
    }
  }

  function openReportFromMobile(btn) {
    setMobBtnLoading(btn, true);

    setTimeout(() => {
        if (!reportModal) reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        
        document.getElementById('repId').value = '';
        document.getElementById('repDesc').value = '';
        
        // --- TRUCO VISUAL ---
        // 1. Deshabilitamos los selects de ubicaci√≥n
        const sCampus = document.getElementById('repCampus');
        const sEdificio = document.getElementById('repEdificio');
        const sActivo = document.getElementById('repActivo');

        sCampus.disabled = true; 
        sEdificio.disabled = true;
        
        // 2. Les ponemos una opci√≥n "dummy" para que parezca que est√°n rellenos
        // (Esto es solo est√©tico, para que el usuario no vea "Selecciona...")
        sCampus.innerHTML = '<option selected>Detectado por QR</option>';
        sEdificio.innerHTML = '<option selected>Ubicaci√≥n del Activo</option>';
        
        // 3. Configurar el Activo (LO IMPORTANTE)
        const nombre = document.getElementById('mob-asset-name').innerText;
        
        // Forzamos el ID y el Nombre en el select de activo
        sActivo.innerHTML = `<option value="${currentMobileId}" selected>${nombre}</option>`;
        sActivo.disabled = false; // Importante: Debe estar habilitado para que submitReport lea el valor

        // Abrir modal
        reportModal.show();
        
        setTimeout(() => setMobBtnLoading(btn, false), 500);
    }, 50);
  }

  function openMaintFromMobile(btn) {
    setMobBtnLoading(btn, true);
    
    setTimeout(() => {
        // Configuramos modal de revisi√≥n
        if (!maintModal) maintModal = new bootstrap.Modal(document.getElementById('maintModal'));
        
        // Limpieza est√°ndar
        document.getElementById('revId').value = "";
        document.getElementById('revTipo').value = "Legal";
        document.getElementById('revFecha').value = new Date().toISOString().split('T')[0];
        document.getElementById('maintModalTitle').innerText = 'Programar Revisi√≥n';
        document.getElementById('revDocsList').innerHTML = '<div class="text-center text-muted fst-italic py-2">Sin documentos</div>';
        
        // Ocultar selectores complejos, ya sabemos el activo
        document.getElementById('assetSelector').classList.add('d-none');
        
        // Forzamos el ID global para que submitRevision lo coja
        currentActiveAssetId = currentMobileId; 
        
        maintModal.show();
        
        // Restaurar bot√≥n
        setTimeout(() => setMobBtnLoading(btn, false), 500);
    }, 50);
  }

  function openDocsFromMobile(btn) {
    setMobBtnLoading(btn, true); // AQU√ç ES DONDE M√ÅS SE NOTABA EL RETRASO

    google.script.run
      .withSuccessHandler(docs => {
         setMobBtnLoading(btn, false); // Restaurar bot√≥n al volver del servidor

         if (docs.length === 0) {
             Swal.fire({
                 title: 'Sin documentos', 
                 text: 'Este activo no tiene manuales ni certificados adjuntos.', 
                 icon: 'info',
                 confirmButtonColor: '#CC0605'
             });
             return;
         }
       
         let html = '<div class="list-group text-start">';
         docs.forEach(d => {
           html += `<a href="${d.url}" target="_blank" class="list-group-item list-group-item-action py-3">
                      <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 fw-bold text-primary"><i class="bi bi-file-earmark-pdf me-2"></i>${d.nombre}</h6>
                      </div>
                      <small class="text-muted">Versi√≥n ${d.version} | ${d.fecha}</small>
                    </a>`;
         });
         html += '</div>';
       
         Swal.fire({
           title: 'Documentaci√≥n Disponible',
           html: html,
           showCloseButton: true,
           showConfirmButton: false,
           width: '90%' // M√°s ancho en m√≥vil
         });
      })
      .withFailureHandler(err => {
          setMobBtnLoading(btn, false);
          notificarError("Error cargando docs: " + err.message);
      })
      .obtenerDocs(currentMobileId);
  }

  function exitMobileViewToDetail(btn) {
    setMobBtnLoading(btn, true);
    setTimeout(() => {
        const view = document.getElementById('view-mobile-qr');
        view.classList.add('d-none');
        
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.style.display = ''; 
        document.querySelector('.mobile-header').style.display = '';
        
        openAssetDetail(currentMobileId);
        
        // No necesitamos restaurar el bot√≥n porque la vista desaparece, 
        // pero por limpieza lo hacemos
        setMobBtnLoading(btn, false);
    }, 300);
  }

  // ==========================================
// SISTEMA DE ANIMACIONES MODERNAS
// ==========================================

/**
 * Anima la entrada de una nueva fila en una tabla
 * @param {HTMLElement} row - Fila del DOM
 */
function animateRowIn(row) {
  row.classList.add('row-enter');
  row.addEventListener('animationend', () => {
    row.classList.remove('row-enter');
  }, { once: true });
}

/**
 * Anima la salida de una fila con colapso
 * @param {HTMLElement} row - Fila a eliminar
 * @param {Function} callback - Funci√≥n a ejecutar tras la animaci√≥n
 */
function animateRowOut(row, callback) {
  // 1. Fase de fade-out lateral
  row.classList.add('row-exit');
  
  row.addEventListener('animationend', () => {
    // 2. Fase de colapso vertical
    row.classList.remove('row-exit');
    row.classList.add('row-collapse');
    
    row.addEventListener('animationend', () => {
      if (callback) callback();
      row.remove();
    }, { once: true });
  }, { once: true });
}

/**
 * Flash de √©xito en una fila (ej. al actualizar)
 */
function flashSuccess(row) {
  row.classList.add('success-flash');
  setTimeout(() => row.classList.remove('success-flash'), 1000);
}

/**
 * Skeleton Loader para tablas (mientras cargan datos)
 */
function showSkeletonTable(tbody, rows = 5, cols = 4) {
  let html = '';
  for (let i = 0; i < rows; i++) {
    html += '<tr>';
    for (let j = 0; j < cols; j++) {
      const width = Math.random() * (80 - 40) + 40; // Anchos variables
      html += `<td><div class="skeleton" style="height: 20px; width: ${width}%;"></div></td>`;
    }
    html += '</tr>';
  }
  tbody.innerHTML = html;
}

/**
 * Notificaci√≥n Toast mejorada con icono y color
 */
function toastModerno(mensaje, tipo = 'success') {
  const iconos = {
    success: '‚úì',
    error: '‚úï',
    info: '‚Ñπ',
    warning: '‚ö†'
  };
  
  const colores = {
    success: '#10b981',
    error: '#ef4444',
    info: '#3b82f6',
    warning: '#f59e0b'
  };
  
  Swal.fire({
    toast: true,
    position: 'top-end',
    icon: tipo,
    title: mensaje,
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    iconColor: colores[tipo],
    customClass: {
      popup: 'swal2-toast-modern'
    },
    didOpen: (toast) => {
      toast.addEventListener('mouseenter', Swal.stopTimer);
      toast.addEventListener('mouseleave', Swal.resumeTimer);
    }
  });
}

/**
 * Renderizado optimizado de tablas con animaci√≥n progresiva
 */
function renderTableAnimated(tbody, data, renderRow, options = {}) {
  const {
    pageSize = 30,
    animationDelay = 10, // ms entre cada fila (m√°s r√°pido = menos perceptible)
    showSkeleton = true
  } = options;
  
  // 1. Mostrar skeleton mientras preparamos datos
  if (showSkeleton && data.length > 10) {
    showSkeletonTable(tbody, Math.min(data.length, 10), 5);
  }
  
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-5 fst-italic">No hay datos para mostrar</td></tr>';
    return;
  }
  
  let currentIndex = 0;
  
  function renderBatch() {
    const end = Math.min(currentIndex + pageSize, data.length);
    const fragment = document.createDocumentFragment();
    
    for (let i = currentIndex; i < end; i++) {
      const tr = document.createElement('tr');
      tr.innerHTML = renderRow(data[i], i);
      tr.style.opacity = '0';
      fragment.appendChild(tr);
    }
    
    if (currentIndex === 0) {
      tbody.innerHTML = '';
    }
    
    tbody.appendChild(fragment);
    
    // Animaci√≥n de entrada escalonada
    const newRows = tbody.querySelectorAll('tr[style*="opacity: 0"]');
    newRows.forEach((row, idx) => {
      setTimeout(() => {
        row.style.opacity = '1';
        row.classList.add('fade-in');
      }, idx * animationDelay);
    });
    
    currentIndex = end;
    
    if (currentIndex < data.length) {
      requestAnimationFrame(renderBatch);
    } else {
      refreshSecurityIcons();
    }
  }
  
  renderBatch();
}

function diagnosticarCargaActivos() {
  console.log('=== DIAGN√ìSTICO DE CARGA DE ACTIVOS ===');
  console.log('currentBuildingId:', currentBuildingId);
  console.log('window.currentBuildingAssetsList:', window.currentBuildingAssetsList);
  console.log('Elemento tbody existe:', !!document.getElementById('buildingAssetsBody'));
  console.log('Pesta√±a visible:', !document.getElementById('tab-b-assets').classList.contains('d-none'));
  
  // Test de carga forzada
  if (currentBuildingId) {
    console.log('üîß Forzando recarga...');
    loadBuildingAssets();
  } else {
    console.error('‚ùå No se puede cargar sin currentBuildingId');
  }
}

  function obtenerIconoRelacion(tipo) {
    const mapa = {
      "DEPENDE_DE": "üîó",        // Cadena
      "ES_REQUERIDO_POR": "üß±",  // Ladrillo base
      "ALIMENTA": "‚ö°",          // Rayo
      "ES_ALIMENTADO_POR": "üîå", // Enchufe
      "PERTENECE_A": "üì¶",       // Caja
      "CONTIENE": "üìÇ",          // Carpeta
      "RELACIONADO": "üîÑ"        // Ciclo
    };
    return mapa[tipo] || "üîó";
  }

  function obtenerColorRelacion(tipo) {
    const mapa = {
      "DEPENDE_DE": "bg-danger",       // Cr√≠tico
      "ALIMENTA": "bg-warning text-dark", // Energ√≠a
      "PERTENECE_A": "bg-secondary",   // Jerarqu√≠a
      "RELACIONADO": "bg-info text-dark"
    };
    // Si es inverso o no est√°, usa uno gen√©rico o deriva
    if (tipo.includes("ALIMENTADO")) return "bg-warning text-dark bg-opacity-75";
    return mapa[tipo] || "bg-light text-dark border";
  }

  function formatearTipoRelacion(tipo) {
    const mapa = {
      "DEPENDE_DE": "Depende de",
      "ES_REQUERIDO_POR": "Es vital para",
      "ALIMENTA": "Alimenta a",
      "ES_ALIMENTADO_POR": "Recibe de",
      "PERTENECE_A": "Parte de",
      "CONTIENE": "Compone a",
      "RELACIONADO": "Vinculado con"
    };
    return mapa[tipo] || tipo;
  }

</script>
