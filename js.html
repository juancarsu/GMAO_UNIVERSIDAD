<script>
  // ==========================================
  // 1. VARIABLES GLOBALES
  // ==========================================
  let myChart, myPieChart, calendar, currentAssetId = null;
  let campusLoaded = false;
  let globalMaintData = [];
  let globalContractData = [];
  let globalIncidencias = [];
  let allEdificiosData = [];
  let currentActiveAssetId = null;
  let currentBuildingId = null;
  let lastView = 'activos';
  let currentUser = { rol: 'CONSULTA', nombre: 'Cargando...' };
  let mapInstance = null; // Para guardar el mapa
  let markersLayer = null;
  let changelogModal = null;
  let newVersionModal = null;
  let plannerCalendar = null; // Instancia separada para el planificador
  let allPlannerEvents = [];  // Caché local de eventos para filtrar rápido
  window.currentBuildingAssetsList = [];
  window.allAssetsData = []; // Cache local de TODOS los activos
  let currentRenderTimeout = null;

  // Instancias de Modales
  let maintModal = null; let contractModal = null; let myModal = null; let obraModal = null;
  let configModal = null; let userModal = null; let reportModal = null; let feedbackModal = null;
  let edificioModal = null; let campusModal = null;

  // ==========================================
  // 2. HELPERS VISUALES (SWEETALERT2)
  // ==========================================
  const Toast = Swal.mixin({
    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
    didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
  });


  function notificarExito(mensaje) {
    Toast.fire({ icon: 'success', title: mensaje || '¡Operación exitosa!' });
  }

  function notificarError(mensaje) {
    Swal.fire({ icon: 'error', title: 'Ups...', text: mensaje || 'Ha ocurrido un error inesperado.', confirmButtonColor: '#CC0605' });
  }

  // Helper genérico que faltaba
  function notificar(mensaje, icono = 'info') {
    Toast.fire({ icon: icono, title: mensaje });
  }

  function confirmarAccion(titulo, texto, callback) {
    Swal.fire({
      title: titulo || '¿Estás seguro?', text: texto || "Esta acción no se puede deshacer.", icon: 'warning',
      showCancelButton: true, confirmButtonColor: '#CC0605', cancelButtonColor: '#6c757d',
      confirmButtonText: 'Sí, proceder', cancelButtonText: 'Cancelar'
    }).then((result) => { if (result.isConfirmed) callback(); });
  }

  function setBtnLoading(btnId, loading) {
    const btn = document.getElementById(btnId); if (!btn) return;
    if (loading) { btn.dataset.og = btn.innerText; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; }
    else { btn.disabled = false; btn.innerText = btn.dataset.og || 'Guardar'; }
  }

  // Añadir junto a tus otras funciones de notificaciones en js.html

  function mostrarCargando(mensaje = 'Guardando cambios...') {
    Swal.fire({
      title: mensaje,
      html: 'Por favor, no cierres la ventana.',
      allowOutsideClick: false,
      allowEscapeKey: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading(); // Activa el spinner de SweetAlert
      }
    });
  }

  // ==========================================
  // 3. INICIALIZACIÓN
  // ==========================================
  window.onload = function () {
    // Cargar seguridad y Dashboard
    google.script.run.withSuccessHandler(u => {
      currentUser = u;
      applySecurityUI();
      loadDashboard();
      loadDashboardFilters();

      // Mover aquí la lógica que depende del usuario
      if (u.rol === 'ADMIN') {
        // Cargar en segundo plano para ver si hay notificaciones
        google.script.run.withSuccessHandler(list => {
          const nuevos = list.filter(i => i.estado === 'NUEVO').length;
          updateBadgeFeedback(nuevos);
        }).getFeedbackList();
      }

    }).getMyRole();

    initFilters();

    // Inicializar Bootstrap Modals
    if (document.getElementById('maintModal')) maintModal = new bootstrap.Modal(document.getElementById('maintModal'));
    if (document.getElementById('contractModal')) contractModal = new bootstrap.Modal(document.getElementById('contractModal'));
    if (document.getElementById('createModal')) myModal = new bootstrap.Modal(document.getElementById('createModal'));
    if (document.getElementById('obraModal')) obraModal = new bootstrap.Modal(document.getElementById('obraModal'));
    if (document.getElementById('configModal')) configModal = new bootstrap.Modal(document.getElementById('configModal'));
    if (document.getElementById('userModal')) userModal = new bootstrap.Modal(document.getElementById('userModal'));
    if (document.getElementById('reportModal')) reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    if (document.getElementById('feedbackModal')) feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    if (document.getElementById('edificioModal')) edificioModal = new bootstrap.Modal(document.getElementById('edificioModal'));
    if (document.getElementById('campusModal')) campusModal = new bootstrap.Modal(document.getElementById('campusModal'));

    // Cargar catálogo para selects
    google.script.run.withSuccessHandler(list => {
      const sel = document.getElementById('revNorma');
      if (sel) {
        let html = '<option value="">Seleccione norma...</option>';
        list.forEach(n => html += `<option value="${n.id}" data-dias="${n.dias}">${n.nombre}</option>`);
        sel.innerHTML = html;
      }
    }).getCatalogoInstalaciones();

    // Listeners
    const revTipo = document.getElementById('revTipo'); if (revTipo) revTipo.addEventListener('change', updateMaintFormVisibility);
    const revNorma = document.getElementById('revNorma'); if (revNorma) revNorma.addEventListener('change', autoFillFrequency);
    const revRecur = document.getElementById('revRecur'); if (revRecur) revRecur.addEventListener('change', function () { document.getElementById('secRecurOptions').classList.toggle('d-none', !this.checked); });
  };

  // ==========================================
  // 4. SEGURIDAD Y NAVEGACIÓN
  // ==========================================
  function applySecurityUI() {
    const profileDiv = document.querySelector('.user-profile');
    if (profileDiv) { profileDiv.innerHTML = `<i class="bi bi-person-circle me-2 fs-5"></i><div><div class="fw-bold">${currentUser.nombre}</div><small class="text-muted text-truncate" style="max-width:140px; display:block;">${currentUser.rol}</small></div>`; }
    if (currentUser.rol === 'CONSULTA') {
      document.querySelectorAll('.btn-primary, .btn-success, .btn-outline-danger').forEach(el => {
        const onClickAttr = el.getAttribute('onclick') || "";
        if (!onClickAttr.includes('openReportModal') && !onClickAttr.includes('openFeedbackModal')) { el.classList.add('d-none'); }
      });
      document.querySelectorAll('input[type="file"]').forEach(el => el.parentElement.classList.add('d-none'));
      const repFoto = document.getElementById('repFoto'); if (repFoto) repFoto.parentElement.classList.remove('d-none');
      document.querySelectorAll('.form-check-input').forEach(el => el.disabled = true);
    }
    if (currentUser.rol === 'TECNICO') {
      const links = document.querySelectorAll('.menu-link');
      links.forEach(l => { const onClickAttr = l.getAttribute('onclick') || ""; if (onClickAttr.includes('usuarios') || onClickAttr.includes('config')) { l.parentElement.classList.add('d-none'); } });
      const btnUser = document.querySelector('button[onclick="openUserModal()"]'); if (btnUser) btnUser.classList.add('d-none');
      const btnConf = document.querySelector('button[onclick="openConfigModal()"]'); if (btnConf) btnConf.classList.add('d-none');
    }

    if (currentUser.rol !== 'ADMIN') {
      // ... otros ocultamientos ...
      const btnLogs = document.getElementById('menu-logs');
      if (btnLogs) btnLogs.classList.add('d-none');
      const btnFeed = document.getElementById('menu-feedback');
      if (btnFeed) btnFeed.classList.add('d-none');
    }
  }

  function refreshSecurityIcons() {
    if (currentUser.rol === 'CONSULTA') {
      document.querySelectorAll('table .btn-sm').forEach(btn => {
        if (btn.innerHTML.includes('bi-trash') || btn.innerHTML.includes('bi-pencil') || btn.innerText.includes('Finalizar') || btn.innerHTML.includes('bi-check-lg') || btn.innerHTML.includes('bi-play-fill')) { btn.classList.add('d-none'); }
      });
    }
    if (currentUser.rol === 'TECNICO') {
      document.querySelectorAll('button').forEach(btn => { if (btn.innerHTML.includes('bi-trash') || btn.getAttribute('title') === 'Eliminar' || btn.getAttribute('title') === 'Borrar') { btn.classList.add('d-none'); } });
      const viewUser = document.getElementById('view-usuarios'); if (!viewUser.classList.contains('d-none')) { document.querySelectorAll('#tableUsersBody button').forEach(b => b.classList.add('d-none')); }
      const viewConf = document.getElementById('view-config'); if (!viewConf.classList.contains('d-none')) { document.querySelectorAll('#tableConfigBody button').forEach(b => b.classList.add('d-none')); }
    }
  }

  function navTo(viewId, linkEl, event) {
    // 1. Gestión del menú móvil
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    if (sidebar && sidebar.classList.contains('active')) {
      toggleSidebar();
    }

    if (event) event.preventDefault();

    // 2. Gestión de clases activas en el menú
    if (linkEl) {
      document.querySelectorAll('.menu-link').forEach(el => el.classList.remove('active'));
      linkEl.classList.add('active');
    }

    // 3. Ocultar todas las vistas y mostrar la deseada
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
    const target = document.getElementById('view-' + viewId);
    if (target) target.classList.remove('d-none');

    // Resetear variables globales de navegación
    currentActiveAssetId = null;
    currentBuildingId = null;

    // 4. LÓGICA ESPECÍFICA DE CADA VISTA
    if (viewId === 'dashboard') loadDashboard();
    if (viewId === 'campus') loadCampusList();
    if (viewId === 'edificios') loadEdificiosList();
    if (viewId === 'mantenimiento') { loadGlobalMaint(); loadMaintFilters(); }
    if (viewId === 'contratos') { loadGlobalContracts(); loadContractFilters(); }
    if (viewId === 'contratos') { loadGlobalContracts(); loadContractFilters(); }
    if (viewId === 'activos') {
      const sel = document.getElementById('filterCampus');
      if (!sel || sel.options.length <= 1) initFilters();
      // Cargar todos los activos si no se han cargado aún
      if (window.allAssetsData.length === 0) loadAllAssets();
    }
    if (viewId === 'config') loadConfigList();
    if (viewId === 'config') loadConfigList();
    if (viewId === 'usuarios') loadUserList();
    if (viewId === 'incidencias') loadIncidencias();
    if (viewId === 'logs') loadLogsList();
    if (viewId === 'feedback') loadFeedbackList();
    if (viewId === 'planner') {
      setTimeout(function () {
        initPlannerCalendar();
      }, 100);
    }
    if (viewId === 'audit') loadAuditYears();
  }

  function loadLogsList() {
    const tbody = document.getElementById('tableLogsBody');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-secondary"></div> Cargando auditoría...</td></tr>';

    google.script.run.withSuccessHandler(logs => {
      if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-5">El registro está vacío.</td></tr>';
        return;
      }
      let html = '';
      logs.forEach(r => {
        // Colores según acción para que sea visual
        let badgeClass = 'bg-light text-dark border';
        if (r.accion.includes('ELIMINAR')) badgeClass = 'bg-danger text-white';
        if (r.accion.includes('GUARDAR') || r.accion.includes('CREAR')) badgeClass = 'bg-success text-white';
        if (r.accion.includes('IMPORTACIÓN')) badgeClass = 'bg-primary text-white';

        html += `<tr>
        <td class="ps-4 small text-muted font-monospace">${r.fecha}</td>
        <td class="fw-bold text-primary">${r.usuario}</td>
        <td><span class="badge ${badgeClass}">${r.accion}</span></td>
        <td class="small text-muted text-truncate" style="max-width: 400px;" title="${r.detalles}">${r.detalles}</td>
      </tr>`;
      });
      tbody.innerHTML = html;
    }).getLogsAuditoria();
  }

  // ==========================================
  // 5. DASHBOARD & CALENDARIO
  // ==========================================
  function loadDashboard() {
    const filter = document.getElementById('dashboardCampusFilter');
    const idCampus = filter ? filter.value : null;

    // Mostrar loader mientras carga
    document.getElementById('d-activos').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    document.getElementById('d-vencidas').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    // UNA SOLA LLAMADA para todo
    google.script.run
      .withSuccessHandler(d => {
        // Actualizar números
        document.getElementById('d-activos').innerText = d.activos;
        document.getElementById('d-vencidas').innerText = d.vencidas;
        document.getElementById('d-pendientes').innerText = d.pendientes;
        document.getElementById('d-incidencias').innerText = d.incidencias;
        document.getElementById('d-contratos').innerText = d.contratos;
        document.getElementById('d-edificios').innerText = d.edificios;
        document.getElementById('d-campus').innerText = d.campus;

        // Gráficas
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: d.chartLabels,
            datasets: [{
              label: 'Revisiones',
              data: d.chartData,
              borderColor: '#CC0605',
              backgroundColor: 'rgba(204, 6, 5, 0.1)',
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });

        const ctxPie = document.getElementById('pieChart').getContext('2d');
        if (myPieChart) myPieChart.destroy();
        myPieChart = new Chart(ctxPie, {
          type: 'doughnut',
          data: {
            labels: ['Pendientes', 'Vencidas', 'Al Día'],
            datasets: [{
              data: [d.pendientes, d.vencidas, d.ok],
              backgroundColor: ['#f59e0b', '#ef4444', '#10b981']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
          }
        });

        // Calendario
        const calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = '';
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          locale: 'es',
          height: 550,
          headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
          events: d.calendarEvents,
          selectable: true,
          dateClick: function (info) { mostrarModalRevision(info.dateStr); },
          eventClick: function (info) {
            const p = info.event.extendedProps;
            editRevision(p.id, p.tipo, p.fechaISO, p.idActivo, p.hasCalendar);
          }
        });
        calendar.render();

        ocultarLoader();
      })
      .withFailureHandler(err => {
        notificarError("Error cargando dashboard: " + err.message);
        ocultarLoader();
      })
      .getDatosDashboard(idCampus);
  }

  function loadDashboardFilters() {
    const sel = document.getElementById('dashboardCampusFilter');
    if (!sel) return;
    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">- Todos los Campus -</option>';
      list.forEach(c => html += `<option value="${c.id}">${c.nombre}</option>`);
      sel.innerHTML = html;
    }).getTableData('CAMPUS');
  }

  /**
   * Renderizar tabla con paginación virtual (sin páginas, carga progresiva)
   */
  function renderTableLazy(tbody, data, renderRow, pageSize = 50) {
    // 1. Limpiar cualquier renderizado pendiente anterior
    if (currentRenderTimeout) {
        clearTimeout(currentRenderTimeout);
        currentRenderTimeout = null;
    }

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">Sin datos</td></tr>';
      return;
    }

    let currentPage = 0;
    const totalPages = Math.ceil(data.length / pageSize);

    function loadPage() {
      const start = currentPage * pageSize;
      const end = Math.min(start + pageSize, data.length);

      let html = '';
      for (let i = start; i < end; i++) {
        html += renderRow(data[i], i);
      }

      if (currentPage === 0) {
        tbody.innerHTML = html;
      } else {
        tbody.insertAdjacentHTML('beforeend', html);
      }

      currentPage++;

      if (currentPage < totalPages) {
        // Guardamos el ID del timeout
        currentRenderTimeout = setTimeout(loadPage, 10); 
      } else {
        refreshSecurityIcons();
        currentRenderTimeout = null; // Limpiamos al terminar
      }
    }

    loadPage();
  }

  // ==========================================
  // 6. MANTENIMIENTO GLOBAL
  // ==========================================
  function loadGlobalMaint() {
    const tbody = document.getElementById('tableGlobalMaint');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary"></div> Cargando plan...</td></tr>';

    google.script.run.withSuccessHandler(data => {
      globalMaintData = data;
      renderGlobalMaintTable(data);
    }).getGlobalMaintenance();
  }

  // En js.html -> renderGlobalMaintTable

  function renderGlobalMaintTable(data) {
      const tbody = document.getElementById('tableGlobalMaint');

      renderTableLazy(tbody, data, (r, index) => {
        let dotClass = 'bg-secondary';
        if (r.color === 'rojo') dotClass = 'bg-rojo';
        if (r.color === 'amarillo') dotClass = 'bg-amarillo';
        if (r.color === 'verde') dotClass = 'bg-verde';
        
        // --- NUEVO: Clase para histórico ---
        if (r.color === 'azul') dotClass = 'bg-info'; 

        let clipIcon = r.hasDocs ? '<i class="bi bi-paperclip text-primary ms-1"></i>' : '';
        let calIcon = r.hasCalendar ? '<i class="bi bi-calendar-check text-success ms-1"></i>' : '';
        const nombreCampusVisual = r.campusNombre || 'Sin datos';

        // --- NUEVO: Texto de fecha ---
        // Si es histórico, no mostramos "días restantes", mostramos "Realizada"
        let fechaTexto = `<span class="dot ${dotClass}"></span> ${r.fecha} <small class="text-muted ms-1">(${r.dias} días)</small>`;
        
        let botonesAccion = `
            <button class="btn btn-sm btn-light border" onclick="editRevision('${r.id}', '${r.tipo}', '${r.fechaISO}', '${r.idActivo}', ${r.hasCalendar})" title="Editar"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-success" onclick="marcarHecho('${r.id}')" title="Completar"><i class="bi bi-check-lg"></i></button>
        `;

        if (r.color === 'azul') {
            fechaTexto = `<span class="dot ${dotClass}"></span> ${r.fecha} <small class="text-muted fst-italic ms-1">Histórico</small>`;
            // En histórico solo dejamos ver/editar (para ver docs), pero quitamos "Completar"
            botonesAccion = `
              <button class="btn btn-sm btn-light border" onclick="editRevision('${r.id}', '${r.tipo}', '${r.fechaISO}', '${r.idActivo}', ${r.hasCalendar})" title="Ver detalles/Docs"><i class="bi bi-eye"></i></button>
            `;
        }

        return `<tr>
          <td class="text-center ps-4 text-muted small">${index + 1}</td>
          <td>
            <div class="fw-bold">${r.edificio}</div>
            <small class="text-muted"><i class="bi bi-bank me-1"></i>${nombreCampusVisual}</small>
          </td>
          <td>${r.activo}</td>
          <td><span class="badge bg-light text-dark border">${r.tipo}</span>${clipIcon}${calIcon}</td>
          <td>${fechaTexto}</td>
          <td class="text-end pe-4">
            <div class="btn-group">
              ${botonesAccion}
            </div>
          </td>
        </tr>`;
      });
  }

  function marcarHecho(idRevision) {
    Swal.fire({
      title: '¿Completar revisión?',
      text: "Se marcará como realizada y desaparecerá de la lista de pendientes.",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#198754', // Verde éxito
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Sí, completar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run.withSuccessHandler(res => {
          if (res.success) {
            notificarExito("¡Revisión completada!");
            // Recargamos la lista según donde estemos
            if (document.getElementById('view-mantenimiento') && !document.getElementById('view-mantenimiento').classList.contains('d-none')) {
              loadGlobalMaint();
            } else if (currentAssetId) {
              loadMaint();
            }
            loadDashboard(); // Actualizar contadores
          } else {
            notificarError(res.error);
          }
        }).completarRevision(idRevision);
      }
    });
  }

  // --- FILTROS MANTENIMIENTO ---
  function loadMaintFilters() {
    const selCampus = document.getElementById('maintFilterCampus');
    if (selCampus && selCampus.options.length <= 1) {
      google.script.run.withSuccessHandler(list => {
        let html = '<option value="">Todos los Campus</option>';
        list.forEach(c => html += `<option value="${c.id}">${c.nombre}</option>`);
        selCampus.innerHTML = html;
      }).getListaCampus();
    }
  }

  function loadEdificiosMaintFilter(idCampus) {
    const selEdif = document.getElementById('maintFilterEdificio');
    selEdif.innerHTML = '<option>Cargando...</option>';
    if (!idCampus) {
      selEdif.innerHTML = '<option value="">Todos los Edificios</option>';
      setMaintFilter('edificio', '');
      return;
    }
    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">Todos los Edificios</option>';
      list.forEach(e => html += `<option value="${e.id}">${e.nombre}</option>`);
      selEdif.innerHTML = html;
      setMaintFilter('edificio', '');
    }).getEdificiosPorCampus(idCampus);
  }

  // En js.html

  function setMaintFilter(tipoFiltro, valor, btn) {
      // 1. GESTIÓN VISUAL DE BOTONES (Si se ha pulsado uno)
      if (btn) {
          // Buscamos el grupo padre del botón pulsado
          const parent = btn.parentElement;
          // Quitamos la clase 'active' a todos los botones hermanos
          parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          // Se la ponemos al botón que acabamos de pulsar
          btn.classList.add('active');
      }

      // 2. LEER VALORES ACTUALES DE LOS SELECTORES
      const fCampus = document.getElementById('maintFilterCampus').value;
      const fEdificio = document.getElementById('maintFilterEdificio').value;

      // 3. DETERMINAR FILTRO DE ESTADO (COLOR)
      let fColor = 'all';
      // Buscamos qué botón está activo en el grupo de colores
      const colorBtnActive = document.querySelector('#filterGroupColor .active');
      
      if (colorBtnActive) {
          if (colorBtnActive.innerText === 'Todas') fColor = 'all';
          else if (colorBtnActive.classList.contains('btn-outline-danger')) fColor = 'rojo';      // Vencidas
          else if (colorBtnActive.classList.contains('btn-outline-warning')) fColor = 'amarillo'; // Próximas
          else if (colorBtnActive.classList.contains('btn-outline-success')) fColor = 'verde';    // Al día
          else if (colorBtnActive.classList.contains('btn-outline-info')) fColor = 'azul';        // Histórico
      }

      // 4. DETERMINAR FILTRO DE TIPO DE REVISIÓN
      let fType = 'all';
      // Buscamos qué botón está activo en el grupo de tipos
      const typeBtnActive = document.querySelector('#filterGroupType .active');
      
      if (typeBtnActive && typeBtnActive.innerText !== 'Todos') {
          // Leemos el onclick para saber el tipo exacto (es más seguro que el texto visible)
          const txt = typeBtnActive.getAttribute('onclick');
          if (txt.includes('Legal')) fType = 'Legal';
          else if (txt.includes('Periódica')) fType = 'Periódica';
          else if (txt.includes('Reparación')) fType = 'Reparación';
          else if (txt.includes('Extraordinaria')) fType = 'Extraordinaria';
      }

      // 5. APLICAR FILTROS AL ARRAY GLOBAL DE DATOS
      if (!globalMaintData) return;

      const filtered = globalMaintData.filter(item => {
          // A. Filtro Campus
          const matchCampus = (fCampus === "") || (String(item.campusId) === String(fCampus));

          // B. Filtro Edificio
          const matchEdif = (fEdificio === "") || (String(item.edificioId) === String(fEdificio));
          
          // C. Filtro Tipo
          const matchType = (fType === 'all') || (item.tipo === fType);
          
          // D. Filtro Color (Estado)
          let matchColor = false;
          
          if (fColor === 'all') {
              // IMPORTANTE: Si elegimos "Todas", mostramos las activas (rojo, amarillo, verde)
              // pero OCULTAMOS las históricas (azul) para no ensuciar la lista.
              matchColor = (item.color !== 'azul');
          } else {
              // Si elegimos un color específico (incluido azul/histórico), mostramos solo ese.
              matchColor = (item.color === fColor);
          }

          return matchCampus && matchEdif && matchType && matchColor;
      });
      
      // 6. RENDERIZAR LA TABLA CON LOS RESULTADOS FILTRADOS
      renderGlobalMaintTable(filtered);
  }

  // --- MODAL REVISIÓN DESDE CALENDARIO ---
  // En js.html

  function mostrarModalRevision(dateStr) {
      if (!maintModal) maintModal = new bootstrap.Modal(document.getElementById('maintModal'));
      
      // Limpieza de campos básicos
      document.getElementById('revId').value = "";
      document.getElementById('revTipo').value = "Legal";
      document.getElementById('revFecha').value = dateStr || new Date().toISOString().split('T')[0];
      document.getElementById('maintModalTitle').innerText = 'Programar Revisión';
      document.getElementById('revDocsList').innerHTML = '<div class="text-center text-muted fst-italic py-2">Sin documentos adjuntos</div>';

      // --- CORRECCIÓN AQUÍ ---
      // Comprobamos si estamos dentro de un activo (currentAssetId tiene valor)
      if (currentAssetId) {
          // MODO CONTEXTO ACTIVO: Ocultamos los selectores para no confundir
          // El sistema usará 'currentAssetId' automáticamente al guardar
          document.getElementById('assetSelector').classList.add('d-none');
      } else {
          // MODO GLOBAL: Mostramos selectores para elegir el activo
          document.getElementById('assetSelector').classList.remove('d-none');
          
          const selC = document.getElementById('maintCampus');
          if (selC.options.length <= 1) {
              google.script.run.withSuccessHandler(list => {
                  let html = '<option value="">- Campus -</option>';
                  list.forEach(c => html += `<option value="${c.id}">${c.nombre}</option>`);
                  selC.innerHTML = html;
              }).getListaCampus();
          }
          
          // Reset de selectores
          document.getElementById('maintEdificio').innerHTML = '<option value="">- Edificio -</option>';
          document.getElementById('maintEdificio').disabled = true;
          document.getElementById('maintActivo').innerHTML = '<option value="">- Activo -</option>';
          document.getElementById('maintActivo').disabled = true;
      }

      // ¡IMPORTANTE! Hemos eliminado la línea "currentAssetId = null;"
      // Esto permite que al guardar, la función sepa que tiene que refrescar la lista del activo.
      
      maintModal.show();
  }

  function loadEdificiosModalMaint(idCampus) {
    const sel = document.getElementById('maintEdificio');
    sel.innerHTML = '<option>Cargando...</option>'; sel.disabled = true;
    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">- Edificio -</option>';
      list.forEach(e => html += `<option value="${e.id}">${e.nombre}</option>`);
      sel.innerHTML = html; sel.disabled = false;
    }).getEdificiosPorCampus(idCampus);
  }

  function loadActivosModalMaint(idEdificio) {
    const sel = document.getElementById('maintActivo');
    sel.innerHTML = '<option>Cargando...</option>'; sel.disabled = true;
    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">- Activo -</option>';
      list.forEach(a => html += `<option value="${a.id}">${a.nombre} (${a.tipo})</option>`);
      sel.innerHTML = html; sel.disabled = false;
    }).getActivosPorEdificio(idEdificio);
  }

  // ==========================================
  // LÓGICA DEL MODAL DE CONTRATOS (ASOCIACIÓN)
  // ==========================================

  // 1. ABRIR MODAL (Cargar Campus)
  function mostrarModalContrato() {
    if (!contractModal) contractModal = new bootstrap.Modal(document.getElementById('contractModal'));

    document.getElementById('contModalTitle').innerText = 'Nuevo Contrato';

    // Limpiar campos
    document.getElementById('contId').value = '';
    document.getElementById('contProv').value = '';
    document.getElementById('contRef').value = '';
    document.getElementById('contIni').value = '';
    document.getElementById('contFin').value = '';
    document.getElementById('contEstado').value = 'ACTIVO';

    // Resetear selectores de ubicación
    const selC = document.getElementById('contCampus');
    selC.innerHTML = '<option>Cargando...</option>';
    document.getElementById('contEdificio').innerHTML = '<option value="">- Todo el Edificio (Opcional) -</option>';
    document.getElementById('contEdificio').disabled = true;
    document.getElementById('contActivo').innerHTML = '<option value="">- Activo Específico (Opcional) -</option>';
    document.getElementById('contActivo').disabled = true;

    // Cargar Campus
    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">- Selecciona Campus -</option>';
      list.forEach(c => html += `<option value="${c.id}">${c.nombre}</option>`);
      selC.innerHTML = html;
    }).getListaCampus();

    contractModal.show();
  }

  // 2. CARGAR EDIFICIOS (Al cambiar Campus en el Modal)
  function loadEdificiosContModal(idCampus) {
    const sel = document.getElementById('contEdificio');
    sel.innerHTML = '<option>Cargando...</option>';
    sel.disabled = true;

    // Reset activos
    document.getElementById('contActivo').innerHTML = '<option value="">- Activo Específico (Opcional) -</option>';
    document.getElementById('contActivo').disabled = true;

    if (!idCampus) {
      sel.innerHTML = '<option value="">- Todo el Edificio (Opcional) -</option>';
      return;
    }

    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">- Todo el Edificio (Opcional) -</option>';
      list.forEach(e => html += `<option value="${e.id}">${e.nombre}</option>`);
      sel.innerHTML = html;
      sel.disabled = false;
    }).getEdificiosPorCampus(idCampus);
  }

  // 3. CARGAR ACTIVOS (Al cambiar Edificio en el Modal)
  function loadActivosContModal(idEdificio) {
    const sel = document.getElementById('contActivo');
    sel.innerHTML = '<option>Cargando...</option>';
    sel.disabled = true;

    if (!idEdificio) {
      sel.innerHTML = '<option value="">- Activo Específico (Opcional) -</option>';
      return;
    }

    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">- Activo Específico (Opcional) -</option>';
      list.forEach(a => html += `<option value="${a.id}">${a.nombre}</option>`);
      sel.innerHTML = html;
      sel.disabled = false;
    }).getActivosPorEdificio(idEdificio);
  }

  // 4. GUARDAR CONTRATO (LÓGICA INTELIGENTE)
  function submitContract() {
    const id = document.getElementById('contId').value;
    const prov = document.getElementById('contProv').value;
    const ref = document.getElementById('contRef').value;
    const ini = document.getElementById('contIni').value;
    const fin = document.getElementById('contFin').value;
    const estado = document.getElementById('contEstado').value;

    // Leemos los selectores para ver la profundidad de la asignación
    const idCampus = document.getElementById('contCampus').value;
    const idEdificio = document.getElementById('contEdificio').value;
    const idActivo = document.getElementById('contActivo').value;

    if (!prov || !ini || !fin) return notificarError("Rellena Proveedor y Fechas.");
    if (!idCampus) return notificarError("Debes asociar el contrato al menos a un Campus.");

    // LÓGICA DE JERARQUÍA: Nos quedamos con el ID más específico posible
    let idEntidad = idCampus;
    let tipoEntidad = 'CAMPUS';

    if (idEdificio) {
      idEntidad = idEdificio;
      tipoEntidad = 'EDIFICIO';
    }
    if (idActivo) {
      idEntidad = idActivo;
      tipoEntidad = 'ACTIVO';
    }

    // Preparamos objeto
    const datos = {
      id: id,
      idEntidad: idEntidad,
      tipoEntidad: tipoEntidad,
      proveedor: prov,
      ref: ref,
      fechaIni: ini,
      fechaFin: fin,
      estado: estado
    };

    setBtnLoading('btnContSubmit', true);

    const finish = () => {
      setBtnLoading('btnContSubmit', false);
      if (contractModal) contractModal.hide();
      notificarExito("Contrato guardado y asociado correctamente");
      loadGlobalContracts(); // Refrescar tabla
    };

    if (id) google.script.run.withSuccessHandler(finish).updateContrato(datos);
    else google.script.run.withSuccessHandler(finish).crearContrato(datos);
  }


  // 1. Cargar la lista inicial de contratos
  function loadGlobalContracts() {
    const tbody = document.getElementById('tableGlobalContracts');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5">Cargando contratos...</td></tr>';

    google.script.run.withSuccessHandler(d => {
      globalContractData = d; // Guardamos en variable global para filtrar luego
      renderGlobalContractsTable(d);
      // Cargamos los filtros justo después de tener los datos
      loadContractFilters();
    }).obtenerContratosGlobal();
  }

  // 2. Pintar la tabla (Render)
  function renderGlobalContractsTable(d) {
    const tbody = document.getElementById('tableGlobalContracts');
    if (!tbody) return;

    if (!d || !d.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-5">No hay contratos que coincidan.</td></tr>';
      return;
    }

    let h = '';
    d.forEach(c => {
      let color = 'bg-secondary';
      if (c.color === 'rojo') color = 'bg-danger';
      if (c.color === 'amarillo') color = 'bg-warning text-dark';
      if (c.color === 'verde') color = 'bg-success';

      let fechas = `<small>${c.inicio}</small><br><small class="text-muted">${c.fin}</small>`;

      // AQUÍ ESTÁ EL CAMBIO: Usamos c.campusNombre
      let campusDisplay = c.campusNombre || '-';

      h += `<tr>
            <td class="align-middle"><span class="badge ${color}">${c.estado}</span></td>
            <td class="align-middle">
                <div class="fw-bold text-truncate" style="max-width:220px;">${c.nombreEntidad || 'N/A'}</div>
                <small class="text-muted"><i class="bi bi-bank me-1"></i>${campusDisplay}</small>
            </td>
            <td class="align-middle fw-bold">${c.proveedor}</td>
            <td class="align-middle font-monospace small">${c.ref}</td>
            <td class="align-middle">${fechas}</td>
            <td class="text-end align-middle">
                <div class="btn-group">
                    <button class="btn btn-sm btn-light border" onclick="editContractGlobal('${c.id}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteContract('${c.id}')"><i class="bi bi-trash"></i></button>
                </div>
            </td>
         </tr>`;
    });
    tbody.innerHTML = h;
    if (typeof refreshSecurityIcons === "function") refreshSecurityIcons();
  }

  // 3. Cargar el selector de Campus
  function loadContractFilters() {
    const sel = document.getElementById('contractFilterCampus');
    if (!sel || sel.options.length > 1) return; // Si ya tiene datos, no recargamos

    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">Todos los Campus</option>';
      list.forEach(c => html += `<option value="${c.id}">${c.nombre}</option>`);
      sel.innerHTML = html;
    }).getListaCampus();
  }

  // 4. Cargar Edificios según Campus
  function loadEdificiosContractFilter(idCampus) {
    const sel = document.getElementById('contractFilterEdificio');
    sel.innerHTML = '<option>Cargando...</option>';
    sel.disabled = true;

    if (!idCampus) {
      sel.innerHTML = '<option value="">Todos los Edificios</option>';
      setContractFilter(); // Refrescar filtro sin edificio
      return;
    }

    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">Todos los Edificios</option>';
      list.forEach(e => html += `<option value="${e.id}">${e.nombre}</option>`);
      sel.innerHTML = html;
      sel.disabled = false;
      setContractFilter(); // Refrescar filtro
    }).getEdificiosPorCampus(idCampus);
  }

  // 5. Lógica de Filtrado (CORREGIDA)
  // Esta función ahora acepta argumentos flexibles o ninguno
  function setContractFilter(arg1, arg2) {

    // A. GESTIÓN VISUAL DE LOS BOTONES
    // Si el primer argumento es un texto de estado (VIGENTE, etc), significa que hemos pulsado botón
    // El segundo argumento 'arg2' será el elemento 'this' (el botón)
    if (['VIGENTE', 'PRÓXIMO', 'CADUCADO', 'INACTIVO', 'all'].includes(arg1) && arg2) {
      const btn = arg2;
      const group = document.getElementById('contractFilterGroup');
      const buttons = group.getElementsByTagName('button');
      // Limpiamos todos
      for (let b of buttons) b.classList.remove('active');
      // Activamos el pulsado
      btn.classList.add('active');
    }

    // B. LEER ESTADO ACTUAL DE LA INTERFAZ
    // 1. Selectores
    const campusVal = document.getElementById('contractFilterCampus').value;
    const edificioVal = document.getElementById('contractFilterEdificio').value;

    // 2. Botones (Buscamos cuál tiene la clase active)
    let estadoFiltro = 'all';
    const activeBtn = document.querySelector('#contractFilterGroup .active');
    if (activeBtn) {
      // Leemos el texto del onclick para saber qué filtro es
      const action = activeBtn.getAttribute('onclick');
      if (action.includes("'VIGENTE'")) estadoFiltro = 'VIGENTE';
      else if (action.includes("'PRÓXIMO'")) estadoFiltro = 'PRÓXIMO';
      else if (action.includes("'CADUCADO'")) estadoFiltro = 'CADUCADO';
      else if (action.includes("'INACTIVO'")) estadoFiltro = 'INACTIVO';
    }

    // C. APLICAR FILTRO
    if (!globalContractData) return;

    const filtered = globalContractData.filter(item => {
      // Filtro Campus (conversión a String por seguridad)
      const matchCampus = (campusVal === "") || (String(item.campusId) === String(campusVal));
      // Filtro Edificio
      const matchEdificio = (edificioVal === "") || (String(item.edificioId) === String(edificioVal));
      // Filtro Estado
      const matchEstado = (estadoFiltro === 'all') || (item.estado === estadoFiltro);

      return matchCampus && matchEdificio && matchEstado;
    });

    renderGlobalContractsTable(filtered);
  }


  // ==========================================
  // 7. GESTIÓN INCIDENCIAS & FEEDBACK
  // ==========================================
  function loadIncidencias() { const tbody = document.getElementById('tableIncidenciasBody'); tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-danger"></div> Cargando...</td></tr>'; google.script.run.withSuccessHandler(list => { globalIncidencias = list; renderIncidencias(list); }).getIncidencias(); }
  function filterIncidencias(estado, btn) { if (btn) { btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } if (estado === 'all') renderIncidencias(globalIncidencias); else renderIncidencias(globalIncidencias.filter(i => i.estado === estado)); }
  function renderIncidencias(list) { const tbody = document.getElementById('tableIncidenciasBody'); if (!list.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-5">No hay incidencias.</td></tr>'; return; } let html = ''; list.forEach(i => { let badgeColor = i.estado === 'RESUELTA' ? 'bg-success' : (i.estado === 'EN PROCESO' ? 'bg-primary' : 'bg-danger'); let prioColor = i.prioridad === 'URGENTE' ? 'text-danger fw-bold' : ''; let fotoBtn = i.urlFoto ? `<a href="${i.urlFoto}" target="_blank" class="btn btn-sm btn-outline-secondary ms-1" title="Ver Foto"><i class="bi bi-image"></i></a>` : ''; let editBtn = i.estado !== 'RESUELTA' ? `<button class="btn btn-sm btn-light border text-secondary me-1" onclick="editIncidencia('${i.id}')" title="Editar datos"><i class="bi bi-pencil"></i></button>` : ''; let actionBtn = i.estado !== 'RESUELTA' ? `<div class="btn-group">${editBtn}<button class="btn btn-sm btn-outline-primary" onclick="updateIncidencia('${i.id}', 'EN PROCESO')" title="En Proceso"><i class="bi bi-play-fill"></i></button><button class="btn btn-sm btn-success" onclick="updateIncidencia('${i.id}', 'RESUELTA')" title="Resolver"><i class="bi bi-check-lg"></i></button></div>` : '<span class="text-success small"><i class="bi bi-check-circle"></i> Cerrada</span>'; html += `<tr><td class="ps-4"><span class="badge ${badgeColor}">${i.estado}</span></td><td class="${prioColor}">${i.prioridad}</td><td><div class="fw-bold">${i.nombreOrigen}</div><small class="text-muted">${i.tipoOrigen}</small></td><td>${i.descripcion} ${fotoBtn}</td><td><div class="small">${i.fecha}</div><small class="text-muted">${i.solicitante}</small></td><td class="text-end pe-4">${actionBtn}</td></tr>`; }); tbody.innerHTML = html; refreshSecurityIcons(); }
  function updateIncidencia(id, nuevoEstado) { confirmarAccion(`¿Marcar como ${nuevoEstado}?`, "", () => { google.script.run.withSuccessHandler(res => { if (res.success) { notificarExito("Estado actualizado"); loadIncidencias(); } else notificarError(res.error); }).actualizarEstadoIncidencia(id, nuevoEstado); }); }
  function openReportModal() { if (!reportModal) reportModal = new bootstrap.Modal(document.getElementById('reportModal')); document.getElementById('repId').value = ""; document.getElementById('repDesc').value = ''; document.getElementById('repFoto').disabled = false; document.querySelector('#reportModal .modal-title').innerHTML = '<i class="bi bi-exclamation-circle"></i> Reportar Avería'; const btn = document.getElementById('btnReportSubmit'); btn.innerText = 'Enviar Reporte'; btn.disabled = false; clearReportImage(); const repCampus = document.getElementById('repCampus'); if (repCampus.options.length <= 1) { google.script.run.withSuccessHandler(list => { let html = '<option value="">Seleccione Campus...</option>'; list.forEach(c => html += `<option value="${c.id}">${c.nombre}</option>`); repCampus.innerHTML = html; }).getListaCampus(); } document.getElementById('repEdificio').innerHTML = '<option value="">Seleccione Edificio...</option>'; document.getElementById('repEdificio').disabled = true; document.getElementById('repActivo').innerHTML = '<option value="">(Opcional) Selecciona Activo...</option>'; document.getElementById('repActivo').disabled = true; reportModal.show(); }
  function editIncidencia(id) { if (!reportModal) reportModal = new bootstrap.Modal(document.getElementById('reportModal')); reportModal.show(); const overlay = document.getElementById('repLoadingOverlay'); overlay.classList.remove('d-none'); const btn = document.getElementById('btnReportSubmit'); btn.innerText = 'Guardar Cambios'; btn.disabled = true; clearReportImage(); document.getElementById('repId').value = id; document.querySelector('#reportModal .modal-title').innerHTML = '<i class="bi bi-pencil-square"></i> Editar Incidencia'; document.getElementById('repFoto').disabled = true; google.script.run.withSuccessHandler(data => { document.getElementById('repDesc').value = data.descripcion; document.getElementById('repPrio').value = data.prioridad; if (data.urlFoto) { const previewBox = document.getElementById('repFotoPreview'); const img = document.getElementById('imgPreview'); img.src = data.urlFoto; previewBox.classList.remove('d-none'); } const repCampus = document.getElementById('repCampus'); google.script.run.withSuccessHandler(list => { let html = '<option value="">Seleccione Campus...</option>'; list.forEach(c => { let isSel = (String(c.id) === String(data.idCampus)) ? 'selected' : ''; html += `<option value="${c.id}" ${isSel}>${c.nombre}</option>`; }); repCampus.innerHTML = html; if (data.idCampus) { loadEdificiosReport(data.idCampus, data.idEdificio, data.idActivo); } else { overlay.classList.add('d-none'); btn.disabled = false; } }).getListaCampus(); }).getIncidenciaDetalle(id); }
  function loadEdificiosReport(idCampus, idEdifToSelect, nextAssetId) { const sel = document.getElementById('repEdificio'); const overlay = document.getElementById('repLoadingOverlay'); const btn = document.getElementById('btnReportSubmit'); sel.innerHTML = '<option>Cargando...</option>'; sel.disabled = true; document.getElementById('repActivo').innerHTML = '<option value="">(Opcional) Selecciona Activo...</option>'; document.getElementById('repActivo').disabled = true; if (!idCampus) { sel.innerHTML = '<option value="">Seleccione Edificio...</option>'; return; } google.script.run.withSuccessHandler(list => { let html = '<option value="">Seleccione Edificio...</option>'; list.forEach(e => { let isSel = (String(e.id) === String(idEdifToSelect)) ? 'selected' : ''; html += `<option value="${e.id}" ${isSel}>${e.nombre}</option>`; }); sel.innerHTML = html; sel.disabled = false; if (idEdifToSelect) { loadActivosReport(idEdifToSelect, nextAssetId); } else { if (overlay) overlay.classList.add('d-none'); btn.disabled = false; } }).getEdificiosPorCampus(idCampus); }
  function loadActivosReport(idEdificio, idAssetToSelect) { const sel = document.getElementById('repActivo'); const overlay = document.getElementById('repLoadingOverlay'); const btn = document.getElementById('btnReportSubmit'); sel.innerHTML = '<option>Cargando...</option>'; sel.disabled = true; if (!idEdificio) return; google.script.run.withSuccessHandler(list => { let html = '<option value="">(Opcional) Selecciona Activo...</option>'; list.forEach(a => { let isSel = (String(a.id) === String(idAssetToSelect)) ? 'selected' : ''; html += `<option value="${a.id}" ${isSel}>${a.nombre}</option>`; }); sel.innerHTML = html; sel.disabled = false; if (overlay) overlay.classList.add('d-none'); btn.disabled = false; }).getActivosPorEdificio(idEdificio); }
  function previewReportImage() { const input = document.getElementById('repFoto'); const previewBox = document.getElementById('repFotoPreview'); const img = document.getElementById('imgPreview'); if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function (e) { img.src = e.target.result; previewBox.classList.remove('d-none'); }; reader.readAsDataURL(input.files[0]); } else { clearReportImage(); } }
  function clearReportImage() { const input = document.getElementById('repFoto'); const previewBox = document.getElementById('repFotoPreview'); if (input) input.value = ''; if (previewBox) previewBox.classList.add('d-none'); if (document.getElementById('imgPreview')) document.getElementById('imgPreview').src = ''; }
  function submitReport() { const idIncidencia = document.getElementById('repId').value; const idCampus = document.getElementById('repCampus').value; const idEdificio = document.getElementById('repEdificio').value; const idActivo = document.getElementById('repActivo').value; const desc = document.getElementById('repDesc').value; const prio = document.getElementById('repPrio').value; const fotoInput = document.getElementById('repFoto'); if (!idEdificio) return notificarError("Por favor, indica al menos el edificio."); if (!desc) return notificarError("Describe brevemente el problema."); let idOrigen = idActivo || idEdificio; let tipoOrigen = idActivo ? 'ACTIVO' : 'EDIFICIO'; let nombreOrigen = ""; if (idActivo) { nombreOrigen = document.getElementById('repActivo').options[document.getElementById('repActivo').selectedIndex].text; } else { nombreOrigen = document.getElementById('repEdificio').options[document.getElementById('repEdificio').selectedIndex].text; } setBtnLoading('btnReportSubmit', true); const finish = (res) => { setBtnLoading('btnReportSubmit', false); if (res.success) { reportModal.hide(); notificarExito(idIncidencia ? "Incidencia actualizada." : "¡Avería reportada!"); if (!document.getElementById('view-incidencias').classList.contains('d-none')) { loadIncidencias(); } } else { notificarError(res.error); } }; const payload = { id: idIncidencia, tipoOrigen: tipoOrigen, idOrigen: idOrigen, nombreOrigen: nombreOrigen, descripcion: desc, prioridad: prio }; if (idIncidencia) { google.script.run.withSuccessHandler(finish).updateIncidenciaData(payload); } else { payload.fotoBase64 = null; payload.mimeType = null; payload.nombreArchivo = null; if (fotoInput.files.length > 0) { const file = fotoInput.files[0]; const r = new FileReader(); r.onload = function (e) { payload.fotoBase64 = e.target.result.split(',')[1]; payload.mimeType = file.type; payload.nombreArchivo = file.name; google.script.run.withSuccessHandler(finish).crearIncidencia(payload); }; r.readAsDataURL(file); } else { google.script.run.withSuccessHandler(finish).crearIncidencia(payload); } } }
  function openFeedbackModal() { if (!feedbackModal) feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal')); document.getElementById('feedTipo').value = 'Sugerencia'; document.getElementById('feedMsg').value = ''; feedbackModal.show(); }
  function submitFeedback() { const tipo = document.getElementById('feedTipo').value; const msg = document.getElementById('feedMsg').value; if (!msg || msg.trim().length < 5) return notificarError("Escribe un mensaje válido."); const btn = document.getElementById('btnFeedSubmit'); const originalText = btn.innerText; btn.disabled = true; btn.innerText = "Enviando..."; google.script.run.withSuccessHandler(res => { btn.disabled = false; btn.innerText = originalText; if (res.success) { feedbackModal.hide(); notificarExito("¡Gracias por tu mensaje!"); } else { notificarError(res.error); } }).enviarFeedback({ tipo: tipo, mensaje: msg }); }

  // ==========================================
  // 8. FUNCIONES CAMPUS, EDIFICIOS, ACTIVOS
  // ==========================================
  function updateMaintFormVisibility() { const tipo = document.getElementById('revTipo').value; const secLegal = document.getElementById('secLegal'); const secRecur = document.getElementById('secRecur'); if (!secLegal || !secRecur) return; secLegal.classList.add('d-none'); secRecur.classList.add('d-none'); if (tipo === 'Legal') { secLegal.classList.remove('d-none'); secRecur.classList.remove('d-none'); } else if (tipo === 'Periódica') { secRecur.classList.remove('d-none'); } }
  function autoFillFrequency() { const sel = document.getElementById('revNorma'); const option = sel.options[sel.selectedIndex]; if (option && option.dataset.dias) { document.getElementById('revFreq').value = option.dataset.dias; document.getElementById('revRecur').checked = true; document.getElementById('secRecurOptions').classList.remove('d-none'); } }
  function loadCampusList() { const tbody = document.getElementById('tableCampusBody'); tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5">Cargando...</td></tr>'; google.script.run.withSuccessHandler(d => { if (!d.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay campus registrados.</td></tr>'; return; } let h = ''; d.forEach(r => { h += `<tr><td class="ps-4 fw-bold text-primary">${r.nombre}</td><td>${r.provincia}</td><td><small>${r.direccion}</small></td><td class="text-end pe-4"><button class="btn btn-sm btn-light border me-1" onclick="openCampusModal('${r.id}', '${r.nombre}', '${r.provincia}', '${r.direccion}')" title="Editar"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteCampus('${r.id}')" title="Borrar"><i class="bi bi-trash"></i></button></td></tr>`; }); tbody.innerHTML = h; refreshSecurityIcons(); }).getTableData('CAMPUS'); }
  function openCampusModal(id, nombre, prov, dir) { if (!campusModal) campusModal = new bootstrap.Modal(document.getElementById('campusModal')); if (id) { document.getElementById('campusModalTitle').innerText = 'Editar Campus'; document.getElementById('campId').value = id; document.getElementById('campNombre').value = nombre; document.getElementById('campProv').value = prov; document.getElementById('campDir').value = dir; } else { document.getElementById('campusModalTitle').innerText = 'Nuevo Campus'; document.getElementById('campId').value = ''; document.getElementById('campNombre').value = ''; document.getElementById('campProv').value = ''; document.getElementById('campDir').value = ''; } campusModal.show(); }
  function submitCampus() { const id = document.getElementById('campId').value; const nombre = document.getElementById('campNombre').value; const prov = document.getElementById('campProv').value; const dir = document.getElementById('campDir').value; if (!nombre) return notificarError("Nombre obligatorio"); setBtnLoading('btnCampusSubmit', true); const finish = (res) => { setBtnLoading('btnCampusSubmit', false); if (res.success) { campusModal.hide(); notificarExito("Campus guardado"); loadCampusList(); } else { notificarError(res.error); } }; if (id) { google.script.run.withSuccessHandler(finish).updateCampus({ id: id, nombre: nombre, provincia: prov, direccion: dir }); } else { google.script.run.withSuccessHandler(finish).crearCampus({ nombre: nombre, provincia: prov, direccion: dir }); } }
  function deleteCampus(id) { confirmarAccion("¿Eliminar Campus?", "Se borrará todo el contenido asociado.", () => { google.script.run.withSuccessHandler(res => { if (res.success) { notificarExito("Campus eliminado"); loadCampusList(); } else notificarError(res.error); }).eliminarCampus(id); }); }
  function loadEdificiosList() { const sel = document.getElementById('filterCampusEdificios'); if (sel && sel.options.length <= 1) { google.script.run.withSuccessHandler(list => { let html = '<option value="">- Todos los Campus -</option>'; list.forEach(c => html += `<option value="${c.nombre}">${c.nombre}</option>`); sel.innerHTML = html; }).getListaCampus(); } const tbody = document.getElementById('tableEdificiosBody'); tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary"></div> Cargando edificios...</td></tr>'; google.script.run.withSuccessHandler(d => { allEdificiosData = d; renderEdificiosTable(d); }).getTableData('EDIFICIOS'); }

  function filterEdificiosList() {
    const campusVal = document.getElementById('filterCampusEdificios').value;
    const searchVal = document.getElementById('searchEdificios').value.toLowerCase();

    // Filtramos sobre todos los datos
    const filtered = allEdificiosData.filter(r => {
      // Comparación segura (evitamos errores si r.campus es null)
      const edificioCampus = r.campus ? String(r.campus) : "";
      const matchCampus = (campusVal === "") || (edificioCampus === campusVal);

      const matchText = r.nombre.toLowerCase().includes(searchVal) ||
        String(r.contacto).toLowerCase().includes(searchVal);

      return matchCampus && matchText;
    });

    // 1. Actualizamos la Lista
    renderEdificiosTable(filtered);

    // 2. Actualizamos el Mapa (¡Aquí estaba la clave!)
    // Solo si el mapa está activo o visible, para ahorrar recursos
    if (mapInstance) {
      renderMarkers(filtered);
    }
  }

  function renderEdificiosTable(data) {
    const tbody = document.getElementById('tableEdificiosBody');

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-5">No hay coincidencias</td></tr>';
      return;
    }

    let h = '';
    data.forEach(r => {
      // Aseguramos que no pasamos "undefined" si no hay coordenadas
      const lat = r.lat || '';
      const lng = r.lng || '';

      h += `<tr>
      <td class="ps-4 fw-bold">
        <a href="#" class="text-decoration-none" onclick="openBuildingDetail('${r.id}'); return false;">${r.nombre}</a>
      </td>
      <td><span class="badge bg-light text-dark border">${r.campus}</span></td>
      <td>${r.contacto}</td>
      <td class="text-end pe-4">
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary" onclick="openBuildingDetail('${r.id}')" title="Ver Ficha"><i class="bi bi-eye"></i></button>
          
          <button class="btn btn-sm btn-light border text-secondary" 
             onclick="openEdificioModal('${r.id}', '${r.nombre}', '${r.campus}', '${r.contacto}', '${lat}', '${lng}')" 
             title="Editar">
             <i class="bi bi-pencil"></i>
          </button>
          
          <button class="btn btn-sm btn-outline-danger" onclick="deleteEdificio('${r.id}')" title="Eliminar"><i class="bi bi-trash"></i></button>
        </div>
      </td>
    </tr>`;
    });

    tbody.innerHTML = h;
    refreshSecurityIcons();
  }

  function openEdificioModal(id, nombre, nombreCampus, contacto, lat, lng) {
    if (!edificioModal) edificioModal = new bootstrap.Modal(document.getElementById('edificioModal'));

    // Cargar el select de Campus
    const sel = document.getElementById('edifCampus');
    google.script.run.withSuccessHandler(list => {
      let html = '<option value="">- Seleccione Campus -</option>';
      list.forEach(c => {
        let isSel = (nombreCampus && c.nombre === nombreCampus) ? 'selected' : '';
        html += `<option value="${c.id}" ${isSel}>${c.nombre}</option>`;
      });
      sel.innerHTML = html;
    }).getListaCampus();

    if (id) {
      // MODO EDICIÓN
      document.getElementById('edificioModalTitle').innerText = 'Editar Edificio';
      document.getElementById('edifId').value = id;
      document.getElementById('edifNombre').value = nombre;
      document.getElementById('edifContacto').value = contacto;

      // Rellenar coordenadas (si existen)
      document.getElementById('edifLat').value = lat || '';
      document.getElementById('edifLng').value = lng || '';

    } else {
      // MODO CREACIÓN
      document.getElementById('edificioModalTitle').innerText = 'Nuevo Edificio';
      document.getElementById('edifId').value = '';
      document.getElementById('edifNombre').value = '';
      document.getElementById('edifCampus').value = '';
      document.getElementById('edifContacto').value = '';

      // Limpiar coordenadas
      document.getElementById('edifLat').value = '';
      document.getElementById('edifLng').value = '';
    }

    edificioModal.show();
  }

  // ==========================================
  // FUNCIÓN SUBMIT EDIFICIO (CON VALIDACIÓN DE COORDENADAS)
  // ==========================================

  function submitEdificio() {
    const id = document.getElementById('edifId').value;
    const nombre = document.getElementById('edifNombre').value;
    const idCampus = document.getElementById('edifCampus').value;
    const contacto = document.getElementById('edifContacto').value;

    let rawLat = document.getElementById('edifLat').value;
    let rawLng = document.getElementById('edifLng').value;

    if (!nombre || !idCampus) return notificarError("Nombre y Campus obligatorios");

    // --- FASE 1: LIMPIEZA INTELIGENTE ---
    // Cambiamos comas por puntos para que Javascript lo entienda
    let latTxt = rawLat.replace(/,/g, '.').trim();
    let lngTxt = rawLng.replace(/,/g, '.').trim();

    let latNum = null;
    let lngNum = null;

    // --- FASE 2: CONVERSIÓN A NÚMERO REAL ---
    if (latTxt || lngTxt) {
      latNum = parseFloat(latTxt);
      lngNum = parseFloat(lngTxt);

      // Validación: Que sean números
      if (isNaN(latNum) || isNaN(lngNum)) {
        return notificarError("Las coordenadas no son números válidos.");
      }

      // Validación: Rangos terrestres
      if (latNum < -90 || latNum > 90) return notificarError("Latitud imposible (debe ser entre -90 y 90).");
      if (lngNum < -180 || lngNum > 180) return notificarError("Longitud imposible (debe ser entre -180 y 180).");
    }

    mostrarCargando("Guardando edificio...");

    const finish = (res) => {
      if (edificioModal) edificioModal.hide();
      if (res.success) {
        notificarExito("Edificio guardado correctamente");
        loadEdificiosList();
      } else {
        notificarError(res.error);
      }
    };

    // --- EL CAMBIO CLAVE ESTÁ AQUÍ ---
    // Enviamos 'latNum' (Número) en vez de 'latTxt' (Texto).
    // Si están vacíos, enviamos null.
    const payload = {
      id: id,
      nombre: nombre,
      idCampus: idCampus,
      contacto: contacto,
      lat: latNum !== null ? latNum : "", // Enviamos NÚMERO
      lng: lngNum !== null ? lngNum : ""  // Enviamos NÚMERO
    };

    if (id) {
      google.script.run.withSuccessHandler(finish).updateEdificio(payload);
    } else {
      google.script.run.withSuccessHandler(finish).crearEdificio(payload);
    }
  }

  function deleteEdificio(id) { confirmarAccion("¿Eliminar edificio?", "Se eliminarán sus activos asociados.", () => { google.script.run.withSuccessHandler(res => { if (res.success) { notificarExito("Eliminado"); loadEdificiosList(); } else notificarError(res.error); }).eliminarEdificio(id); }); }
  
  // ==========================================
  // LÓGICA DE ACTIVOS (CARGA TOTAL + FILTRO LOCAL)
  // ==========================================

  function loadAllAssets(preserveState = false) {
      const tbody = document.getElementById('tableActivos');
      
      // Feedback visual (si preservamos estado, no borramos todo, solo indicamos carga)
      if (!preserveState) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary"></div> Cargando todos los activos...</td></tr>';
          
          // Bloquear filtros solo si es una carga desde cero
          document.getElementById('filterCampus').disabled = true;
          document.getElementById('filterEdificio').disabled = true;
          document.getElementById('filterSearch').disabled = true;
      } else {
          // Feedback sutil si estamos refrescando con filtros puestos
          // Opcional: Cambiar el cursor o poner un spinner pequeño en algún lado
          document.body.style.cursor = 'wait';
      }

      google.script.run.withSuccessHandler(list => {
          window.allAssetsData = list;
          document.body.style.cursor = 'default';

          if (!preserveState) {
              // Comportamiento original (carga inicial)
              document.getElementById('filterCampus').disabled = false;
              document.getElementById('filterEdificio').disabled = false;
              document.getElementById('filterSearch').disabled = false;
              renderAssetsTable(list);
          } else {
              // Comportamiento nuevo: MANTENER FILTROS
              // Llamamos a applyAssetFilters() que lee lo que hay seleccionado en los dropdowns
              // y filtra la NUEVA lista (que ya incluye el activo creado)
              applyAssetFilters();
          }

      }).getAllAssetsList();
  }

  function applyAssetFilters() {
    const fCampus = document.getElementById('filterCampus').value;
    const fEdificio = document.getElementById('filterEdificio').value;
    const fSearch = document.getElementById('filterSearch').value.toLowerCase().trim();

    const filtered = window.allAssetsData.filter(item => {
      // 1. Filtro Campus
      // item.idCampus puede ser numero o string, aseguramos con String()
      // Si fCampus está vacío, pasa siempre.
      if (fCampus && String(item.idCampus) !== String(fCampus)) return false;

      // 2. Filtro Edificio
      if (fEdificio && String(item.idEdificio) !== String(fEdificio)) return false;

      // 3. Filtro Texto (Nombre, Marca, Tipo)
      if (fSearch.length > 0) {
        const searchStr = (item.nombre + ' ' + item.marca + ' ' + item.tipo).toLowerCase();
        if (!searchStr.includes(fSearch)) return false;
      }
      return true;
    });
    renderAssetsTable(filtered);
  }

  function renderAssetsTable(list) {
      const tbody = document.getElementById('tableActivos');

      // Usamos renderTableLazy para no bloquear si son muchos
      renderTableLazy(tbody, list, (i, index) => {
        
        // Si tiene docs, mostramos el clip en gris oscuro (text-secondary) o azul (text-primary)
        let clipIcon = i.hasDocs 
          ? '<i class="bi bi-paperclip text-primary ms-2" title="Tiene documentación adjunta"></i>' 
          : '';

        return `<tr>
          <td class="fw-bold ps-4">
              <i class="bi bi-box-seam text-primary me-2"></i>${i.nombre} ${clipIcon}
              <div class="small text-muted fw-normal ms-4">${i.edificioNombre}</div>
          </td>
          <td><span class="badge bg-light text-dark border">${i.tipo}</span></td>
          <td>${i.marca}</td>
          <td class="text-end pe-4"><button class="btn btn-sm btn-outline-primary" onclick="openAssetDetail('${i.id}')">Ver Ficha</button></td>
          </tr>`;
      }, 50); // Página de 50 en 50
  }

  // Modificamos loadEdificios para que NO borre la tabla, solo actualice el selector
  function loadEdificios(idCampus) {
    // 1. Aplicar filtro al dataset (instantáneo)
    // Al cambiar campus, el edificio seleccionado ya no es válido, lo reseteamos
    document.getElementById('filterEdificio').value = "";
    applyAssetFilters();

    // 2. Cargar opciones del selector de edificios en segundo plano
    const s = document.getElementById('filterEdificio');
    s.innerHTML = '<option value="">Cargando...</option>';
    s.disabled = true;

    if (!idCampus) {
      s.innerHTML = '<option value="">- Seleccione -</option>';
      s.disabled = false; // Lo habilitamos aunque sea "todos"
      return;
    }

    google.script.run.withSuccessHandler(l => {
      let h = '<option value="">- Seleccione -</option>';
      l.forEach(i => h += `<option value="${i.id}">${i.nombre}</option>`);
      s.innerHTML = h;
      s.disabled = false;
    }).getEdificiosPorCampus(idCampus);
  }

  function loadEdificiosModal(idCampus, preSelectedId = null) {
      const s = document.getElementById('fEdificioModal');
      s.disabled = true;
      s.innerHTML = '<option>Cargando...</option>';
      
      if (!idCampus) return;
      
      google.script.run.withSuccessHandler(l => {
          let h = '<option value="">- Seleccione -</option>';
          l.forEach(i => {
              // Si coincide con el preseleccionado, añadimos 'selected'
              const selected = (preSelectedId && String(i.id) === String(preSelectedId)) ? 'selected' : '';
              h += `<option value="${i.id}" ${selected}>${i.nombre}</option>`;
          });
          s.innerHTML = h;
          s.disabled = false;
      }).getEdificiosPorCampus(idCampus);
  }

  // Modificamos loadActivos (que se llama al cambiar edificio) para que solo filtre
  function loadActivos(idEdificio) {
    applyAssetFilters();
  }

  // Reemplazamos filterAssets vieja por la nueva applyAssetFilters en el evento onkeyup
  function filterAssets() {
    applyAssetFilters();
  }

  function mostrarModalCrear(t) {
    if (myModal) {
        document.getElementById('createForm').reset();
        document.getElementById('modalType').value = t;
        document.getElementById('modalTitle').innerText = 'Crear ' + t;
        const ex = document.getElementById('extraFields');
        ex.innerHTML = '';

        if (t === 'CAMPUS') {
            ex.innerHTML = `<div class="mb-2"><label>Provincia</label><input id="fProv" class="form-control"></div><div class="mb-2"><label>Dirección</label><input id="fDir" class="form-control"></div>`;
        } 
        else if (t === 'EDIFICIO') {
            ex.innerHTML = `<div class="mb-2"><label>Campus</label><select id="fCampus" class="form-select"><option>Cargando...</option></select></div><div class="mb-2"><label>Contacto</label><input id="fCont" class="form-control"></div>`;
            google.script.run.withSuccessHandler(l => {
                let h = '';
                l.forEach(i => { h += `<option value="${i.id}">${i.nombre}</option>` });
                document.getElementById('fCampus').innerHTML = h;
            }).getListaCampus();
        } 
        else if (t === 'ACTIVO') {
            // 1. Leemos los filtros activos en la pantalla principal
            const filterCampusVal = document.getElementById('filterCampus').value;
            const filterEdificioVal = document.getElementById('filterEdificio').value;

            ex.innerHTML = `<div class="mb-2"><label>1. Campus</label><select id="fCampusModal" class="form-select" onchange="loadEdificiosModal(this.value)"><option value="">Cargando...</option></select></div><div class="mb-2"><label>2. Edificio</label><select id="fEdificioModal" class="form-select" disabled><option value="">- Seleccione Campus -</option></select></div><div class="mb-2"><label>Tipo Instalación</label><select id="fTipo" class="form-select" disabled><option>Cargando...</option></select></div><div class="mb-2"><label>Marca</label><input id="fMarca" class="form-control"></div>`;
            
            // 2. Cargamos lista de Campus preseleccionando si hay filtro
            google.script.run.withSuccessHandler(l => {
                let h = '<option value="">- Seleccione -</option>';
                l.forEach(i => {
                    // Si el campus coincide con el filtro, lo marcamos como selected
                    const selected = (filterCampusVal && String(i.id) === String(filterCampusVal)) ? 'selected' : '';
                    h += `<option value="${i.id}" ${selected}>${i.nombre}</option>`;
                });
                document.getElementById('fCampusModal').innerHTML = h;

                // Si hay un campus preseleccionado, disparamos la carga de edificios automáticamente
                if (filterCampusVal) {
                    loadEdificiosModal(filterCampusVal, filterEdificioVal);
                }

            }).getListaCampus();

            // 3. Cargamos catálogo de Tipos ORDENADO ALFABÉTICAMENTE
            google.script.run.withSuccessHandler(ts => {
                
                // Ordenar alfabéticamente (ignorando mayúsculas/minúsculas y acentos)
                ts.sort((a, b) => a.nombre.localeCompare(b.nombre));

                let o = '<option value="">- Seleccione -</option>';
                ts.forEach(t => { 
                    o += `<option value="${t.id}">${t.nombre}</option>` 
                });
                
                document.getElementById('fTipo').innerHTML = o;
                document.getElementById('fTipo').disabled = false;

            }).getCatalogoInstalaciones();
        }
        myModal.show();
    }
  }

  function submitCreate() {
      const t = document.getElementById('modalType').value;
      const n = document.getElementById('fNombre').value;
      const btnId = 'btnCreateSubmit';
      
      setBtnLoading(btnId, true);

      const cb = (r) => {
        setBtnLoading(btnId, false);
        if (r.success) {
            if (myModal) myModal.hide();
            notificarExito("Creado correctamente");
            
            if (t === 'ACTIVO') {
                // 1. Borramos la caché local
                window.allAssetsData = []; 
                // 2. CAMBIO CLAVE: Pasamos 'true' para mantener los filtros activos
                loadAllAssets(true); 
            } 
            else if (t === 'EDIFICIO') {
                navTo('edificios');
            } else {
                navTo('campus');
            }
            
        } else {
            notificarError(r.error);
        }
      };

      if (t === 'CAMPUS') {
          google.script.run.withSuccessHandler(cb).crearCampus({
              nombre: n,
              provincia: document.getElementById('fProv').value,
              direccion: document.getElementById('fDir').value
          });
      } else if (t === 'EDIFICIO') {
          google.script.run.withSuccessHandler(cb).crearEdificio({
              nombre: n,
              idCampus: document.getElementById('fCampus').value,
              contacto: document.getElementById('fCont').value
          });
      } else if (t === 'ACTIVO') {
          const idEd = document.getElementById('fEdificioModal').value;
          const tipo = document.getElementById('fTipo').value;
          if (!idEd || !tipo) {
              notificarError("Completa todos los campos");
              setBtnLoading(btnId, false);
              return;
          }
          google.script.run.withSuccessHandler(cb).crearActivo({
              nombre: n,
              idEdificio: idEd,
              tipo: tipo,
              marca: document.getElementById('fMarca').value
          });
      }
  }

  let searchTimeout = null;
  function handleGlobalSearch(e) { if (e.key === 'Escape') { closeSearchResults(); return; } const txt = document.getElementById('globalSearchInput').value; if (searchTimeout) clearTimeout(searchTimeout); if (txt.length < 3) { closeSearchResults(); return; } searchTimeout = setTimeout(() => { executeGlobalSearch(); }, 300); }

  function executeGlobalSearch() {
    const txt = document.getElementById('globalSearchInput').value;
    if (!txt || txt.length < 3) {
      closeSearchResults();
      return;
    }

    const resContainer = document.getElementById('globalSearchResults');
    resContainer.innerHTML = '<div class="list-group-item text-center text-muted small"><span class="spinner-border spinner-border-sm"></span> Buscando...</div>';
    resContainer.classList.remove('d-none');

    console.log('🔍 Buscando:', txt); // Log para debug

    google.script.run
      .withSuccessHandler(resultados => {
        console.log('✅ Resultados recibidos:', resultados); // Log para debug

        if (!resultados || resultados.length === 0) {
          resContainer.innerHTML = '<div class="list-group-item text-center text-muted small">No hay coincidencias</div>';
        } else {
          let html = '';
          resultados.forEach(r => {
            let icon = r.tipo === 'ACTIVO'
              ? '<i class="bi bi-box-seam text-primary"></i>'
              : '<i class="bi bi-building text-success"></i>';

            html += `
              <button type="button" class="list-group-item list-group-item-action small" onclick="goToResult('${r.id}', '${r.tipo}')">
                <div class="d-flex w-100 justify-content-between align-items-center">
                  <strong class="mb-1 text-truncate" style="max-width: 150px;">${icon} ${r.texto}</strong>
                </div>
                <small class="text-muted d-block text-truncate">${r.subtexto}</small>
              </button>
            `;
          });
          resContainer.innerHTML = html;
        }
      })
      .withFailureHandler(error => {
        console.error('❌ Error en búsqueda:', error); // Log para debug
        resContainer.innerHTML = '<div class="list-group-item text-center text-danger small">Error: ' + error.message + '</div>';
      })
      .buscarGlobal(txt);
  }

  function closeSearchResults() { const resContainer = document.getElementById('globalSearchResults'); if (resContainer) { resContainer.classList.add('d-none'); resContainer.innerHTML = ''; } }
  function goToResult(id, tipo) { closeSearchResults(); document.getElementById('globalSearchInput').value = ''; if (tipo === 'ACTIVO') { navTo('activos'); openAssetDetail(id); } else if (tipo === 'EDIFICIO') { navTo('edificios'); openBuildingDetail(id); } }
  document.addEventListener('click', function (e) { const container = document.querySelector('.input-group'); const results = document.getElementById('globalSearchResults'); if (container && !container.contains(e.target) && results && !results.contains(e.target)) { closeSearchResults(); } });

  function initFilters() { const sel = document.getElementById('filterCampus'); if (campusLoaded || (sel && sel.options.length > 1)) return; if (sel) { google.script.run.withSuccessHandler(l => { let h = '<option value="">- Seleccione -</option>'; l.forEach(i => h += `<option value="${i.id}">${i.nombre}</option>`); sel.innerHTML = h; campusLoaded = true; }).getListaCampus(); } }
  function openAssetDetail(id, fromView) { currentAssetId = id; currentActiveAssetId = id; if (fromView) lastView = fromView; else lastView = 'activos'; document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none')); document.getElementById('view-asset-detail').classList.remove('d-none'); toggleEditInfo(false); document.getElementById('detail-name').innerText = "Cargando..."; google.script.run.withSuccessHandler(info => { document.getElementById('detail-name').innerText = info.nombre; document.getElementById('detail-type').innerText = info.tipo; document.getElementById('d-nombre-val').innerText = info.nombre; document.getElementById('d-tipo-val').innerText = info.tipo; document.getElementById('d-marca-val').innerText = info.marca; document.getElementById('d-fecha-val').innerText = info.fechaAlta; document.getElementById('edit-nombre').value = info.nombre; document.getElementById('edit-marca').value = info.marca; loadDocs(); loadMaint(); loadContracts(); }).getAssetInfo(id); } function closeAssetDetail() { currentAssetId = null; currentActiveAssetId = null; document.getElementById('view-asset-detail').classList.add('d-none'); if (lastView === 'edificio' && currentBuildingId) { document.getElementById('view-building-detail').classList.remove('d-none'); } else { document.getElementById('view-activos').classList.remove('d-none'); } } function openBuildingDetail(id) { currentBuildingId = id; document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none')); document.getElementById('view-building-detail').classList.remove('d-none'); document.getElementById('b-detail-name').innerText = "Cargando..."; google.script.run.withSuccessHandler(info => { document.getElementById('b-detail-name').innerText = info.nombre; document.getElementById('b-detail-campus').innerText = info.campus; document.getElementById('bd-nombre').innerText = info.nombre; document.getElementById('bd-campus').innerText = info.campus; document.getElementById('bd-contacto').innerText = info.contacto; loadBuildingDocs(); }).getBuildingInfo(id); } function closeBuildingDetail() { currentBuildingId = null; document.getElementById('view-building-detail').classList.add('d-none'); document.getElementById('view-edificios').classList.remove('d-none'); } function loadBuildingDocs() { if (!currentBuildingId) return; const tbody = document.getElementById('buildingDocsBody'); tbody.innerHTML = '<tr><td colspan="4" class="text-center">Cargando...</td></tr>'; google.script.run.withSuccessHandler(docs => { let html = docs.length ? '' : '<tr><td colspan="4" class="text-center text-muted">Sin documentación asociada</td></tr>'; docs.forEach(d => { html += `<tr><td class="ps-3"><i class="bi bi-file-earmark-pdf text-danger me-2"></i><a href="${d.url}" target="_blank" class="text-decoration-none text-dark">${d.nombre}</a></td><td>${d.fecha}</td><td class="small text-muted">Usuario</td><td class="text-end pe-3"><button class="btn btn-sm btn-outline-danger" onclick="deleteDocBuilding('${d.id}')"><i class="bi bi-trash"></i></button></td></tr>`; }); tbody.innerHTML = html; refreshSecurityIcons(); }).obtenerDocs(currentBuildingId, 'EDIFICIO'); } function uploadBuildingFile() { const file = document.getElementById('fileInputBuilding').files[0]; if (!file || !currentBuildingId) return notificarError("Selecciona archivo"); const st = document.getElementById('uploadStatusBuilding'); st.innerText = 'Subiendo...'; const r = new FileReader(); r.onload = function (e) { const content = e.target.result.split(',')[1]; google.script.run.withSuccessHandler(res => { st.innerText = 'Subido'; document.getElementById('fileInputBuilding').value = ''; notificarExito("Documento subido"); loadBuildingDocs(); }).subirArchivo(content, file.name, file.type, currentBuildingId, 'EDIFICIO'); }; r.readAsDataURL(file); } function deleteDocBuilding(id) { confirmarAccion("¿Eliminar documento?", "", () => { google.script.run.withSuccessHandler(() => { notificarExito("Eliminado"); loadBuildingDocs(); }).eliminarDocumento(id); }); }
  function showModalObra() { if (!obraModal) obraModal = new bootstrap.Modal(document.getElementById('obraModal')); document.getElementById('obraNombre').value = ''; document.getElementById('obraDesc').value = ''; document.getElementById('obraFecha').value = ''; document.getElementById('obraFileInit').value = ''; obraModal.show(); } function submitObra() { const n = document.getElementById('obraNombre').value; const d = document.getElementById('obraDesc').value; const f = document.getElementById('obraFecha').value; const fileInput = document.getElementById('obraFileInit'); if (!n) return notificarError("Nombre obligatorio"); setBtnLoading('btnObraSubmit', true); google.script.run.withSuccessHandler(res => { if (res.success) { if (fileInput.files.length > 0) { const file = fileInput.files[0]; const r = new FileReader(); r.onload = function (e) { const content = e.target.result.split(',')[1]; google.script.run.withSuccessHandler(uploadRes => { finishSubmitObra(); }).subirArchivo(content, file.name, file.type, res.newId, 'OBRA'); }; r.readAsDataURL(file); } else { finishSubmitObra(); } } else { notificarError(res.error); setBtnLoading('btnObraSubmit', false); } }).crearObra({ idEdificio: currentBuildingId, nombre: n, descripcion: d, fechaInicio: f }); } function finishSubmitObra() { setBtnLoading('btnObraSubmit', false); if (obraModal) obraModal.hide(); notificarExito("Obra registrada"); loadBuildingObras(); } function finalizarObraJS(id) { const hoy = new Date().toISOString().split('T')[0]; const fechaFin = prompt("Fecha fin (YYYY-MM-DD):", hoy); if (fechaFin) google.script.run.withSuccessHandler(res => { if (res.success) { notificarExito("Obra finalizada"); loadBuildingObras(); } else notificarError(res.error); }).finalizarObra(id, fechaFin); } function loadBuildingObras() { if (!currentBuildingId) return; const container = document.getElementById('buildingObrasList'); container.innerHTML = '<div class="col-12 text-center py-4"><div class="spinner-border text-primary"></div></div>'; google.script.run.withSuccessHandler(obras => { if (!obras.length) { container.innerHTML = '<div class="col-12 text-center text-muted fst-italic">No hay obras registradas.</div>'; return; } let html = ''; obras.forEach(o => { let clipClass = o.hasDocs ? 'text-primary' : 'text-muted'; let btnFinalizar = o.estado !== 'FINALIZADA' ? `<button class="btn btn-sm btn-outline-success me-2" onclick="finalizarObraJS('${o.id}')"><i class="bi bi-check-circle"></i> Finalizar</button>` : ''; let badgeColor = o.estado === 'FINALIZADA' ? 'bg-success' : 'bg-warning text-dark'; html += `<div class="col-md-6"><div class="card h-100 border shadow-sm"><div class="card-body"><div class="d-flex justify-content-between"><h5 class="card-title fw-bold text-primary">${o.nombre}</h5><span class="badge ${badgeColor} align-self-start">${o.estado}</span></div><p class="card-text small text-muted mb-2">${o.descripcion}</p><div class="d-flex align-items-center text-muted small mb-3"><i class="bi bi-calendar-event me-2"></i> Inicio: ${o.fecha}</div><div class="border-top pt-2"><div class="d-flex justify-content-between align-items-center mb-2"><strong class="small"><i class="bi bi-paperclip ${clipClass}"></i> Evidencias</strong><label class="btn btn-sm btn-light border py-0" style="font-size:0.8rem;">+ <input type="file" hidden onchange="uploadObraDoc(this, '${o.id}')"></label></div><div id="obra-docs-${o.id}" class="small"><button class="btn btn-link p-0 text-decoration-none small" onclick="toggleObraDocs('${o.id}')">Ver documentos</button></div></div></div><div class="card-footer bg-white border-top-0 text-end">${btnFinalizar}<button class="btn btn-sm btn-outline-danger" onclick="deleteObra('${o.id}')"><i class="bi bi-trash"></i></button></div></div></div>`; }); container.innerHTML = html; refreshSecurityIcons(); }).getObrasPorEdificio(currentBuildingId); } function uploadObraDoc(input, idObra) { const file = input.files[0]; if (!file) return; const container = document.getElementById('obra-docs-' + idObra); container.innerHTML = '<span class="text-muted">Subiendo...</span>'; const r = new FileReader(); r.onload = function (e) { const content = e.target.result.split(',')[1]; google.script.run.withSuccessHandler(res => { loadBuildingObras(); }).subirArchivo(content, file.name, file.type, idObra, 'OBRA'); }; r.readAsDataURL(file); } function toggleObraDocs(idObra) { const container = document.getElementById('obra-docs-' + idObra); container.innerHTML = '<div class="spinner-border spinner-border-sm"></div>'; google.script.run.withSuccessHandler(docs => { if (!docs.length) { container.innerHTML = '<span class="text-muted fst-italic">Vacío</span>'; return; } let h = '<ul class="list-unstyled mb-0">'; docs.forEach(d => { h += `<li class="d-flex justify-content-between align-items-center mb-1"><a href="${d.url}" target="_blank" class="text-truncate" style="max-width:200px;">${d.nombre}</a><i class="bi bi-x text-danger" style="cursor:pointer;" onclick="deleteDocBuilding('${d.id}')"></i></li>`; }); h += '</ul>'; container.innerHTML = h; }).obtenerDocs(idObra, 'OBRA'); } function deleteObra(id) { confirmarAccion("¿Borrar obra?", "", () => { google.script.run.withSuccessHandler(() => loadBuildingObras()).eliminarObra(id); }); } function loadBuildingAssets() { if (!currentBuildingId) return; const tbody = document.getElementById('buildingAssetsBody'); const select = document.getElementById('filterAssetTypeBuilding'); tbody.innerHTML = '<tr><td colspan="4" class="text-center">Cargando...</td></tr>'; google.script.run.withSuccessHandler(list => { if (!list.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center">Sin activos</td></tr>'; return; } const tiposUnicos = [...new Set(list.map(item => item.tipo))].sort(); let options = '<option value="">- Todos los tipos -</option>'; tiposUnicos.forEach(t => options += `<option value="${t}">${t}</option>`); select.innerHTML = options; renderBuildingAssetsTable(list); window.currentBuildingAssetsList = list; }).getActivosPorEdificio(currentBuildingId); } function filterBuildingAssets() { const tipo = document.getElementById('filterAssetTypeBuilding').value; const list = window.currentBuildingAssetsList || []; if (!tipo) renderBuildingAssetsTable(list); else renderBuildingAssetsTable(list.filter(a => a.tipo === tipo)); } function renderBuildingAssetsTable(list) { const tbody = document.getElementById('buildingAssetsBody'); if (!list.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay coincidencias</td></tr>'; return; } let html = ''; list.forEach(a => { html += `<tr><td class="ps-3 fw-bold">${a.nombre}</td><td><span class="badge bg-light text-dark border">${a.tipo}</span></td><td>${a.marca}</td><td class="text-end pe-3"><button class="btn btn-sm btn-outline-primary" onclick="openAssetDetail('${a.id}', 'edificio')">Ir a Activo</button></td></tr>`; }); tbody.innerHTML = html; refreshSecurityIcons(); }
  function loadMaint() { if (!currentAssetId) return; const tbody = document.getElementById('maintTableBody'); tbody.innerHTML = '<tr><td colspan="4" class="text-center">Cargando...</td></tr>'; google.script.run.withSuccessHandler(list => { if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay mantenimiento programado</td></tr>'; return; } let html = ''; list.forEach(p => { let dotClass = 'bg-secondary'; if (p.color === 'rojo') dotClass = 'bg-rojo'; if (p.color === 'amarillo') dotClass = 'bg-amarillo'; if (p.color === 'verde') dotClass = 'bg-verde'; let clipIcon = p.hasDocs ? '<i class="bi bi-paperclip text-primary ms-2" title="Adjuntos"></i>' : ''; let calIcon = p.hasCalendar ? '<i class="bi bi-calendar-check text-success ms-2" title="Sync Calendar"></i>' : ''; html += `<tr class="align-middle"><td class="text-center"><span class="dot ${dotClass}"></span></td><td>${p.tipo} ${clipIcon} ${calIcon}</td><td>${p.fechaProxima}</td><td class="text-end"><div class="btn-group"><button class="btn btn-sm btn-light border" onclick="editRevision('${p.id}', '${p.tipo}', '${p.fechaISO}', null, ${p.hasCalendar})"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteRevision('${p.id}')"><i class="bi bi-trash"></i></button></div></td></tr>`; }); tbody.innerHTML = html; refreshSecurityIcons(); }).obtenerPlanMantenimiento(currentAssetId); }
  function deleteRevision(id) { confirmarAccion("¿Eliminar revisión?", "", () => { google.script.run.withSuccessHandler(() => { notificarExito("Revisión eliminada"); loadMaint(); }).eliminarRevision(id); }); }
  function editRevision(id, tipo, fecha, activoId, hasCalendar) { document.getElementById('maintModalTitle').innerText = 'Editar Revisión'; document.getElementById('revId').value = id; document.getElementById('revTipo').value = tipo; document.getElementById('revFecha').value = fecha; const chk = document.getElementById('revCalendar'); if (hasCalendar) chk.checked = true; else chk.checked = false; if (activoId) currentActiveAssetId = activoId; document.getElementById('revRecur').checked = false; document.getElementById('revFreq').value = "365"; document.getElementById('revEnd').value = ""; const revNorma = document.getElementById('revNorma'); if (revNorma) revNorma.value = ""; document.getElementById('secRecurOptions').classList.add('d-none'); const assetSelector = document.getElementById('assetSelector'); if (assetSelector) assetSelector.classList.add('d-none'); updateMaintFormVisibility(); loadRevDocs(id); if (maintModal) maintModal.show(); }
  function submitRevision() { const id = document.getElementById('revId').value; const tipo = document.getElementById('revTipo').value; const fecha = document.getElementById('revFecha').value; const isRecursiva = document.getElementById('revRecur').checked; const diasFreq = document.getElementById('revFreq').value; const fechaFin = document.getElementById('revEnd').value; const syncCalendar = document.getElementById('revCalendar').checked; let activeAssetId = currentAssetId || currentActiveAssetId; if (!activeAssetId) { const sel = document.getElementById('maintActivo'); if (sel) activeAssetId = sel.value; } if (!activeAssetId) return notificarError("Debes seleccionar un activo."); if (!tipo || !fecha) return notificarError("Rellena todos los campos."); if (isRecursiva && !fechaFin) return notificarError("Indica fecha límite."); setBtnLoading('btnMaintSubmit', true); const cb = (r) => { setBtnLoading('btnMaintSubmit', false); if (maintModal) maintModal.hide(); if (r.success) { notificarExito("Revisión guardada"); if (currentAssetId) loadMaint(); else loadGlobalMaint(); loadDashboard(); } else { notificarError(r.error); } }; const fail = (e) => { setBtnLoading('btnMaintSubmit', false); notificarError(e.message); }; const payload = { idActivo: activeAssetId, idPlan: id, tipo: tipo, fechaProx: fecha, esRecursiva: isRecursiva, diasFreq: diasFreq, fechaFin: fechaFin, syncCalendar: syncCalendar }; if (id) { google.script.run.withSuccessHandler(cb).withFailureHandler(fail).updateRevision(payload); } else { google.script.run.withSuccessHandler(cb).withFailureHandler(fail).crearRevision(payload); } }
  function loadRevDocs(idRevision) { const container = document.getElementById('revDocsList'); container.innerHTML = '<div class="text-center text-muted"><span class="spinner-border spinner-border-sm"></span></div>'; google.script.run.withSuccessHandler(docs => { if (!docs || docs.length === 0) { container.innerHTML = '<div class="text-center text-muted fst-italic py-2">Sin evidencias adjuntas</div>'; return; } let html = '<ul class="list-group list-group-flush bg-transparent">'; docs.forEach(d => { html += `<li class="list-group-item bg-transparent d-flex justify-content-between align-items-center p-1"><a href="${d.url}" target="_blank" class="text-decoration-none text-truncate" style="max-width: 250px;"><i class="bi bi-file-earmark-text text-danger"></i> ${d.nombre}</a><button class="btn btn-sm text-danger py-0" onclick="deleteRevDoc('${d.id}')">&times;</button></li>`; }); html += '</ul>'; container.innerHTML = html; }).obtenerDocs(idRevision, 'REVISION'); }
  function uploadRevDoc() { const idRevision = document.getElementById('revId').value; const fileInput = document.getElementById('revFileInput'); const file = fileInput.files[0]; const status = document.getElementById('revUploadStatus'); if (!idRevision) return notificarError("Primero guarda la revisión."); if (!file) return notificarError("Selecciona un archivo."); status.innerText = "Subiendo..."; const btn = event.target; btn.disabled = true; const r = new FileReader(); r.onload = function (e) { const content = e.target.result.split(',')[1]; google.script.run.withSuccessHandler(res => { btn.disabled = false; status.innerText = ""; fileInput.value = ""; if (res.success) { notificarExito("Subido"); loadRevDocs(idRevision); } else { notificarError(res.error); } }).subirArchivo(content, file.name, file.type, idRevision, 'REVISION'); }; r.readAsDataURL(file); }
  function deleteRevDoc(idDoc) { confirmarAccion("¿Eliminar archivo?", "", () => { google.script.run.withSuccessHandler(res => { if (res.success) { notificarExito("Eliminado"); const idRev = document.getElementById('revId').value; loadRevDocs(idRev); } }).eliminarDocumento(idDoc); }); }
  function loadConfigList() { const tbody = document.getElementById('tableConfigBody'); tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary"></div> Cargando...</td></tr>'; google.script.run.withSuccessHandler(list => { if (!list || list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No hay tipos definidos. Crea el primero.</td></tr>'; return; } let html = ''; list.forEach(item => { html += `<tr><td class="ps-4 fw-bold">${item.nombre}</td><td><span class="badge bg-light text-dark border">${item.normativa || '-'}</span></td><td>${item.dias ? item.dias + ' días' : '-'}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border me-1" onclick="openConfigModal('${item.id}', '${item.nombre}', '${item.normativa}', '${item.dias}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('${item.id}')"><i class="bi bi-trash"></i></button></td></tr>`; }); tbody.innerHTML = html; refreshSecurityIcons(); }).getConfigCatalogo(); }
  function openConfigModal(id, nombre, norma, dias) { if (!configModal) configModal = new bootstrap.Modal(document.getElementById('configModal')); if (id) { document.getElementById('configModalTitle').innerText = 'Editar Tipo'; document.getElementById('confId').value = id; document.getElementById('confNombre').value = nombre; document.getElementById('confNorma').value = (norma === 'undefined' || !norma) ? '' : norma; document.getElementById('confDias').value = (dias === 'undefined' || !dias) ? '' : dias; } else { document.getElementById('configModalTitle').innerText = 'Nuevo Tipo'; document.getElementById('confId').value = ''; document.getElementById('confNombre').value = ''; document.getElementById('confNorma').value = ''; document.getElementById('confDias').value = ''; } configModal.show(); }
  function submitConfig() { const id = document.getElementById('confId').value; const nombre = document.getElementById('confNombre').value; const norma = document.getElementById('confNorma').value; const dias = document.getElementById('confDias').value; if (!nombre) return notificarError("Nombre obligatorio."); setBtnLoading('btnConfigSubmit', true); const payload = { id: id, nombre: nombre, normativa: norma, dias: dias }; google.script.run.withSuccessHandler(res => { setBtnLoading('btnConfigSubmit', false); if (res.success) { configModal.hide(); notificarExito("Guardado"); loadConfigList(); } else { notificarError(res.error); } }).saveConfigCatalogo(payload); }
  function deleteConfig(id) { confirmarAccion("¿Borrar tipo?", "", () => { google.script.run.withSuccessHandler(res => { if (res.success) { notificarExito("Borrado"); loadConfigList(); } else notificarError(res.error); }).deleteConfigCatalogo(id); }); }
  function loadUserList() { const tbody = document.getElementById('tableUsersBody'); tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div> Cargando...</td></tr>'; google.script.run.withSuccessHandler(list => { if (!list || list.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No hay usuarios.</td></tr>'; return; } let html = ''; list.forEach(u => { let badgeRol = u.rol === 'ADMIN' ? 'bg-danger' : (u.rol === 'TECNICO' ? 'bg-primary' : 'bg-secondary'); let iconAvisos = u.avisos === 'SI' ? '<i class="bi bi-bell-fill text-warning"></i>' : '<i class="bi bi-bell-slash text-muted"></i>'; html += `<tr><td class="ps-4 fw-bold">${u.nombre}</td><td>${u.email}</td><td><span class="badge ${badgeRol}">${u.rol}</span></td><td class="text-center fs-5">${iconAvisos}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border me-1" onclick="openUserModal('${u.id}', '${u.nombre}', '${u.email}', '${u.rol}', '${u.avisos}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.id}')"><i class="bi bi-trash"></i></button></td></tr>`; }); tbody.innerHTML = html; refreshSecurityIcons(); }).getListaUsuarios(); }
  function openUserModal(id, nombre, email, rol, avisos) { if (!userModal) userModal = new bootstrap.Modal(document.getElementById('userModal')); if (id) { document.getElementById('userModalTitle').innerText = 'Editar Usuario'; document.getElementById('userId').value = id; document.getElementById('userNombre').value = nombre; document.getElementById('userEmail').value = email; document.getElementById('userRol').value = rol; document.getElementById('userAvisos').value = avisos; } else { document.getElementById('userModalTitle').innerText = 'Nuevo Usuario'; document.getElementById('userId').value = ''; document.getElementById('userNombre').value = ''; document.getElementById('userEmail').value = ''; document.getElementById('userRol').value = 'TECNICO'; document.getElementById('userAvisos').value = 'NO'; } userModal.show(); }

  function submitUser() {
    const id = document.getElementById('userId').value;
    const nombre = document.getElementById('userNombre').value;
    const email = document.getElementById('userEmail').value;
    const rol = document.getElementById('userRol').value;
    const avisos = document.getElementById('userAvisos').value;

    if (!nombre || !email) return notificarError("Nombre y Email obligatorios");

    // 1. Bloqueamos la pantalla con el mensaje
    mostrarCargando("Guardando usuario...");

    const payload = { id, nombre, email, rol, avisos };

    google.script.run.withSuccessHandler(res => {
      // 2. Al recibir respuesta, primero cerramos el formulario
      if (userModal) userModal.hide();

      // 3. Mostramos el resultado
      if (res.success) {
        notificarExito("Usuario guardado correctamente");
        loadUserList();
      } else {
        notificarError(res.error);
      }
    }).saveUsuario(payload);
  }
  function deleteUser(id) { confirmarAccion("¿Borrar usuario?", "", () => { google.script.run.withSuccessHandler(res => { if (res.success) { notificarExito("Usuario eliminado"); loadUserList(); } else notificarError(res.error); }).deleteUsuario(id); }); }
  function toggleEditInfo(editable) { if (editable) { document.getElementById('info-view-mode').classList.add('d-none'); document.getElementById('info-edit-mode').classList.remove('d-none'); document.getElementById('btn-edit-info').classList.add('d-none'); document.getElementById('btn-save-info').classList.remove('d-none'); const sel = document.getElementById('edit-tipo'); if (sel.options.length <= 1) { google.script.run.withSuccessHandler(list => { let html = ''; const actual = document.getElementById('d-tipo-val').innerText; list.forEach(t => { const selected = t.nombre === actual ? 'selected' : ''; html += `<option value="${t.nombre}" ${selected}>${t.nombre}</option>`; }); sel.innerHTML = html; }).getCatalogoInstalaciones(); } } else { document.getElementById('info-view-mode').classList.remove('d-none'); document.getElementById('info-edit-mode').classList.add('d-none'); document.getElementById('btn-edit-info').classList.remove('d-none'); document.getElementById('btn-save-info').classList.add('d-none'); } }

  function saveAssetInfo() {
      // Recogemos los nuevos valores
      const nuevoNombre = document.getElementById('edit-nombre').value;
      const nuevaMarca = document.getElementById('edit-marca').value;
      const nuevoTipo = document.getElementById('edit-tipo').value;

      const newData = {
        id: currentAssetId,
        nombre: nuevoNombre,
        marca: nuevaMarca,
        tipo: nuevoTipo
      };

      const btnSave = document.querySelector('#btn-save-info button');
      setBtnLoading('btn-save-info button', true);
      
      // Bloqueo visual
      mostrarCargando("Actualizando activo...");

      google.script.run.withSuccessHandler(res => {
        btnSave.disabled = false;
        btnSave.innerText = "Guardar";

        if (res.success) {
          notificarExito("Info actualizada");
          
          // 1. Actualizamos la vista de DETALLE (donde estamos ahora)
          openAssetDetail(currentAssetId);

          // 2. ACTUALIZACIÓN EN CALIENTE DE LA LISTA (El arreglo clave)
          if (window.allAssetsData) {
              // Buscamos el activo en la memoria local
              const index = window.allAssetsData.findIndex(a => String(a.id) === String(currentAssetId));
              
              if (index !== -1) {
                  // Actualizamos sus propiedades
                  window.allAssetsData[index].nombre = nuevoNombre;
                  window.allAssetsData[index].marca = nuevaMarca;
                  window.allAssetsData[index].tipo = nuevoTipo;
                  
                  // Refrescamos la tabla de fondo manteniendo los filtros
                  applyAssetFilters();
              }
          }

        } else { 
          notificarError(res.error); 
        }
      }).updateAsset(newData);
  }

  function loadDocs() { if (!currentAssetId) return; const tbody = document.getElementById('docsTableBody'); tbody.innerHTML = '<tr><td colspan="4" class="text-center">Cargando...</td></tr>'; google.script.run.withSuccessHandler(docs => { let html = docs.length ? '' : '<tr><td colspan="4" class="text-center text-muted">Sin documentos</td></tr>'; docs.forEach(d => { html += `<tr><td class="ps-3 align-middle"><i class="bi bi-file-earmark-pdf text-danger me-2"></i>${d.nombre}</td><td class="align-middle"><span class="badge bg-secondary">v${d.version}</span></td><td class="align-middle small text-muted">${d.fecha}</td><td class="text-end pe-3"><div class="btn-group"><a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver"><i class="bi bi-eye"></i></a><button class="btn btn-sm btn-outline-danger" onclick="deleteDoc('${d.id}')" title="Eliminar"><i class="bi bi-trash"></i></button></div></td></tr>`; }); tbody.innerHTML = html; refreshSecurityIcons(); }).obtenerDocs(currentAssetId); } function deleteDoc(idDoc) { confirmarAccion("¿Eliminar documento?", "", () => { document.body.style.cursor = 'wait'; google.script.run.withSuccessHandler(res => { document.body.style.cursor = 'default'; if (res.success) { notificarExito("Eliminado"); loadDocs(); } }).eliminarDocumento(idDoc); }); } function uploadFile() { const file = document.getElementById('fileInput').files[0]; if (!file || !currentAssetId) return notificarError("Selecciona archivo"); const btn = document.querySelector('#tab-docs button'), st = document.getElementById('uploadStatus'); btn.disabled = true; st.innerText = 'Subiendo...'; const r = new FileReader(); r.onload = function (e) { google.script.run.withSuccessHandler(res => { btn.disabled = false; st.innerText = 'Subido'; document.getElementById('fileInput').value = ''; notificarExito("Documento subido"); loadDocs(); }).subirArchivo(e.target.result.split(',')[1], file.name, file.type, currentAssetId, 'ACTIVO'); }; r.readAsDataURL(file); } function editContractGlobal(id, ini, fin, estadoDB, prov, ref) { document.getElementById('contModalTitle').innerText = 'Editar Contrato'; document.getElementById('contId').value = id; document.getElementById('contProv').value = prov; document.getElementById('contRef').value = ref; document.getElementById('contIni').value = ini; document.getElementById('contFin').value = fin; document.getElementById('contEstado').value = estadoDB; if (contractModal) contractModal.show(); } function editContract(id, prov, ref, ini, fin, estadoDB) { document.getElementById('contModalTitle').innerText = 'Editar Contrato'; document.getElementById('contId').value = id; document.getElementById('contProv').value = prov; document.getElementById('contRef').value = ref; document.getElementById('contIni').value = ini; document.getElementById('contFin').value = fin; document.getElementById('contEstado').value = estadoDB; if (contractModal) contractModal.show(); } function loadContracts() { if (!currentAssetId) return; const tbody = document.getElementById('contractsTableBody'); tbody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>'; google.script.run.withSuccessHandler(list => { let html = list.length ? '' : '<tr><td colspan="5" class="text-center text-muted">Sin contratos</td></tr>'; list.forEach(c => { let badgeClass = 'bg-secondary'; if (c.color === 'verde') badgeClass = 'bg-success'; if (c.color === 'rojo') badgeClass = 'bg-danger'; if (c.color === 'amarillo') badgeClass = 'bg-warning text-dark'; if (c.color === 'gris') badgeClass = 'bg-secondary'; html += `<tr><td><span class="badge ${badgeClass}">${c.estado}</span></td><td>${c.proveedor}</td><td>${c.ref}</td><td><small>${c.inicio} - ${c.fin}</small></td><td class="text-end"><div class="btn-group"><button class="btn btn-sm btn-light border" onclick="editContract('${c.id}', '${c.proveedor}', '${c.ref}', '${c.inicio}', '${c.fin}', '${c.estadoDB}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteContract('${c.id}')"><i class="bi bi-trash"></i></button></div></td></tr>`; }); tbody.innerHTML = html; refreshSecurityIcons(); }).obtenerContratos(currentAssetId); }

  function deleteContract(id) { confirmarAccion("¿Eliminar contrato?", "", () => { google.script.run.withSuccessHandler(cb => { notificarExito("Eliminado"); if (currentAssetId) loadContracts(); else loadGlobalContracts(); }).eliminarContrato(id); }); }

  // ==========================================
  // FUNCIÓN IMPORTACIÓN MASIVA
  // ==========================================
  let importModal = null;

  function openImportModal() {
    if (!importModal) importModal = new bootstrap.Modal(document.getElementById('importModal'));
    document.getElementById('importData').value = '';
    document.getElementById('importLog').innerText = '';
    importModal.show();
  }

  function ejecutarImportacion() {
    const texto = document.getElementById('importData').value;
    if (!texto.trim()) return notificarError("El área de texto está vacía.");

    // Parsear texto (detecta tabulaciones de Excel)
    const lineas = texto.split('\n');
    const filas = [];

    lineas.forEach(linea => {
      if (linea.trim()) {
        // Excel usa tabulaciones (\t) cuando copias celdas
        const celdas = linea.split('\t');
        // Si solo hay 1 celda, a veces es separador por punto y coma
        if (celdas.length === 1 && linea.includes(';')) {
          filas.push(linea.split(';'));
        } else {
          filas.push(celdas);
        }
      }
    });

    if (filas.length === 0) return notificarError("No se han detectado datos válidos.");

    confirmarAccion(`¿Importar ${filas.length} activos?`, "Asegúrate de que los Campus y Edificios ya existen.", () => {
      setBtnLoading('btnImportRun', true);
      document.getElementById('importLog').innerText = "Procesando... esto puede tardar unos segundos.";

      google.script.run.withSuccessHandler(res => {
        setBtnLoading('btnImportRun', false);

        if (res.success) {
          let msg = `¡Éxito! Se han creado ${res.procesados} activos.`;
          if (res.errores.length > 0) {
            msg += ` Hubo ${res.errores.length} errores. Revisa el log.`;
            // Mostrar errores en pantalla
            let logHtml = '<ul class="mb-0 ps-3">';
            res.errores.forEach(e => logHtml += `<li>${e}</li>`);
            logHtml += '</ul>';
            document.getElementById('importLog').innerHTML = logHtml;
            notificarError("Importación parcial. Revisa los errores.");
          } else {
            importModal.hide();
            notificarExito(msg);
            // Recargar la tabla si hay un edificio seleccionado
            const filtroEdif = document.getElementById('filterEdificio').value;
            if (filtroEdif) loadActivos(filtroEdif);
            loadDashboard();
          }
        } else {
          notificarError(res.error);
        }
      }).procesarCargaMasiva(filas);
    });
  }

  function ocultarLoader() {
    const loader = document.getElementById('app-loader');
    if (loader) {
      loader.style.opacity = '0'; // Efecto desvanecer
      setTimeout(() => {
        loader.style.display = 'none'; // Quitar del todo tras la animación
      }, 500);
    }
  }

  // ==========================================
  // GESTIÓN DE MAPAS (LEAFLET)
  // ==========================================

  function toggleEdificiosView(mode) {
    const listContainer = document.getElementById('container-edif-list');
    const mapContainer = document.getElementById('container-edif-map');
    const btnList = document.getElementById('btnViewList');
    const btnMap = document.getElementById('btnViewMap');

    if (mode === 'LIST') {
      // 1. ANTES de ocultar nada, matamos el mapa para liberar memoria
      destroyMap();

      // 2. Cambiamos la vista
      listContainer.classList.remove('d-none');
      mapContainer.classList.add('d-none');

      // 3. Botones
      btnList.classList.add('active');
      btnMap.classList.remove('active');

    } else {
      // Modo Mapa
      listContainer.classList.add('d-none');
      mapContainer.classList.remove('d-none');

      btnList.classList.remove('active');
      btnMap.classList.add('active');

      // 4. Iniciamos el mapa con un pequeño retardo para asegurar que el div existe
      setTimeout(() => { initLeafletMap(); }, 100);
    }
  }

  // Función auxiliar para matar el mapa y limpiar memoria
  function destroyMap() {
    if (mapInstance) {
      mapInstance.off(); // Apagar eventos
      mapInstance.remove(); // Destruir instancia Leaflet
      mapInstance = null; // Vaciar variable

      // Truco: Limpiamos el HTML interno del contenedor por si acaso quedó basura
      const container = document.getElementById('mapEdificios');
      if (container) container.innerHTML = "";
    }
  }

  function initLeafletMap() {
    // Seguridad: Si ya hay mapa, lo matamos primero
    destroyMap();

    if (typeof L === 'undefined') {
      return notificarError("No se pudo cargar el mapa. Revisa tu conexión.");
    }

    const container = document.getElementById('mapEdificios');
    if (!container) return;

    // Crear mapa nuevo
    mapInstance = L.map('mapEdificios').setView([40.416, -3.703], 5); // Zoom alejado para ver toda España

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap',
      maxZoom: 19
    }).addTo(mapInstance);

    // Renderizar marcadores
    renderMarkers();
  }

  // Aceptamos un parámetro opcional 'data'. 
  // Si no nos pasan nada, usamos 'allEdificiosData' (todos).
  function renderMarkers(data = null) {
    const datosAPintar = data || allEdificiosData;

    if (!mapInstance || !datosAPintar) return;

    // 1. LIMPIEZA: Si ya hay una capa de marcadores, la quitamos del mapa
    if (markersLayer) {
      mapInstance.removeLayer(markersLayer);
      markersLayer = null;
    }

    // Creamos el nuevo grupo
    const newMarkersGroup = L.featureGroup();
    let count = 0;

    datosAPintar.forEach(edif => {
      // Limpieza de coordenadas (igual que antes)
      let rawLat = String(edif.lat).replace(',', '.').trim();
      let rawLng = String(edif.lng).replace(',', '.').trim();
      const lat = parseFloat(rawLat);
      const lng = parseFloat(rawLng);

      if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
        const marker = L.marker([lat, lng]);

        const popupContent = `
          <div class="text-center p-2">
            <h6 class="fw-bold mb-1 text-primary">${edif.nombre}</h6>
            <span class="badge bg-light text-dark border mb-2">${edif.campus}</span><br>
            <div class="d-grid gap-2 mt-2">
              <button class="btn btn-sm btn-primary py-0" onclick="openBuildingDetail('${edif.id}')">
                Ver Edificio
              </button>
            </div>
          </div>
        `;
        marker.bindPopup(popupContent);
        marker.addTo(newMarkersGroup);
        count++;
      }
    });

    // 2. AÑADIR AL MAPA
    if (count > 0) {
      newMarkersGroup.addTo(mapInstance);
      markersLayer = newMarkersGroup; // Guardamos la referencia para poder borrarla luego

      try {
        // Ajustar zoom para ver los pines filtrados
        mapInstance.fitBounds(newMarkersGroup.getBounds().pad(0.2));
      } catch (e) { console.log("Zoom auto ajustado"); }
    }
  }
  // ==========================================
  // GESTIÓN DE NOVEDADES (CHANGELOG)
  // ==========================================

  function openChangelogModal(e) {
    if (e) e.preventDefault();
    if (!changelogModal) changelogModal = new bootstrap.Modal(document.getElementById('changelogModal'));

    // LOGICA AÑADIDA: Mostrar botón solo si es ADMIN
    const btnNew = document.getElementById('btnNewVersion');
    if (currentUser && currentUser.rol === 'ADMIN') {
      btnNew.classList.remove('d-none');
    } else {
      btnNew.classList.add('d-none');
    }

    const container = document.getElementById('changelogContainer');
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

    changelogModal.show();

    google.script.run.withSuccessHandler(data => {
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-center text-muted fst-italic">No hay noticias recientes.</div>';
        return;
      }

      let html = '';
      data.forEach(item => {
        let badgeHtml = '';
        let dotColor = '#6b7280';
        const tipo = String(item.tipo).toUpperCase();

        if (tipo.includes('NUEVO') || tipo.includes('LANZAMIENTO')) {
          badgeHtml = '<span class="badge badge-new ms-2">NUEVO</span>';
          dotColor = '#10b981';
        } else if (tipo.includes('CORRECC') || tipo.includes('BUG')) {
          badgeHtml = '<span class="badge badge-fix ms-2">FIX</span>';
          dotColor = '#ef4444';
        } else {
          badgeHtml = '<span class="badge badge-improvement ms-2">MEJORA</span>';
          dotColor = '#3b82f6';
        }

        html += `
          <div class="timeline-item">
            <div class="timeline-dot" style="border-color: ${dotColor};"></div>
            <div class="timeline-date">${item.fecha} <span class="text-muted mx-1">•</span> <small class="fw-bold">${item.version}</small></div>
            <div class="timeline-title">${item.titulo} ${badgeHtml}</div>
            <div class="timeline-desc">${item.descripcion}</div>
          </div>
        `;
      });
      container.innerHTML = html;
    }).getNovedadesApp();
  }

  function openNewVersionModal() {
    // Cerramos el modal de listado para que no se solapen
    if (changelogModal) changelogModal.hide();

    if (!newVersionModal) newVersionModal = new bootstrap.Modal(document.getElementById('newVersionModal'));

    // Limpiar campos
    document.getElementById('nvVersion').value = '';
    document.getElementById('nvTitulo').value = '';
    document.getElementById('nvDesc').value = '';
    document.getElementById('nvTipo').value = 'MEJORA';

    newVersionModal.show();
  }

  function submitNewVersion() {
    const ver = document.getElementById('nvVersion').value;
    const tit = document.getElementById('nvTitulo').value;
    const desc = document.getElementById('nvDesc').value;
    const tipo = document.getElementById('nvTipo').value;

    if (!ver || !tit || !desc) return notificarError("Por favor completa todos los campos.");

    setBtnLoading('btnNvSubmit', true);

    const datos = {
      version: ver,
      titulo: tit,
      descripcion: desc,
      tipo: tipo
    };

    google.script.run.withSuccessHandler(res => {
      setBtnLoading('btnNvSubmit', false);
      if (res.success) {
        if (newVersionModal) newVersionModal.hide();
        notificarExito("Versión publicada correctamente");
        // Volvemos a abrir el listado para ver la novedad
        setTimeout(() => openChangelogModal(), 500);
      } else {
        notificarError(res.error);
      }
    }).crearNovedad(datos);
  }

  // ==========================================
  // FUNCIÓN MENÚ MÓVIL
  // ==========================================
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');

    // Alternar la clase .active definida en tu CSS
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
  }

  // ==========================================
  // GESTIÓN DE FEEDBACK (ADMIN)
  // ==========================================

  function loadFeedbackList() {
    const container = document.getElementById('feedbackContainer');
    container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div> Cargando buzón...</div>';

    google.script.run.withSuccessHandler(list => {
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted fst-italic py-5"><i class="bi bi-mailbox fs-1 d-block mb-3"></i>El buzón está vacío</div>';
        updateBadgeFeedback(0);
        return;
      }

      let html = '';
      let unreadCount = 0;

      list.forEach(item => {
        if (item.estado === 'NUEVO') unreadCount++;

        // Estilos según estado
        let cardBorder = item.estado === 'NUEVO' ? 'border-primary border-2' : 'border-light';
        let bgHeader = item.estado === 'NUEVO' ? 'bg-primary text-white' : 'bg-light text-muted';
        let iconTipo = item.tipo === 'Error' ? '<i class="bi bi-bug-fill"></i>' : '<i class="bi bi-lightbulb-fill"></i>';

        // Botones de acción
        let buttons = '';
        if (item.estado !== 'ARCHIVADO') {
          buttons += `<button class="btn btn-sm btn-outline-secondary me-2" onclick="setFeedbackState('${item.id}', 'ARCHIVADO')" title="Marcar leído/archivar"><i class="bi bi-check2-all"></i> Archivar</button>`;
        }
        buttons += `<button class="btn btn-sm btn-outline-danger" onclick="setFeedbackState('${item.id}', 'DELETE')" title="Eliminar"><i class="bi bi-trash"></i></button>`;

        html += `
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 shadow-sm ${cardBorder}">
          <div class="card-header ${bgHeader} d-flex justify-content-between align-items-center">
             <span class="fw-bold">${iconTipo} ${item.tipo}</span>
             <small style="font-size:0.75rem">${item.fecha}</small>
          </div>
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-primary small">${item.usuario}</h6>
            <p class="card-text bg-light p-2 rounded fst-italic">"${item.mensaje}"</p>
            <div class="mt-3 text-end">
               ${buttons}
            </div>
          </div>
          <div class="card-footer bg-white border-0 text-muted small">
            Estado: <strong>${item.estado}</strong>
          </div>
        </div>
      </div>`;
      });

      container.innerHTML = html;
      updateBadgeFeedback(unreadCount);

    }).getFeedbackList();
  }

  function setFeedbackState(id, estado) {
    // Efecto visual rápido
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    google.script.run.withSuccessHandler(res => {
      if (res.success) {
        loadFeedbackList(); // Recargamos para ver cambios y actualizar contador
        notificarExito(estado === 'DELETE' ? "Mensaje eliminado" : "Mensaje archivado");
      } else {
        notificarError(res.error);
      }
    }).updateFeedbackStatus(id, estado);
  }

  function updateBadgeFeedback(count) {
    const badge = document.getElementById('badge-feedback');
    if (!badge) return;
    if (count > 0) {
      badge.innerText = count;
      badge.classList.remove('d-none');
    } else {
      badge.classList.add('d-none');
    }
  }

  // ==========================================
  // DESCARGA DE INFORMES PDF
  // ==========================================
  function descargarInforme(tipo) {
    // Feedback visual para el usuario
    const btnId = tipo === 'LEGAL' ? 'btnPdfLegal' : 'btnPdfContratos';
    const btn = document.getElementById(btnId);
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando PDF...';

    google.script.run.withSuccessHandler(res => {
      // Restaurar botón
      btn.disabled = false;
      btn.innerHTML = originalText;

      // TRUCO: Crear enlace invisible y pulsarlo
      const link = document.createElement('a');
      link.href = 'data:application/pdf;base64,' + res.base64;
      link.download = res.filename;
      link.target = '_blank'; // Por seguridad
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      notificarExito("Informe descargado correctamente.");

    }).withFailureHandler(err => {
      btn.disabled = false;
      btn.innerHTML = originalText;
      notificarError("Error al generar PDF: " + err.message);
    }).generarInformePDF(tipo);
  }

  // ==========================================
  // EDICIÓN AVANZADA DE CONTRATOS
  // ==========================================

  function editContractGlobal(id) {
    // 1. Abrimos el modal vacío primero para dar feedback visual
    mostrarModalContrato();
    document.getElementById('contModalTitle').innerText = 'Cargando datos...';
    document.getElementById('btnContSubmit').disabled = true;

    // 2. Pedimos los datos completos al servidor
    google.script.run.withSuccessHandler(data => {

      // Rellenar datos básicos
      document.getElementById('contModalTitle').innerText = 'Editar Contrato';
      document.getElementById('contId').value = data.id;
      document.getElementById('contProv').value = data.proveedor;
      document.getElementById('contRef').value = data.ref;
      document.getElementById('contIni').value = data.inicio;
      document.getElementById('contFin').value = data.fin;
      document.getElementById('contEstado').value = data.estado;

      // 3. LA CASCADA MÁGICA DE UBICACIÓN
      // Seleccionamos Campus y forzamos la carga de edificios
      const selCampus = document.getElementById('contCampus');
      selCampus.value = data.idCampus;

      // Ahora cargamos edificios pasando el ID del campus
      // Usamos una versión manual para poder preseleccionar después
      const selEdif = document.getElementById('contEdificio');
      selEdif.innerHTML = '<option>Cargando...</option>';
      selEdif.disabled = true;

      google.script.run.withSuccessHandler(edificios => {
        let h = '<option value="">- Todo el Edificio (Opcional) -</option>';
        edificios.forEach(e => h += `<option value="${e.id}">${e.nombre}</option>`);
        selEdif.innerHTML = h;
        selEdif.disabled = false;

        // Si el contrato tiene edificio, lo seleccionamos
        if (data.idEdificio) {
          selEdif.value = data.idEdificio;

          // Y cargamos los activos
          const selActivo = document.getElementById('contActivo');
          selActivo.innerHTML = '<option>Cargando...</option>';
          selActivo.disabled = true;

          google.script.run.withSuccessHandler(activos => {
            let ha = '<option value="">- Activo Específico (Opcional) -</option>';
            activos.forEach(a => ha += `<option value="${a.id}">${a.nombre}</option>`);
            selActivo.innerHTML = ha;
            selActivo.disabled = false;

            // Si el contrato tiene activo, lo seleccionamos
            if (data.idActivo) {
              selActivo.value = data.idActivo;
            }
            // Habilitamos botón guardar al final de la cadena
            document.getElementById('btnContSubmit').disabled = false;

          }).getActivosPorEdificio(data.idEdificio);

        } else {
          // Si no hay edificio, terminamos aquí
          document.getElementById('btnContSubmit').disabled = false;
        }

      }).getEdificiosPorCampus(data.idCampus);

    }).getContratoFullDetails(id);
  }

  // ==========================================
  // SISTEMA DE CÓDIGOS QR - VERSION SIMPLIFICADA
  // ==========================================
  function descargarQRActivo() {
    if (!currentAssetId) {
      notificarError("No hay activo seleccionado");
      return;
    }
    notificar("Generando código QR...", "info");
    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          Swal.fire({
            title: result.activo.nombre,
            html: '<p><strong>' + result.activo.tipo + '</strong></p>' +
              '<p>Edificio: ' + result.activo.edificio + '</p>' +
              '<p>Campus: ' + result.activo.campus + '</p>' +
              '<img src="' + result.qrUrl + '" style="width:300px;height:300px;margin:20px 0;">' +
              '<p style="font-size:12px;color:#666;">Escanea para acceder a la ficha</p>',
            showCancelButton: true,
            confirmButtonText: 'Descargar QR',
            cancelButtonText: 'Cerrar',
            confirmButtonColor: '#CC0605',
            width: 500
          }).then(function (res) {
            if (res.isConfirmed) {
              var link = document.createElement('a');
              link.href = result.qrUrl;
              link.download = 'QR_' + result.activo.nombre.replace(/\s+/g, '_') + '.png';
              link.click();
            }
          });
        } else {
          notificarError("Error: " + result.error);
        }
      })
      .withFailureHandler(function (error) {
        notificarError("Error: " + error.message);
      })
      .generarQRActivo(currentAssetId);
  }
  function descargarQRsEdificio() {
    if (!currentBuildingId) {
      notificarError("No hay edificio seleccionado");
      return;
    }
    notificar("Generando PDF con códigos QR...", "info");
    google.script.run
      .withSuccessHandler(function (result) {
        if (result.success) {
          var link = document.createElement('a');
          link.href = 'data:application/pdf;base64,' + result.base64;
          link.download = result.filename;
          link.click();
          notificarExito('PDF generado con ' + result.totalEtiquetas + ' etiquetas QR');
        } else {
          notificarError("Error: " + result.error);
        }
      })
      .withFailureHandler(function (error) {
        notificarError("Error: " + error.message);
      })
      .generarPDFEtiquetasQR(currentBuildingId);
  }
  function detectarAccesoQR() {
    var idActivo = null;

    // 1. Intentar leer desde parámetros de servidor (Deep Linking fiable en GAS)
    if (window.serverParams && window.serverParams.activo) {
      idActivo = window.serverParams.activo;
    }
    // 2. Fallback: Intentar leer URL (a veces falla en iframes)
    else {
      var urlParams = new URLSearchParams(window.location.search);
      idActivo = urlParams.get('activo');
    }

    if (idActivo) {
      // Esperar un poco a que cargue la interfaz base
      setTimeout(function () {
        openAssetDetail(idActivo);
        notificar("Accediendo desde código QR", "success");
      }, 1500); // Aumentado ligeramente el tiempo para asegurar carga
    }
  }

  window.addEventListener('load', detectarAccesoQR);

  // ==========================================
  // GESTIÓN DE RELACIONES ENTRE ACTIVOS
  // ==========================================

  function loadRelacionesActivo() {
    if (!currentAssetId) return;

    const container = document.getElementById('relacionesContainer');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';

    google.script.run.withSuccessHandler(data => {
      renderRelaciones(data.relaciones, data.alertas);
    }).withFailureHandler(err => {
      container.innerHTML = '<div class="text-danger small">Error al cargar relaciones</div>';
    }).obtenerDatosRelaciones(currentAssetId);
  }

  function renderRelaciones(relaciones, alertas) {
    const container = document.getElementById('relacionesContainer');

    if (!relaciones || relaciones.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="bi bi-diagram-3 fs-1 d-block mb-2"></i>
          <p class="mb-0">Sin relaciones definidas</p>
        </div>
      `;
      return;
    }

    let html = '';

    // Mostrar alertas si existen
    if (alertas && alertas.length > 0) {
      html += '<div class="alert alert-warning mb-3 small">';
      html += '<strong><i class="bi bi-exclamation-triangle"></i> Activos relacionados con problemas:</strong><ul class="mb-0 mt-2 ps-3">';
      alertas.forEach(a => {
        html += `<li><strong>${a.nombreActivo}</strong> (${a.tipoRelacion}): ${a.problema} <span class="badge bg-danger">${a.prioridad}</span></li>`;
      });
      html += '</ul></div>';
    }

    // Lista de relaciones
    html += '<div class="list-group">';

    relaciones.forEach(rel => {
      let iconoRelacion = obtenerIconoRelacion(rel.tipoRelacion);
      let colorBadge = obtenerColorRelacion(rel.tipoRelacion);

      html += `
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center flex-grow-1">
            <div class="me-3 fs-4">${iconoRelacion}</div>
            <div>
              <div class="fw-bold">${rel.nombreActivo}</div>
              <small class="text-muted">${rel.tipoActivo}</small>
              <div><span class="badge ${colorBadge} mt-1">${formatearTipoRelacion(rel.tipoRelacion)}</span></div>
              ${rel.descripcion ? `<small class="text-muted fst-italic d-block mt-1">${rel.descripcion}</small>` : ''}
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" onclick="openAssetDetail('${rel.idActivoRelacionado}')" title="Ver activo">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="eliminarRelacion('${rel.id}')" title="Eliminar relación">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
    refreshSecurityIcons();
  }

  function obtenerIconoRelacion(tipo) {
    const iconos = {
      "DEPENDE_DE": "🔗",
      "ES_REQUERIDO_POR": "🔗",
      "ALIMENTA": "⚡",
      "ES_ALIMENTADO_POR": "⚡",
      "PERTENECE_A": "📦",
      "CONTIENE": "📦",
      "RELACIONADO": "🔄"
    };
    return iconos[tipo] || "🔗";
  }

  function obtenerColorRelacion(tipo) {
    const colores = {
      "DEPENDE_DE": "bg-danger",
      "ES_REQUERIDO_POR": "bg-warning",
      "ALIMENTA": "bg-primary",
      "ES_ALIMENTADO_POR": "bg-info",
      "PERTENECE_A": "bg-secondary",
      "CONTIENE": "bg-success",
      "RELACIONADO": "bg-light text-dark"
    };
    return colores[tipo] || "bg-light text-dark";
  }

  function formatearTipoRelacion(tipo) {
    const nombres = {
      "DEPENDE_DE": "Depende de",
      "ES_REQUERIDO_POR": "Es requerido por",
      "ALIMENTA": "Alimenta a",
      "ES_ALIMENTADO_POR": "Es alimentado por",
      "PERTENECE_A": "Pertenece a",
      "CONTIENE": "Contiene",
      "RELACIONADO": "Relacionado con"
    };
    return nombres[tipo] || tipo;
  }

  function openRelacionModal() {
    if (!currentAssetId) return notificarError("No hay activo seleccionado");

    const modal = new bootstrap.Modal(document.getElementById('relacionModal'));

    // Limpiar formulario
    document.getElementById('relTipoRelacion').value = "DEPENDE_DE";
    document.getElementById('relDescripcion').value = "";
    document.getElementById('relBidireccional').checked = true;
    document.getElementById('relResultados').innerHTML = "";
    document.getElementById('relSearchInput').value = "";
    document.getElementById('relActivoSeleccionado').innerHTML = "";

    modal.show();
  }

  let searchRelTimeout = null;
  function buscarActivosRelacion() {
    const texto = document.getElementById('relSearchInput').value;

    if (searchRelTimeout) clearTimeout(searchRelTimeout);

    if (texto.length < 2) {
      document.getElementById('relResultados').innerHTML = '<small class="text-muted">Escribe al menos 2 caracteres...</small>';
      return;
    }

    searchRelTimeout = setTimeout(() => {
      document.getElementById('relResultados').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

      google.script.run.withSuccessHandler(resultados => {
        renderResultadosBusqueda(resultados);
      }).buscarActivosParaRelacionar(currentAssetId, texto);
    }, 300);
  }

  function renderResultadosBusqueda(resultados) {
    const container = document.getElementById('relResultados');

    if (!resultados || resultados.length === 0) {
      container.innerHTML = '<small class="text-muted">No se encontraron activos</small>';
      return;
    }

    let html = '<div class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">';

    resultados.forEach(a => {
      html += `
        <button type="button" class="list-group-item list-group-item-action" onclick="seleccionarActivoRelacion('${a.id}', '${a.nombre}', '${a.tipo}', '${a.edificio}')">
          <div class="fw-bold">${a.nombre}</div>
          <small class="text-muted">${a.tipo} - ${a.edificio}</small>
        </button>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  let activoSeleccionadoId = null;
  function seleccionarActivoRelacion(id, nombre, tipo, edificio) {
    activoSeleccionadoId = id;

    document.getElementById('relActivoSeleccionado').innerHTML = `
      <div class="alert alert-success mb-0">
        <strong><i class="bi bi-check-circle"></i> Seleccionado:</strong> ${nombre}
        <br><small>${tipo} - ${edificio}</small>
      </div>
    `;

    document.getElementById('relResultados').innerHTML = "";
    document.getElementById('relSearchInput').value = "";
  }

  function submitRelacion() {
    if (!activoSeleccionadoId) return notificarError("Primero selecciona un activo");

    const datos = {
      idActivoA: currentAssetId,
      idActivoB: activoSeleccionadoId,
      tipoRelacion: document.getElementById('relTipoRelacion').value,
      descripcion: document.getElementById('relDescripcion').value,
      bidireccional: document.getElementById('relBidireccional').checked
    };

    const btn = document.getElementById('btnRelSubmit');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    google.script.run.withSuccessHandler(res => {
      btn.disabled = false;
      btn.innerHTML = 'Guardar Relación';

      if (res.success) {
        bootstrap.Modal.getInstance(document.getElementById('relacionModal')).hide();
        notificarExito("Relación creada correctamente");
        loadRelacionesActivo();
      } else {
        notificarError(res.error);
      }
    }).crearRelacionActivo(datos);
  }

  function eliminarRelacion(idRelacion) {
    confirmarAccion("¿Eliminar esta relación?", "No afectará al activo relacionado.", () => {
      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          notificarExito("Relación eliminada");
          loadRelacionesActivo();
        } else {
          notificarError(res.error);
        }
      }).eliminarRelacionActivo(currentAssetId, idRelacion);
    });
  }

  // Función en backend para devolver datos completos
  function obtenerDatosRelaciones(idActivo) {
    return {
      relaciones: getRelacionesActivo(idActivo),
      alertas: getAlertasActivosRelacionados(idActivo)
    };
  }

  // ==========================================
  // 26. LÓGICA DEL PLANIFICADOR
  // ==========================================

  function initPlannerCalendar() {
    const calendarEl = document.getElementById('plannerCalendar');

    // Si ya existe la instancia
    if (plannerCalendar) {
      plannerCalendar.render();
      plannerCalendar.updateSize();

      if (allPlannerEvents.length === 0) loadPlannerEvents();
      return;
    }
    plannerCalendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,listWeek'
      },
      height: 'auto', // Altura automática
      editable: true, // ¡IMPORTANTE: Permite arrastrar!
      droppable: true,
      eventResizableFromStart: false,

      // Al hacer clic en un evento
      eventClick: function (info) {
        const props = info.event.extendedProps;
        // Reutilizamos tus modales existentes
        if (props.tipo === 'MANTENIMIENTO') {
          // Asumimos que hasCalendar es false por defecto para la edición rápida
          editRevision(info.event.id, info.event.title.split('-')[0].trim(), info.event.startStr, null, false);
        } else if (props.tipo === 'INCIDENCIA') {
          editIncidencia(info.event.id);
        } else {
          // Para Obras, podríamos hacer un simple alert o navegar a detalle
          Swal.fire({
            title: info.event.title,
            text: props.descripcion,
            icon: 'info'
          });
        }
      },

      // LÓGICA DRAG & DROP (Reprogramar)
      eventDrop: function (info) {
        const props = info.event.extendedProps;

        // Verificar si es editable
        if (!props.editable) {
          info.revert(); // Devolver a su sitio
          return;
        }

        const nuevaFecha = info.event.startStr; // YYYY-MM-DD
        const tipo = props.tipo;
        const id = info.event.id;

        // Confirmación visual suave
        const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
        });
        Toast.fire({ icon: 'info', title: 'Reprogramando...' });

        // Llamada al servidor
        google.script.run
          .withSuccessHandler(res => {
            if (res.success) {
              Toast.fire({ icon: 'success', title: 'Fecha actualizada' });
              // Actualizamos también el dashboard si es necesario en segundo plano
            } else {
              info.revert(); // Si falla, vuelve atrás
              notificarError(res.error);
            }
          })
          .withFailureHandler(err => {
            info.revert();
            notificarError("Error de red: " + err.message);
          })
          .updateEventDate(id, tipo, nuevaFecha);
      }
    });

    plannerCalendar.render();
    loadPlannerEvents();
  }

  function loadPlannerEvents() {
    if (plannerCalendar) plannerCalendar.removeAllEvents();

    // Feedback de carga
    const header = document.querySelector('#view-planner .page-title');
    const orgTitle = header.innerText;
    header.innerHTML = orgTitle + ' <span class="spinner-border spinner-border-sm text-primary"></span>';

    google.script.run
      .withSuccessHandler(eventos => {
        header.innerText = "Planificador de Trabajo";
        allPlannerEvents = eventos; // Guardar en caché local
        filterPlanner(); // Aplicar filtros y pintar
      })
      .getPlannerEvents();
  }

  function filterPlanner() {
    if (!plannerCalendar) return;

    const showMant = document.getElementById('chkShowMant').checked;
    const showObras = document.getElementById('chkShowObras').checked;
    const showInc = document.getElementById('chkShowInc').checked;

    // Filtramos la caché local
    const filtrados = allPlannerEvents.filter(ev => {
      if (ev.extendedProps.tipo === 'MANTENIMIENTO' && !showMant) return false;
      if (ev.extendedProps.tipo === 'OBRA' && !showObras) return false;
      if (ev.extendedProps.tipo === 'INCIDENCIA' && !showInc) return false;
      return true;
    });

    // Repintar (borrar y añadir)
    plannerCalendar.removeAllEvents();
    plannerCalendar.addEventSource(filtrados);
  }

  // ==========================================
  // 28. LOGICA AUDITORÍA
  // ==========================================

  function loadAuditYears() {
    const sel = document.getElementById('auditYear');
    // Reset UI
    document.getElementById('auditResult').classList.add('d-none');
    setBtnLoading('btnAuditRun', false);
    
    sel.innerHTML = '<option>Cargando...</option>';
    
    google.script.run.withSuccessHandler(anios => {
      if (!anios || anios.length === 0) {
        // Si no hay datos, ponemos el año actual por defecto
        const thisYear = new Date().getFullYear();
        sel.innerHTML = `<option value="${thisYear}">${thisYear}</option>`;
        return;
      }
      
      let html = '';
      anios.forEach(a => {
        html += `<option value="${a}">${a}</option>`;
      });
      sel.innerHTML = html;
    }).getAniosAuditoria();
  }

  function runAudit() {
    const anio = document.getElementById('auditYear').value;
    const tipo = document.getElementById('auditType').value;
    
    if (!anio) return notificarError("Selecciona un año.");
    
    const btn = document.getElementById('btnAuditRun');
    
    // Feedback visual de carga "pesada"
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando archivos...';
    
    // Ocultar resultado anterior
    document.getElementById('auditResult').classList.add('d-none');
    
    // Notificación flotante para que el usuario sepa que tarda
    notificar("Esto puede tardar unos segundos...", "info");

    google.script.run
      .withSuccessHandler(res => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-arrow-up me-2"></i> Generar Paquete';
        
        if (res.success) {
          document.getElementById('auditResult').classList.remove('d-none');
          document.getElementById('auditMsg').innerText = `Se han recopilado ${res.total} documentos en la carpeta "${res.folderName}".`;
          document.getElementById('auditLink').href = res.url;
          notificarExito("Paquete generado correctamente");
        } else {
          notificarError(res.error);
        }
      })
      .withFailureHandler(err => {
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-cloud-arrow-up me-2"></i> Reintentar';
          notificarError("Error crítico: " + err.message);
      })
      .generarPaqueteAuditoria(anio, tipo);
  }

</script>
