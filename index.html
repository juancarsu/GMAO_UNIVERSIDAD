<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <?!= include('css'); ?>
</head>
<body>

<nav class="navbar navbar-dark bg-primary px-3 shadow-sm">
  <div class="d-flex align-items-center">
    <span class="navbar-brand mb-0 h1">GMAO Universidad</span>
  </div>
  <div>
    <button class="btn btn-sm btn-outline-light me-2" onclick="mostrarModalNormativa()"><i class="bi bi-book"></i> Normativa</button>
    <button class="btn btn-sm btn-light" onclick="mostrarModalCrear('CAMPUS')">+ Nuevo Campus</button>
  </div>
</nav>

<div class="d-flex flex-grow-1">
  <div id="sidebar">
    <div class="d-grid mb-3">
       <button class="btn btn-outline-primary btn-sm text-start" onclick="loadDashboard()">
         <i class="bi bi-speedometer2 me-2"></i> Inicio / Dashboard
       </button>
    </div>
    <div class="text-center text-muted mt-5" id="loadingTree">
      <div class="spinner-border spinner-border-sm"></div> Cargando árbol...
    </div>
    <div id="treeContainer"></div>
  </div>

  <div id="main">
    
    <div id="view-dashboard">
      <h4 class="mb-4">Estado del Sistema</h4>
      <div class="row mb-4">
        <div class="col-md-4"><div class="card kpi-card bg-primary text-white p-3"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-0">Total Activos</h6><h2 class="mb-0" id="dashActivos">--</h2></div><i class="bi bi-box-seam kpi-icon"></i></div></div></div>
        <div class="col-md-4"><div class="card kpi-card bg-danger text-white p-3"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-0">Vencidas</h6><h2 class="mb-0" id="dashVencidas">--</h2></div><i class="bi bi-exclamation-octagon kpi-icon"></i></div></div></div>
        <div class="col-md-4"><div class="card kpi-card bg-warning text-dark p-3"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-0">Próximas (30d)</h6><h2 class="mb-0" id="dashPendientes">--</h2></div><i class="bi bi-clock-history kpi-icon"></i></div></div></div>
      </div>
      <div class="row">
        <div class="col-md-6"><div class="card shadow-sm p-3"><h6 class="text-muted">Estado Mantenimiento</h6><div style="height:250px;"><canvas id="maintChart"></canvas></div></div></div>
        <div class="col-md-6"><div class="card shadow-sm p-3"><h6 class="text-muted">Avisos Contratos</h6><div class="d-flex align-items-center justify-content-center h-100" style="min-height:250px;"><div class="text-center"><h1 class="display-1 text-danger fw-bold" id="dashContratos">0</h1><p class="lead">Contratos Caducados</p></div></div></div></div>
      </div>
    </div>

    <div id="view-details" class="d-none">
      <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
        <h4 id="ctxTitle">Elemento</h4><div id="ctxActions"></div>
      </div>
      <ul class="nav nav-tabs mb-3 d-none" id="mainTabs">
        <li class="nav-item"><a class="nav-link active" onclick="switchTab('info', this)">Información</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchTab('docs', this)">Documentación</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchTab('maint', this)">Mantenimiento</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchTab('contracts', this)">Contratos</a></li>
      </ul>
      <div id="tabContent" class="d-none">
        <div id="view-info"><div class="alert alert-light border"><h5>Detalles</h5><p class="text-muted">Propiedades del elemento.</p></div></div>
        <div id="view-docs" class="d-none">
          <div class="card p-3 mb-3 bg-light"><h6>Subir Documento</h6><div class="input-group"><input type="file" class="form-control" id="fileInput"><button class="btn btn-success" onclick="uploadFile()">Subir</button></div><small class="text-muted" id="uploadStatus"></small></div>
          <table class="table table-striped mt-2"><thead><tr><th>Archivo</th><th>Ver.</th><th>Fecha</th><th>Link</th></tr></thead><tbody id="docsTableBody"></tbody></table>
        </div>
        <div id="view-maint" class="d-none">
          <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" onclick="mostrarModalRevision()">+ Revisión Manual</button></div>
          <table class="table table-bordered align-middle"><thead class="table-light"><tr><th style="width:50px;">Estado</th><th>Tipo</th><th>Próxima</th><th>Acción</th></tr></thead><tbody id="maintTableBody"></tbody></table>
          <div class="mt-3 small text-muted"><span class="dot bg-verde"></span> >30 días | <span class="dot bg-amarillo"></span> ≤30 días | <span class="dot bg-rojo"></span> Vencido</div>
        </div>
        <div id="view-contracts" class="d-none">
          <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" onclick="mostrarModalContrato()">+ Contrato</button></div>
          <table class="table table-bordered align-middle"><thead class="table-light"><tr><th>Estado</th><th>Proveedor</th><th>Ref</th><th>Fechas</th></tr></thead><tbody id="contractsTableBody"></tbody></table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle">Nuevo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="createForm"><input type="hidden" id="modalType"><input type="hidden" id="modalParentId"><div class="mb-3"><label>Nombre</label><input type="text" class="form-control" id="fNombre" required></div><div id="extraFields"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="submitCreate()">Guardar</button></div></div></div></div>
<div class="modal fade" id="normativaModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Normativa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><table class="table table-sm table-bordered"><thead><tr><th>Instalación</th><th>Norma</th><th>Días</th></tr></thead><tbody id="tablaNormativaBody"></tbody></table></div></div></div></div>
<div class="modal fade" id="maintModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Programar Revisión</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label>Tipo</label><input type="text" class="form-control" id="revTipo"></div><div class="mb-3"><label>Fecha</label><input type="date" class="form-control" id="revFecha"></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="submitRevision()">Guardar</button></div></div></div></div>
<div class="modal fade" id="contractModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Nuevo Contrato</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label>Proveedor</label><input type="text" class="form-control" id="contProv"></div><div class="mb-3"><label>Ref</label><input type="text" class="form-control" id="contRef"></div><div class="row"><div class="col-6 mb-3"><label>Inicio</label><input type="date" class="form-control" id="contIni"></div><div class="col-6 mb-3"><label>Fin</label><input type="date" class="form-control" id="contFin"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="submitContract()">Guardar</button></div></div></div></div>

<?!= include('js'); ?>

</body>
</html>
