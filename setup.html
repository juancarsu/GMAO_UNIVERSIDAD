<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    #sidebar { width: 280px; background: #f8f9fa; border-right: 1px solid #dee2e6; overflow-y: auto; padding: 10px; }
    #main { flex: 1; padding: 20px; overflow-y: auto; background: #fff; }
    .tree-item { cursor: pointer; padding: 4px 8px; border-radius: 4px; }
    .tree-item:hover { background: #e9ecef; }
    .active-node { background: #0d6efd; color: white; }
    .active-node:hover { background: #0b5ed7; }
    .child-group { margin-left: 18px; display: none; border-left: 1px solid #ccc; }
    .nav-tabs .nav-link { cursor: pointer; }
    /* Semáforos */
    .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .bg-verde { background-color: #198754; } 
    .bg-amarillo { background-color: #ffc107; } 
    .bg-rojo { background-color: #dc3545; }
    .badge-verde { background-color: #d1e7dd; color: #0f5132; }
    .badge-amarillo { background-color: #fff3cd; color: #664d03; }
    .badge-rojo { background-color: #f8d7da; color: #842029; }
    /* Dashboard Cards */
    .kpi-card { border-radius: 10px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .kpi-card:hover { transform: translateY(-5px); }
    .kpi-icon { font-size: 2rem; opacity: 0.8; }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary px-3 shadow-sm">
  <div class="d-flex align-items-center">
    <span class="navbar-brand mb-0 h1">GMAO Universidad</span>
  </div>
  <div>
    <button class="btn btn-sm btn-outline-light me-2" onclick="mostrarModalNormativa()"><i class="bi bi-book"></i> Normativa</button>
    <button class="btn btn-sm btn-light" onclick="mostrarModalCrear('CAMPUS')">+ Nuevo Campus</button>
  </div>
</nav>

<div class="d-flex flex-grow-1">
  <div id="sidebar">
    <div class="d-grid mb-3">
       <button class="btn btn-outline-primary btn-sm text-start" onclick="loadDashboard()">
         <i class="bi bi-speedometer2 me-2"></i> Inicio / Dashboard
       </button>
    </div>
    <div class="text-center text-muted mt-5" id="loadingTree">
      <div class="spinner-border spinner-border-sm"></div> Cargando árbol...
    </div>
    <div id="treeContainer"></div>
  </div>

  <div id="main">
    
    <div id="view-dashboard">
      <h4 class="mb-4">Estado del Sistema</h4>
      <div class="row mb-4">
        <div class="col-md-4"><div class="card kpi-card bg-primary text-white p-3"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-0">Total Activos</h6><h2 class="mb-0" id="dashActivos">--</h2></div><i class="bi bi-box-seam kpi-icon"></i></div></div></div>
        <div class="col-md-4"><div class="card kpi-card bg-danger text-white p-3"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-0">Vencidas</h6><h2 class="mb-0" id="dashVencidas">--</h2></div><i class="bi bi-exclamation-octagon kpi-icon"></i></div></div></div>
        <div class="col-md-4"><div class="card kpi-card bg-warning text-dark p-3"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-0">Próximas (30d)</h6><h2 class="mb-0" id="dashPendientes">--</h2></div><i class="bi bi-clock-history kpi-icon"></i></div></div></div>
      </div>
      <div class="row">
        <div class="col-md-6"><div class="card shadow-sm p-3"><h6 class="text-muted">Estado Mantenimiento</h6><div style="height:250px;"><canvas id="maintChart"></canvas></div></div></div>
        <div class="col-md-6"><div class="card shadow-sm p-3"><h6 class="text-muted">Avisos Contratos</h6><div class="d-flex align-items-center justify-content-center h-100" style="min-height:250px;"><div class="text-center"><h1 class="display-1 text-danger fw-bold" id="dashContratos">0</h1><p class="lead">Contratos Caducados</p></div></div></div></div>
      </div>
    </div>

    <div id="view-details" class="d-none">
      <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
        <h4 id="ctxTitle">Elemento</h4><div id="ctxActions"></div>
      </div>
      <ul class="nav nav-tabs mb-3 d-none" id="mainTabs">
        <li class="nav-item"><a class="nav-link active" onclick="switchTab('info', this)">Información</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchTab('docs', this)">Documentación</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchTab('maint', this)">Mantenimiento</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchTab('contracts', this)">Contratos</a></li>
      </ul>
      <div id="tabContent" class="d-none">
        <div id="view-info"><div class="alert alert-light border"><h5>Detalles</h5><p class="text-muted">Propiedades del elemento.</p></div></div>
        <div id="view-docs" class="d-none">
          <div class="card p-3 mb-3 bg-light"><h6>Subir Documento</h6><div class="input-group"><input type="file" class="form-control" id="fileInput"><button class="btn btn-success" onclick="uploadFile()">Subir</button></div><small class="text-muted" id="uploadStatus"></small></div>
          <table class="table table-striped mt-2"><thead><tr><th>Archivo</th><th>Ver.</th><th>Fecha</th><th>Link</th></tr></thead><tbody id="docsTableBody"></tbody></table>
        </div>
        <div id="view-maint" class="d-none">
          <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" onclick="mostrarModalRevision()">+ Revisión Manual</button></div>
          <table class="table table-bordered align-middle"><thead class="table-light"><tr><th style="width:50px;">Estado</th><th>Tipo</th><th>Próxima</th><th>Acción</th></tr></thead><tbody id="maintTableBody"></tbody></table>
          <div class="mt-3 small text-muted"><span class="dot bg-verde"></span> >30 días | <span class="dot bg-amarillo"></span> ≤30 días | <span class="dot bg-rojo"></span> Vencido</div>
        </div>
        <div id="view-contracts" class="d-none">
          <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" onclick="mostrarModalContrato()">+ Contrato</button></div>
          <table class="table table-bordered align-middle"><thead class="table-light"><tr><th>Estado</th><th>Proveedor</th><th>Ref</th><th>Fechas</th></tr></thead><tbody id="contractsTableBody"></tbody></table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle">Nuevo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="createForm"><input type="hidden" id="modalType"><input type="hidden" id="modalParentId"><div class="mb-3"><label>Nombre</label><input type="text" class="form-control" id="fNombre" required></div><div id="extraFields"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="submitCreate()">Guardar</button></div></div></div></div>
<div class="modal fade" id="normativaModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Normativa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><table class="table table-sm table-bordered"><thead><tr><th>Instalación</th><th>Norma</th><th>Días</th></tr></thead><tbody id="tablaNormativaBody"></tbody></table></div></div></div></div>
<div class="modal fade" id="maintModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Programar Revisión</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label>Tipo</label><input type="text" class="form-control" id="revTipo"></div><div class="mb-3"><label>Fecha</label><input type="date" class="form-control" id="revFecha"></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="submitRevision()">Guardar</button></div></div></div></div>
<div class="modal fade" id="contractModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Nuevo Contrato</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label>Proveedor</label><input type="text" class="form-control" id="contProv"></div><div class="mb-3"><label>Ref</label><input type="text" class="form-control" id="contRef"></div><div class="row"><div class="col-6 mb-3"><label>Inicio</label><input type="date" class="form-control" id="contIni"></div><div class="col-6 mb-3"><label>Fin</label><input type="date" class="form-control" id="contFin"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="submitContract()">Guardar</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let currentContext = null, treeData = [], myChart = null;

  window.onload = function() { loadTree(); loadDashboard(); };

  function loadTree() {
    // LLAMADA ESTÁNDAR AL SERVIDOR - ESTA ES LA LÍNEA QUE FALLABA
    google.script.run.withSuccessHandler(data => { treeData = data; renderTree(data); }).getArbolDatos();
  }

  function loadDashboard() {
    document.getElementById('view-dashboard').classList.remove('d-none');
    document.getElementById('view-details').classList.add('d-none');
    document.querySelectorAll('.tree-item').forEach(d => d.classList.remove('active-node'));
    google.script.run.withSuccessHandler(data => {
      document.getElementById('dashActivos').innerText = data.activos;
      document.getElementById('dashVencidas').innerText = data.vencidas;
      document.getElementById('dashPendientes').innerText = data.pendientes;
      document.getElementById('dashContratos').innerText = data.contratosCaducados;
      const ctx = document.getElementById('maintChart').getContext('2d');
      if(myChart) myChart.destroy();
      myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['En Fecha', 'Próximas', 'Vencidas'], datasets: [{ data: [data.ok, data.pendientes, data.vencidas], backgroundColor: ['#198754', '#ffc107', '#dc3545'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }).getDatosDashboard();
  }

  function renderTree(data) {
    const container = document.getElementById('treeContainer');
    document.getElementById('loadingTree').classList.add('d-none');
    let html = '';
    data.forEach(c => {
      html += createNodeHtml(c, 'CAMPUS');
      if(c.hijos?.length) {
         html += `<div id="grp-${c.id}" class="child-group">`;
         c.hijos.forEach(e => {
            html += createNodeHtml(e, 'EDIFICIO');
            if(e.hijos?.length) {
               html += `<div id="grp-${e.id}" class="child-group">`;
               e.hijos.forEach(a => { html += createNodeHtml(a, 'ACTIVO'); });
               html += `</div>`;
            }
         });
         html += `</div>`;
      }
    });
    container.innerHTML = html;
  }
  function createNodeHtml(item, type) {
    let icon = (type === 'EDIFICIO') ? 'bi-house-door' : (type === 'ACTIVO') ? 'bi-gear' : 'bi-building';
    return `<div class="tree-item" onclick="selectNode('${item.id}', '${type}', '${item.nombre}', this)"><i class="bi ${icon} me-1"></i> ${item.nombre}${(type !== 'ACTIVO') ? `<i class="bi bi-caret-down-fill float-end small text-muted" onclick="toggleGroup('${item.id}', event)"></i>` : ''}</div>`;
  }
  function toggleGroup(id, e) { e.stopPropagation(); const el = document.getElementById('grp-' + id); if(el) el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
  
  function selectNode(id, type, name, el) {
    document.getElementById('view-dashboard').classList.add('d-none');
    document.getElementById('view-details').classList.remove('d-none');
    document.querySelectorAll('.tree-item').forEach(d => d.classList.remove('active-node'));
    el.classList.add('active-node');
    currentContext = { id, type, name };
    document.getElementById('ctxTitle').innerText = `${type}: ${name}`;
    document.getElementById('mainTabs').classList.remove('d-none');
    document.getElementById('tabContent').classList.remove('d-none');
    
    let actions = '';
    if(type === 'CAMPUS') actions = `<button class="btn btn-sm btn-outline-primary" onclick="mostrarModalCrear('EDIFICIO')">+ Edificio</button>`;
    if(type === 'EDIFICIO') actions = `<button class="btn btn-sm btn-outline-primary" onclick="mostrarModalCrear('ACTIVO')">+ Activo</button>`;
    document.getElementById('ctxActions').innerHTML = actions;

    switchTab('info', document.querySelector('.nav-link.active'));
    const tabs = document.querySelectorAll('.nav-link');
    tabs[2].style.display = (type === 'ACTIVO') ? 'block' : 'none';
    tabs[3].style.display = (type === 'ACTIVO' || type === 'EDIFICIO') ? 'block' : 'none';
  }

  function switchTab(tabId, navEl) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    if(navEl) navEl.classList.add('active');
    ['info', 'docs', 'maint', 'contracts'].forEach(t => document.getElementById(`view-${t}`).classList.add('d-none'));
    document.getElementById(`view-${tabId}`).classList.remove('d-none');
    if(tabId === 'docs') loadDocs();
    if(tabId === 'maint' && currentContext.type === 'ACTIVO') loadMaint();
    if(tabId === 'contracts') loadContracts();
  }

  // --- MODALES ---
  const maintModal = new bootstrap.Modal(document.getElementById('maintModal'));
  function mostrarModalRevision() { document.getElementById('revTipo').value=''; document.getElementById('revFecha').value=''; maintModal.show(); }
  function submitRevision() { google.script.run.withSuccessHandler(res => { maintModal.hide(); loadMaint(); }).crearRevision({idActivo: currentContext.id, tipo: document.getElementById('revTipo').value, fechaProx: document.getElementById('revFecha').value}); }
  function loadMaint() {
    const tbody = document.getElementById('maintTableBody'); tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(planes => {
      if(!planes.length) { tbody.innerHTML = '<tr><td colspan="4">Sin revisiones</td></tr>'; return; }
      let html = '';
      planes.forEach(p => {
        const diff = Math.ceil((new Date(p.fechaProxima) - new Date()) / 86400000);
        let c = (diff < 0) ? 'bg-rojo' : (diff <= 30) ? 'bg-amarillo' : 'bg-verde';
        html += `<tr><td class="text-center"><span class="dot ${c}"></span></td><td>${p.tipo}</td><td>${p.fechaProxima}</td><td><button class="btn btn-sm btn-light">Editar</button></td></tr>`;
      });
      tbody.innerHTML = html;
    }).obtenerPlanMantenimiento(currentContext.id);
  }

  const contractModal = new bootstrap.Modal(document.getElementById('contractModal'));
  function mostrarModalContrato() { ['contProv', 'contRef', 'contIni', 'contFin'].forEach(id => document.getElementById(id).value = ''); contractModal.show(); }
  function submitContract() { google.script.run.withSuccessHandler(res => { contractModal.hide(); loadContracts(); }).crearContrato({idEntidad: currentContext.id, tipoEntidad: currentContext.type, proveedor: document.getElementById('contProv').value, ref: document.getElementById('contRef').value, fechaIni: document.getElementById('contIni').value, fechaFin: document.getElementById('contFin').value}); }
  function loadContracts() {
    const tbody = document.getElementById('contractsTableBody'); tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(list => {
      if(!list.length) { tbody.innerHTML = '<tr><td colspan="4">Sin contratos</td></tr>'; return; }
      let html = ''; list.forEach(c => { html += `<tr><td><span class="badge badge-${c.color}">${c.estado}</span></td><td>${c.proveedor}</td><td>${c.ref}</td><td><small>${c.inicio} - ${c.fin}</small></td></tr>`; });
      tbody.innerHTML = html;
    }).obtenerContratos(currentContext.id);
  }

  function uploadFile() {
    const file = document.getElementById('fileInput').files[0];
    if(!file || file.size > 8388608) return alert("Error archivo");
    const btn=document.querySelector('#view-docs button'), st=document.getElementById('uploadStatus');
    btn.disabled=true; st.innerText='Subiendo...';
    const r = new FileReader(); r.onload=function(e){ google.script.run.withSuccessHandler(res=>{ btn.disabled=false; st.innerText='OK'; loadDocs(); }).subirArchivo(e.target.result.split(',')[1], file.name, file.type, currentContext.id, currentContext.type); }; r.readAsDataURL(file);
  }
  function loadDocs() {
    const tbody = document.getElementById('docsTableBody'); tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
    google.script.run.withSuccessHandler(docs => {
      if(!docs.length) { tbody.innerHTML = '<tr><td colspan="4">Sin documentos</td></tr>'; return; }
      let html = ''; docs.forEach(d => { html += `<tr><td>${d.nombre}</td><td>v${d.version}</td><td>${d.fecha}</td><td><a href="${d.url}" target="_blank">Ver</a></td></tr>`; });
      tbody.innerHTML = html;
    }).obtenerDocs(currentContext.id);
  }

  const myModal = new bootstrap.Modal(document.getElementById('createModal'));
  function mostrarModalCrear(type) {
    document.getElementById('createForm').reset(); document.getElementById('modalType').value = type; document.getElementById('modalTitle').innerText = 'Crear ' + type;
    if(currentContext) document.getElementById('modalParentId').value = currentContext.id;
    const ex = document.getElementById('extraFields'); ex.innerHTML = '';
    if(type === 'CAMPUS') ex.innerHTML = `<div class="mb-2"><label>Provincia</label><input id="fProv" class="form-control"></div><div class="mb-2"><label>Dirección</label><input id="fDir" class="form-control"></div>`;
    else if(type === 'EDIFICIO') ex.innerHTML = `<div class="mb-2"><label>Contacto</label><input id="fCont" class="form-control"></div>`;
    else if(type === 'ACTIVO') {
       ex.innerHTML = `<div class="mb-2"><label>Tipo</label><select id="fTipo" class="form-select" disabled><option>Cargando...</option></select></div><div class="mb-2"><label>Marca</label><input id="fMarca" class="form-control"></div>`;
       google.script.run.withSuccessHandler(ts => { let o='<option value="">Sel...</option>'; ts.forEach(t=>{o+=`<option value="${t.id}">${t.nombre}</option>`}); document.getElementById('fTipo').innerHTML=o; document.getElementById('fTipo').disabled=false; }).getCatalogoInstalaciones();
    }
    myModal.show();
  }
  
  function submitCreate() {
    const t=document.getElementById('modalType').value, p=document.getElementById('modalParentId').value, n=document.getElementById('fNombre').value;
    const btn = document.querySelector('#createModal .btn-primary');
    btn.disabled = true; btn.innerText = "Guardando...";
    const handler = (res) => { btn.disabled = false; btn.innerText = "Guardar"; if(res.success) { myModal.hide(); loadTree(); } else { alert("Error: " + res.error); } };

    if(t==='CAMPUS') google.script.run.withSuccessHandler(handler).crearCampus({nombre:n, provincia:document.getElementById('fProv').value, direccion:document.getElementById('fDir').value});
    else if(t==='EDIFICIO') google.script.run.withSuccessHandler(handler).crearEdificio({nombre:n, idCampus:p, contacto:document.getElementById('fCont').value});
    else google.script.run.withSuccessHandler(handler).crearActivo({nombre:n, idEdificio:p, tipo:document.getElementById('fTipo').value, marca:document.getElementById('fMarca').value});
  }

  const normModal = new bootstrap.Modal(document.getElementById('normativaModal'));
  function mostrarModalNormativa() { normModal.show(); google.script.run.withSuccessHandler(l=>{let h='';l.forEach(i=>{h+=`<tr><td>${i.nombre}</td><td>${i.norma}</td><td>${i.dias}</td></tr>`});document.getElementById('tablaNormativaBody').innerHTML=h;}).getCatalogoInstalaciones(); }
</script>
</body>
</html>
